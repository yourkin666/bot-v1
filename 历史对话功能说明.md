# 历史对话存储功能说明

## 功能概述

历史对话存储功能为多模态聊天机器人提供了完整的对话历史管理功能，包括对话会话的创建、保存、加载、搜索和删除等操作。

## 主要特性

### 1. 会话管理

- **自动创建会话**：当用户发送第一条消息时，系统会自动创建新的对话会话
- **手动创建会话**：用户可以点击"新对话"按钮主动创建新会话
- **会话标题**：基于用户的第一条消息自动生成会话标题（可手动修改）
- **会话重命名**：支持对已有会话进行重命名
- **会话删除**：支持删除不需要的会话及其所有消息

### 2. 消息存储

- **完整记录**：保存用户和 AI 的所有对话内容
- **多模态支持**：支持文本和图片消息的存储
- **元数据记录**：记录使用的模型、服务提供商、时间戳等信息
- **内容类型标识**：区分文本消息和多模态消息

### 3. 历史浏览

- **会话列表**：左侧边栏显示所有历史会话
- **会话详情**：显示每个会话的消息数量、最后更新时间、使用的模型
- **消息加载**：点击会话可加载完整的历史消息
- **实时统计**：显示总会话数和总消息数

### 4. 搜索功能

- **全文搜索**：支持在所有会话中搜索关键词
- **实时搜索**：输入关键词后自动搜索，支持防抖
- **结果分组**：搜索结果按会话分组显示
- **快速定位**：点击搜索结果可直接跳转到对应会话

### 5. 数据持久化

- **SQLite 数据库**：使用 SQLite 数据库进行本地存储
- **表结构设计**：
  - `chat_sessions`：存储会话信息
  - `messages`：存储消息内容
- **索引优化**：为常用查询字段建立索引
- **数据完整性**：使用外键约束保证数据一致性

## API 接口

### 会话管理

- `GET /api/sessions` - 获取会话列表
- `POST /api/sessions` - 创建新会话
- `GET /api/sessions/{id}` - 获取会话详情和消息
- `PUT /api/sessions/{id}` - 更新会话信息
- `DELETE /api/sessions/{id}` - 删除会话
- `POST /api/sessions/{id}/archive` - 归档会话

### 消息和搜索

- `POST /api/chat` - 发送消息（现在支持会话 ID 参数）
- `GET /api/search` - 搜索消息

## 使用方法

### 创建新对话

1. 点击顶部的"新对话"按钮
2. 或者在没有当前会话时直接发送消息

### 查看历史对话

1. 点击顶部的"历史"按钮打开侧边栏
2. 在侧边栏中浏览所有历史会话
3. 点击任意会话可加载其历史消息

### 搜索对话

1. 在侧边栏的搜索框中输入关键词
2. 系统会自动显示包含该关键词的会话
3. 点击搜索结果可直接跳转到对应会话

### 管理会话

1. 在会话列表中，每个会话右侧有操作按钮
2. 点击编辑图标可重命名会话
3. 点击删除图标可删除会话（需确认）

### 移动端使用

- 在移动设备上，侧边栏默认隐藏
- 点击左上角的菜单按钮可打开/关闭侧边栏
- 选择会话后侧边栏会自动隐藏

## 数据库结构

### chat_sessions 表

```sql
CREATE TABLE chat_sessions (
    id TEXT PRIMARY KEY,              -- 会话唯一ID (UUID)
    title TEXT NOT NULL,              -- 会话标题
    created_at TIMESTAMP,             -- 创建时间
    updated_at TIMESTAMP,             -- 最后更新时间
    message_count INTEGER DEFAULT 0,  -- 消息数量
    model TEXT,                       -- 使用的模型
    is_archived BOOLEAN DEFAULT FALSE -- 是否归档
)
```

### messages 表

```sql
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT, -- 消息ID
    session_id TEXT NOT NULL,             -- 所属会话ID
    role TEXT NOT NULL,                   -- 消息角色 (user/assistant)
    content TEXT NOT NULL,                -- 消息内容
    content_type TEXT DEFAULT 'text',     -- 内容类型 (text/multimodal)
    image_data TEXT,                      -- 图片数据 (base64)
    model TEXT,                           -- 使用的模型
    provider TEXT,                        -- 服务提供商
    created_at TIMESTAMP,                 -- 创建时间
    FOREIGN KEY (session_id) REFERENCES chat_sessions (id) ON DELETE CASCADE
)
```

## 安装和配置

### 依赖安装

确保已安装以下 Python 包：

```bash
pip install flask flask-cors requests python-dotenv
```

### 数据库初始化

数据库会在首次运行时自动初始化，无需手动操作。

### 文件结构

```
bot-v1/
├── app.py              # 主应用文件
├── database.py         # 数据库模型和服务
├── index.html          # 前端页面
├── chat_history.db     # SQLite数据库文件（自动生成）
└── 其他文件...
```

## 技术特点

### 后端

- **Flask 框架**：轻量级 Web 框架
- **SQLite 数据库**：无需配置的嵌入式数据库
- **RESTful API**：标准化的 API 设计
- **错误处理**：完善的异常处理和日志记录

### 前端

- **响应式设计**：支持桌面端和移动端
- **Tailwind CSS**：现代化的样式框架
- **异步操作**：使用 fetch API 进行异步数据交互
- **用户体验**：加载状态、确认提示、搜索防抖等

### 数据存储

- **本地存储**：数据保存在本地，保护隐私
- **高效查询**：优化的索引设计
- **数据完整性**：外键约束确保数据一致性
- **易于备份**：单文件数据库，便于备份和迁移

## 注意事项

1. **数据备份**：建议定期备份`chat_history.db`文件
2. **存储空间**：图片数据以 base64 格式存储，会占用较多空间
3. **性能考虑**：大量历史数据可能影响查询性能，建议定期清理或归档
4. **隐私保护**：所有数据本地存储，不会上传到云端

## 后续优化方向

1. **数据导出**：支持导出对话历史为 JSON、PDF 等格式
2. **数据导入**：支持从其他格式导入历史数据
3. **高级搜索**：支持按时间、模型、内容类型等条件过滤
4. **标签系统**：为会话添加标签功能
5. **统计分析**：提供更详细的使用统计和分析
6. **云端同步**：可选的云端备份和同步功能
