<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多模态智能助手 - SiliconFlow & Groq</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>

    <!-- Markdown渲染相关 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-shell.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">

    <!-- 数学公式支持 -->
    <script>
        // 优化的MathJax配置 - 平衡功能性和可靠性
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: { '[+]': ['base', 'ams', 'newcommand', 'configmacros', 'action', 'unicode'] },
                macros: {
                    // 常用数学集合
                    RR: "{\\mathbb{R}}",
                    CC: "{\\mathbb{C}}",
                    NN: "{\\mathbb{N}}",
                    ZZ: "{\\mathbb{Z}}",
                    QQ: "{\\mathbb{Q}}",
                    // 常用函数
                    d: "{\\mathrm{d}}",
                    e: "{\\mathrm{e}}",
                    i: "{\\mathrm{i}}",
                    // 向量和范数
                    vec: ["\\mathbf{#1}", 1],
                    norm: ["\\left\\|#1\\right\\|", 1],
                    abs: ["\\left|#1\\right|", 1],
                    // 取整函数
                    floor: ["\\left\\lfloor#1\\right\\rfloor", 1],
                    ceil: ["\\left\\lceil#1\\right\\rceil", 1],
                    // 微分算子
                    diff: ["\\frac{\\mathrm{d}#1}{\\mathrm{d}#2}", 2],
                    pdiff: ["\\frac{\\partial#1}{\\partial#2}", 2]
                }
            },
            chtml: {
                scale: 1.1,
                minScale: 0.5,
                mtextInheritFont: true,
                displayAlign: 'center',
                displayIndent: '0em'
            },
            options: {
                processHtmlClass: 'markdown-content',
                ignoreHtmlClass: 'tex2jax_ignore',
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml']
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax配置完成，支持高级数学渲染');
                }
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary-color, #1E88E5)',
                        secondary: 'var(--secondary-color, #E3F2FD)',
                        accent: 'var(--accent-color, #42A5F5)',
                        'bg-primary': 'var(--bg-primary, #ffffff)',
                        'bg-secondary': 'var(--bg-secondary, #f8fafc)',
                        'text-primary': 'var(--text-primary, #1f2937)',
                        'text-secondary': 'var(--text-secondary, #6b7280)',
                        'border-primary': 'var(--border-primary, #e5e7eb)',
                        'user-bubble': 'var(--user-bubble-color, #E8E8E8)',
                        'bot-bubble': 'var(--bot-bubble-color, #E3F2FD)'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: 'var(--bubble-radius, 8px)',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': 'var(--button-radius, 8px)',
                        'bubble': 'var(--bubble-radius, 18px)'
                    },
                    fontSize: {
                        'chat': 'var(--chat-font-size, 1rem)'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>

    <style>
        /* CSS变量定义 - 支持主题切换和个性化设置 */
        :root {
            /* 浅色主题 */
            --primary-color: #1E88E5;
            --secondary-color: #E3F2FD;
            --accent-color: #42A5F5;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-primary: #e5e7eb;
            --user-bubble-color: #E8E8E8;
            --bot-bubble-color: #E3F2FD;

            /* 个性化设置 */
            --chat-font-size: 1rem;
            --bubble-radius: 18px;
            --button-radius: 8px;
        }

        /* 暗黑主题 */
        [data-theme="dark"] {
            --primary-color: #3B82F6;
            --secondary-color: #1E293B;
            --accent-color: #60A5FA;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-primary: #334155;
            --user-bubble-color: #374151;
            --bot-bubble-color: #1e293b;
        }

        /* 自定义主题颜色 */
        [data-theme="purple"] {
            --primary-color: #8B5CF6;
            --secondary-color: #F3E8FF;
            --accent-color: #A78BFA;
            --bot-bubble-color: #F3E8FF;
        }

        [data-theme="green"] {
            --primary-color: #10B981;
            --secondary-color: #D1FAE5;
            --accent-color: #34D399;
            --bot-bubble-color: #D1FAE5;
        }

        [data-theme="orange"] {
            --primary-color: #F59E0B;
            --secondary-color: #FEF3C7;
            --accent-color: #FBBF24;
            --bot-bubble-color: #FEF3C7;
        }

        /* 基础样式 */
        body {
            font-size: var(--chat-font-size);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
            font-size: var(--chat-font-size);
            transition: all 0.3s ease;
        }

        .user-message {
            background-color: var(--user-bubble-color);
            border-radius: var(--bubble-radius) var(--bubble-radius) 0 var(--bubble-radius);
            color: var(--text-primary);
        }

        .bot-message {
            background-color: var(--bot-bubble-color);
            border-radius: var(--bubble-radius) var(--bubble-radius) var(--bubble-radius) 0;
            color: var(--text-primary);
        }

        /* ===== 消息类型专用样式系统 ===== */

        /* 基础消息类型样式 */
        .message-type-text {
            /* 纯文本消息保持默认样式 */
        }

        .message-type-image {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #10b981;
            position: relative;
            overflow: hidden;
        }

        .message-type-image::before {
            content: '🖼️';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.6;
            z-index: 1;
        }

        .message-type-audio {
            background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 20%, #fbbf24 100%);
            border-left: 4px solid #f59e0b;
            position: relative;
            color: #92400e;
        }

        .message-type-audio::before {
            content: '🎵';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        .message-type-video {
            background: linear-gradient(135deg, #ddd6fe 0%, #8b5cf6 20%, #a78bfa 100%);
            border-left: 4px solid #8b5cf6;
            position: relative;
            color: #5b21b6;
        }

        .message-type-video::before {
            content: '🎬';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        .message-type-mixed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
            border-left: 4px solid #6366f1;
            position: relative;
        }

        .message-type-mixed::before {
            content: '📎';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        /* Bot消息的特殊样式 */
        .bot-message.message-type-text {
            background: var(--bot-bubble-color);
        }

        .bot-message.message-type-analysis {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid #10b981;
            position: relative;
        }

        .bot-message.message-type-analysis::before {
            content: '🤖';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        .bot-message.message-type-search {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #3b82f6;
            position: relative;
        }

        .bot-message.message-type-search::before {
            content: '🔍';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        /* 媒体内容容器样式 */
        .media-container {
            margin-top: 8px;
            border-radius: calc(var(--bubble-radius) - 4px);
            overflow: hidden;
            position: relative;
        }

        .image-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: calc(var(--bubble-radius) - 4px);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .image-container:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            transition: opacity 0.3s ease;
        }

        .audio-container {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: calc(var(--bubble-radius) - 4px);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .audio-icon {
            width: 40px;
            height: 40px;
            background: #f59e0b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .audio-info {
            flex: 1;
            min-width: 0;
        }

        .audio-title {
            font-weight: 600;
            color: #92400e;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .audio-controls {
            width: 100%;
            margin-top: 8px;
        }

        .video-container {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            border: 2px solid #8b5cf6;
            border-radius: calc(var(--bubble-radius) - 4px);
            overflow: hidden;
            position: relative;
        }

        .video-header {
            background: rgba(139, 92, 246, 0.1);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .video-icon {
            width: 24px;
            height: 24px;
            background: #8b5cf6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .video-title {
            font-weight: 600;
            color: #5b21b6;
            font-size: 14px;
        }

        .video-controls {
            width: 100%;
            border-radius: 0;
        }

        /* 消息类型指示器 */
        .message-type-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .type-indicator-text {
            background: rgba(107, 114, 128, 0.1);
            color: #374151;
        }

        .type-indicator-image {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
        }

        .type-indicator-audio {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
        }

        .type-indicator-video {
            background: rgba(139, 92, 246, 0.1);
            color: #5b21b6;
        }

        .type-indicator-mixed {
            background: rgba(99, 102, 241, 0.1);
            color: #3730a3;
        }

        /* 暗黑主题适配 */
        [data-theme="dark"] .message-type-image {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-left-color: #10b981;
        }

        [data-theme="dark"] .message-type-audio {
            background: linear-gradient(135deg, #422006 0%, #78350f 20%, #92400e 100%);
            color: #fbbf24;
        }

        [data-theme="dark"] .message-type-video {
            background: linear-gradient(135deg, #2e1065 0%, #5b21b6 20%, #7c3aed 100%);
            color: #c4b5fd;
        }

        [data-theme="dark"] .message-type-mixed {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #3730a3 100%);
            color: #c7d2fe;
        }

        [data-theme="dark"] .bot-message.message-type-analysis {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            color: #a7f3d0;
        }

        [data-theme="dark"] .bot-message.message-type-search {
            background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
            color: #bfdbfe;
        }

        [data-theme="dark"] .image-container {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .audio-container {
            background: linear-gradient(135deg, #422006 0%, #78350f 100%);
            border-color: #f59e0b;
        }

        [data-theme="dark"] .video-container {
            background: linear-gradient(135deg, #2e1065 0%, #5b21b6 100%);
            border-color: #8b5cf6;
        }

        /* 响应式优化 */
        @media (max-width: 768px) {

            .message-type-image::before,
            .message-type-audio::before,
            .message-type-video::before,
            .message-type-mixed::before {
                font-size: 12px;
                top: 6px;
                right: 6px;
            }

            .media-container {
                margin-top: 6px;
            }

            .audio-container,
            .video-header {
                padding: 8px;
            }

            .audio-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }

        /* 动画效果 */
        .message-bubble {
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 消息内容分组样式 */
        .message-content-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .text-content {
            order: 1;
        }

        .media-content {
            order: 2;
        }

        /* 搜索结果特殊样式 */
        .search-results {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-result-item {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            padding: 8px 12px;
            border-left: 3px solid var(--primary-color);
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .search-result-url {
            color: var(--primary-color);
            font-size: 12px;
            text-decoration: none;
            display: block;
            margin-bottom: 4px;
        }

        .search-result-url:hover {
            text-decoration: underline;
        }

        .search-result-snippet {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
        }

        /* 搜索指示器样式 */
        .search-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        /* 模型指示器样式 */
        .model-indicator {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            opacity: 0.7;
        }

        /* 特殊样式增强 */
        .message-type-search .search-indicator {
            color: #1d4ed8;
        }

        .message-type-analysis .model-indicator {
            color: #059669;
        }

        /* 暗黑主题下的搜索结果 */
        [data-theme="dark"] .search-result-item {
            background: rgba(0, 0, 0, 0.3);
            border-left-color: var(--primary-color);
        }

        [data-theme="dark"] .search-result-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .search-result-snippet {
            color: var(--text-secondary);
        }

        /* ===== 开启新对话按钮专用样式 ===== */
        .new-chat-button-container {
            display: flex;
            justify-content: center;
            padding: 16px 0 12px 0;
            border-bottom: 1px solid var(--border-primary);
            margin-bottom: 16px;
        }

        .new-chat-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Microsoft YaHei', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 160px;
            justify-content: center;
        }

        .new-chat-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .new-chat-button:hover::before {
            left: 100%;
        }

        .new-chat-button:hover {
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .new-chat-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .new-chat-button-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .new-chat-button-text {
            color: white;
            font-weight: 500;
            white-space: nowrap;
        }

        /* 对话气泡图标 */
        .chat-bubble-icon {
            position: relative;
            width: 18px;
            height: 18px;
        }

        .chat-bubble-icon::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 8px;
            background: currentColor;
            border-radius: 6px 6px 6px 1px;
            top: 2px;
            left: 2px;
        }

        .chat-bubble-icon::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 6px;
            background: currentColor;
            border-radius: 4px 4px 1px 4px;
            top: 6px;
            right: 2px;
            opacity: 0.8;
        }

        /* 暗黑主题适配 */
        [data-theme="dark"] .new-chat-button-container {
            border-bottom-color: var(--border-primary);
        }

        [data-theme="dark"] .new-chat-button {
            background: linear-gradient(135deg, #1E40AF 0%, #1E3A8A 100%);
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.4);
        }

        [data-theme="dark"] .new-chat-button:hover {
            background: linear-gradient(135deg, #1D4ED8 0%, #1E3A8A 100%);
            box-shadow: 0 4px 16px rgba(30, 64, 175, 0.5);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .new-chat-button-container {
                padding: 12px 0 8px 0;
                margin-bottom: 12px;
            }

            .new-chat-button {
                padding: 10px 20px;
                font-size: 14px;
                min-width: 140px;
            }

            .new-chat-button-icon {
                width: 16px;
                height: 16px;
            }
        }

        /* 高对比度支持 */
        @media (prefers-contrast: high) {
            .new-chat-button {
                border: 2px solid #1E40AF;
                background: #3B82F6;
            }

            .new-chat-button:hover {
                border-color: #1D4ED8;
                background: #2563EB;
            }
        }

        /* 减少动画偏好支持 */
        @media (prefers-reduced-motion: reduce) {
            .new-chat-button {
                transition: none;
            }

            .new-chat-button::before {
                display: none;
            }

            .new-chat-button:hover {
                transform: none;
            }
        }

        /* ===== 统一附件按钮样式增强 ===== */

        /* 为回形针图标提供更好的悬停效果 */
        #uploadAttachmentBtn:hover {
            background-color: var(--hover-bg, rgba(59, 130, 246, 0.1));
            color: var(--primary-color, #3B82F6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* 暗黑主题下的附件按钮 */
        [data-theme="dark"] #uploadAttachmentBtn {
            color: var(--text-secondary);
        }

        [data-theme="dark"] #uploadAttachmentBtn:hover {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--primary-color);
        }

        /* 按钮组的间距优化 */
        .flex.space-x-2 {
            gap: 8px;
        }

        /* 为附件上传增加loading状态样式 */
        #uploadAttachmentBtn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #uploadAttachmentBtn[disabled]:hover {
            background-color: transparent;
            color: var(--text-muted);
            box-shadow: none;
        }

        /* ===== 底部提示信息样式 ===== */
        .input-hints {
            padding: 0 4px;
            margin-top: 8px;
            padding-top: 8px;
        }

        .input-hints span {
            color: var(--text-secondary);
            font-size: 11px;
            user-select: none;
            white-space: nowrap;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .input-hints:hover span {
            opacity: 0.9;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .input-hints {
                margin-top: 6px;
                padding-top: 6px;
            }

            .input-hints span {
                font-size: 10px;
            }
        }

        /* 暗黑主题适配 */
        [data-theme="dark"] .input-hints span {
            color: var(--text-secondary);
        }



        /* 响应式设计改进 */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 90%;
                font-size: max(14px, var(--chat-font-size));
            }

            /* 移动端触摸优化 */
            button,
            .button {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }

            /* 移动端快捷操作栏 */
            .mobile-quick-actions {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 40;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .mobile-quick-btn {
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: var(--primary-color);
                color: white;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                border: none;
                cursor: pointer;
            }

            .mobile-quick-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            }
        }

        /* 快捷操作栏样式 */
        .quick-actions-bar {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .quick-actions-bar:hover {
            opacity: 1;
        }

        .quick-action-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--button-radius);
            background: var(--bg-primary);
            border: 2px solid var(--border-primary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        /* 设置面板样式 */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-primary);
            z-index: 50;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-primary);
        }

        .settings-section h3 {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .theme-option {
            padding: 12px;
            border: 2px solid var(--border-primary);
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
        }

        .theme-option.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .theme-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid currentColor;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-picker:hover {
            transform: scale(1.05);
        }

        .range-input {
            width: 100%;
            margin: 8px 0;
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-primary);
            border-radius: var(--button-radius);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .export-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 现有样式继续保持 */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            opacity: 0.6;
        }

        .typing-indicator span:nth-child(1) {
            animation: bounce 1s infinite 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation: bounce 1s infinite 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation: bounce 1s infinite 0.4s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* ===== 全新的骨架屏和加载动画系统 ===== */

        /* 骨架屏基础样式 */
        .skeleton {
            background: linear-gradient(90deg, #f0f2f5 25%, #e6e9ed 50%, #f0f2f5 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* 暗黑主题下的骨架屏 */
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #333333 50%, #2a2a2a 75%);
            background-size: 200% 100%;
        }

        /* 消息骨架屏容器 */
        .message-skeleton {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: var(--bot-bubble-color);
            border-radius: var(--bubble-radius);
            max-width: 80%;
            margin-bottom: 16px;
            animation: skeleton-fade-in 0.3s ease-out;
        }

        @keyframes skeleton-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 骨架屏行 */
        .skeleton-line {
            height: 16px;
            border-radius: 8px;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.medium {
            width: 80%;
        }

        .skeleton-line.long {
            width: 100%;
        }

        .skeleton-line.extra-short {
            width: 40%;
        }

        /* 骨架屏头部 */
        .skeleton-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .skeleton-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .skeleton-title {
            height: 14px;
            width: 120px;
            border-radius: 7px;
        }

        /* 现代加载指示器 */
        .modern-loading-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bot-bubble-color);
            border-radius: var(--bubble-radius);
            max-width: 80%;
            margin-bottom: 16px;
            animation: loading-fade-in 0.3s ease-out;
            border: 1px solid var(--border-primary);
        }

        @keyframes loading-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 加载图标容器 */
        .loading-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: loading-pulse 2s infinite;
        }

        @keyframes loading-pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        /* 加载文本动画 */
        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }

        .loading-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.8) 50%, transparent 100%);
            animation: loading-text-shimmer 2s infinite;
        }

        @keyframes loading-text-shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* 波浪加载动画 */
        .wave-loading {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .wave-loading .wave-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: wave-bounce 1.4s infinite ease-in-out;
        }

        .wave-loading .wave-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .wave-loading .wave-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .wave-loading .wave-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes wave-bounce {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* 旋转加载动画 */
        .spinner-loading {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spinner-rotate 1s linear infinite;
        }

        @keyframes spinner-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 搜索状态特殊样式 */
        .search-loading {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid var(--primary-color);
        }

        .search-loading .loading-icon {
            background: linear-gradient(45deg, #1e88e5, #9c27b0);
            animation: search-icon-rotate 2s linear infinite;
        }

        @keyframes search-icon-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 图像处理加载样式 */
        .image-processing-loading {
            background: linear-gradient(135deg, #fff3e0 0%, #e8f5e8 100%);
            border-left: 4px solid #ff9800;
        }

        .image-processing-loading .loading-icon {
            background: linear-gradient(45deg, #ff9800, #4caf50);
        }

        /* 加载状态过渡效果 */
        .loading-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-exit {
            animation: loading-exit-animation 0.3s ease-in-out forwards;
        }

        @keyframes loading-exit-animation {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            50% {
                opacity: 0.5;
                transform: translateY(-5px) scale(0.98);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
        }

        /* 响应式设计 */
        @media (max-width: 768px) {

            .message-skeleton,
            .modern-loading-indicator {
                max-width: 90%;
            }

            .skeleton-line {
                height: 14px;
            }

            .loading-icon {
                width: 20px;
                height: 20px;
            }
        }

        /* 高对比度支持 */
        @media (prefers-contrast: high) {
            .skeleton {
                background: linear-gradient(90deg, #d0d0d0 25%, #a0a0a0 50%, #d0d0d0 75%);
            }

            .modern-loading-indicator {
                border: 2px solid var(--text-primary);
            }
        }

        /* 减少动画偏好支持 */
        @media (prefers-reduced-motion: reduce) {

            .skeleton,
            .loading-icon,
            .wave-loading .wave-dot,
            .spinner-loading {
                animation: none;
            }

            .skeleton {
                background: #f0f2f5;
            }

            [data-theme="dark"] .skeleton {
                background: #2a2a2a;
            }
        }

        /* 全局loading状态样式 */
        body.loading-active {
            cursor: wait;
        }

        body.loading-active * {
            pointer-events: none;
        }

        body.loading-active .loading-allowed {
            pointer-events: auto;
        }

        /* Toast通知样式增强 */
        .toast-enter {
            transform: translateX(100%);
            opacity: 0;
        }

        .toast-enter-active {
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }

        .toast-exit {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-exit-active {
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease-in;
        }

        /* 会话骨架屏样式 */
        .session-skeleton:hover {
            background-color: transparent !important;
        }

        .session-skeleton .skeleton {
            pointer-events: none;
        }

        /* 增强的加载按钮状态 */
        .loading-button {
            position: relative;
            overflow: hidden;
        }

        .loading-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: button-loading-shimmer 1.5s infinite;
        }

        @keyframes button-loading-shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* 智能加载状态切换 */
        .smart-loading-container {
            position: relative;
            min-height: 60px;
        }

        .smart-loading-content {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .smart-loading-container.loading .smart-loading-content {
            opacity: 0.6;
        }

        /* 高级骨架屏动画 */
        .skeleton-advanced {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.4) 20%,
                    rgba(255, 255, 255, 0.5) 60%,
                    rgba(255, 255, 255, 0) 100%);
            background-size: 200px 100%;
            background-repeat: no-repeat;
            animation: skeleton-advanced-loading 2s infinite;
        }

        @keyframes skeleton-advanced-loading {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        /* 暗黑主题骨架屏增强 */
        [data-theme="dark"] .skeleton-advanced {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.1) 20%,
                    rgba(255, 255, 255, 0.2) 60%,
                    rgba(255, 255, 255, 0) 100%);
        }

        /* 打字机效果样式 */
        .typewriter-text {
            display: inline;
        }

        .typewriter-cursor {
            display: inline-block;
            background-color: var(--primary-color);
            margin-left: 2px;
            width: 2px;
            height: 1.2em;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .input-area {
            border-top: 1px solid #E5E7EB;
        }

        .message-input {
            resize: none;
            min-height: 24px;
            max-height: 120px;
            overflow-y: auto;
        }

        .message-input::-webkit-scrollbar {
            width: 4px;
        }

        .message-input::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .message-input::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }

        .audio-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        .audio-wave span {
            display: inline-block;
            width: 3px;
            height: 100%;
            margin: 0 2px;
            background-color: #1E88E5;
            border-radius: 3px;
            animation: wave 1s infinite ease-in-out;
        }

        .audio-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .audio-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .audio-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .audio-wave span:nth-child(5) {
            animation-delay: 0.4s;
        }

        /* 优化的数学公式样式 */
        .markdown-content mjx-container {
            margin: 0.3em 0;
            line-height: 1.4;
        }

        /* 行内数学公式样式 */
        .markdown-content mjx-container[display="inline"] {
            display: inline-block;
            vertical-align: middle;
            margin: 0 0.15em;
            padding: 0.1em 0.2em;
            background-color: rgba(240, 248, 255, 0.8);
            border-radius: 3px;
            border: 1px solid rgba(173, 216, 230, 0.3);
        }

        /* 块级数学公式样式 */
        .markdown-content mjx-container[display="block"] {
            display: block;
            margin: 1.2em auto;
            padding: 1em;
            text-align: center;
            max-width: 100%;
            overflow-x: auto;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }

        /* 数学公式字体优化 */
        .markdown-content mjx-container[jax="CHTML"] {
            font-size: 1.05em;
            font-family: 'Times New Roman', 'STIX Two Math', serif;
        }

        /* 数学公式悬停效果 */
        .markdown-content mjx-container[display="block"]:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        /* 数学公式错误样式 */
        .math-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.1);
        }

        /* 长公式横向滚动优化 */
        .markdown-content mjx-container[display="block"] mjx-math {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* 移动设备优化 */
        @media (max-width: 768px) {
            .markdown-content mjx-container[display="block"] {
                font-size: 0.95em;
                margin: 1em 0;
                padding: 0.8em;
            }

            .markdown-content mjx-container[display="inline"] {
                font-size: 0.9em;
                margin: 0 0.1em;
                padding: 0.05em 0.1em;
            }
        }

        /* 高分辨率屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {
            .markdown-content mjx-container[jax="CHTML"] {
                font-size: 1.1em;
            }
        }

        @keyframes wave {

            0%,
            100% {
                height: 15px;
            }

            50% {
                height: 30px;
            }
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
        }

        /* Markdown 渲染样式 */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            margin-top: 1rem;
        }

        .markdown-content h1 {
            font-size: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        .markdown-content h2 {
            font-size: 1.375rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }

        .markdown-content h3 {
            font-size: 1.25rem;
        }

        .markdown-content h4 {
            font-size: 1.125rem;
        }

        .markdown-content p {
            margin-bottom: 1rem;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .markdown-content ul {
            list-style-type: disc;
        }

        .markdown-content ol {
            list-style-type: decimal;
        }

        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6b7280;
        }

        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
        }

        .markdown-content pre {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #e9ecef;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .markdown-content table th {
            background-color: #f9fafb;
            font-weight: bold;
        }

        .markdown-content table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .markdown-content a {
            color: #1e88e5;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #1565c0;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1.5rem 0;
        }

        /* 代码高亮样式增强 */
        .markdown-content .token.comment,
        .markdown-content .token.prolog,
        .markdown-content .token.doctype,
        .markdown-content .token.cdata {
            color: #708090;
        }

        .markdown-content .token.punctuation {
            color: #999;
        }

        .markdown-content .token.property,
        .markdown-content .token.tag,
        .markdown-content .token.boolean,
        .markdown-content .token.number,
        .markdown-content .token.constant,
        .markdown-content .token.symbol,
        .markdown-content .token.deleted {
            color: #905;
        }

        .markdown-content .token.selector,
        .markdown-content .token.attr-name,
        .markdown-content .token.string,
        .markdown-content .token.char,
        .markdown-content .token.builtin,
        .markdown-content .token.inserted {
            color: #690;
        }

        .markdown-content .token.operator,
        .markdown-content .token.entity,
        .markdown-content .token.url,
        .markdown-content .language-css .token.string,
        .markdown-content .style .token.string {
            color: #9a6e3a;
        }

        .markdown-content .token.atrule,
        .markdown-content .token.attr-value,
        .markdown-content .token.keyword {
            color: #07a;
        }

        .markdown-content .token.function,
        .markdown-content .token.class-name {
            color: #dd4a68;
        }

        /* 数学公式样式优化 */
        .markdown-content .MathJax {
            font-size: 1.15em !important;
            outline: none;
            color: #2d3748 !important;
        }

        .markdown-content .MathJax_Display {
            margin: 1.5rem 0 !important;
            text-align: center;
            overflow-x: auto;
            overflow-y: visible;
            padding: 0.5rem 0;
        }

        .markdown-content .MathJax_Preview {
            color: #888;
            font-style: italic;
            background-color: #f7fafc;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* SVG渲染的数学公式样式 */
        .markdown-content mjx-container {
            display: inline-block;
            margin: 0.3em 0.1em;
            color: #2d3748 !important;
        }

        .markdown-content mjx-container[display="block"] {
            display: block;
            text-align: center;
            margin: 1.5em 0;
            overflow-x: auto;
            overflow-y: visible;
            padding: 0.8em 0;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .markdown-content mjx-math {
            line-height: 1.3;
            font-size: 1.1em !important;
        }

        /* 处理长公式的滚动 */
        .markdown-content mjx-container[display="block"] mjx-math {
            min-width: min-content;
            padding: 0 1em;
        }

        /* 行内数学公式的基线对齐 */
        .markdown-content mjx-container:not([display="block"]) {
            vertical-align: baseline;
            background-color: #f7fafc;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }

        /* 数学公式的错误显示 */
        .markdown-content .MathJax_Error {
            color: #e53e3e !important;
            background-color: #fed7d7 !important;
            border: 1px solid #feb2b2;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        /* 数学公式显示容器 */
        .markdown-content .math-display-container {
            text-align: center;
            margin: 1.5em 0;
            padding: 1em;
            overflow-x: auto;
            overflow-y: visible;
            border-radius: 10px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* 数学公式错误提示 */
        .markdown-content .math-error {
            display: inline-block;
            color: #e53e3e;
            background-color: #fed7d7;
            border: 1px solid #feb2b2;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            margin: 4px;
            font-weight: 500;
        }

        /* 响应式数学公式 */
        @media (max-width: 768px) {
            .markdown-content .math-display-container {
                font-size: 0.95em;
                padding: 0.8em;
                margin: 1.2em 0;
            }

            .markdown-content mjx-container {
                font-size: 0.95em !important;
            }

            .markdown-content mjx-container[display="block"] {
                padding: 0.6em 0;
            }

            .markdown-content mjx-container[display="block"] mjx-math {
                padding: 0 0.5em;
            }
        }



        .search-controls-inline {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.05);
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-controls-inline:hover {
            background: rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 0, 0, 0.15);
        }

        .search-label-inline {
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }

        /* 开关样式 */
        .switch,
        .switch-inline {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input,
        .switch-inline input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider,
        .slider-inline {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before,
        .slider-inline:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider,
        input:checked+.slider-inline {
            background-color: #1E88E5;
        }

        input:checked+.slider:before,
        input:checked+.slider-inline:before {
            transform: translateX(20px);
        }

        /* 搜索结果样式 */
        .search-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(30, 136, 229, 0.1);
            border-radius: 8px;
            font-weight: 500;
            color: #1E88E5;
        }

        .search-results {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
        }

        .search-result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .search-result-title {
            font-weight: 600;
            color: #1565C0;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .search-result-url {
            color: #4CAF50;
            text-decoration: none;
            font-size: 14px;
            display: block;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .search-result-url:hover {
            text-decoration: underline;
        }

        .search-result-snippet {
            color: #666;
            line-height: 1.4;
            font-size: 14px;
        }

        .model-indicator {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>

<body class="bg-bg-secondary h-screen flex flex-col transition-all duration-300">
    <!-- 头部导航 -->
    <header class="bg-bg-primary shadow-sm py-3 px-4 flex items-center justify-between border-b border-border-primary">
        <div class="flex items-center">
            <button id="toggleSidebar"
                class="lg:hidden mr-3 w-8 h-8 rounded flex items-center justify-center text-text-secondary hover:bg-bg-secondary transition-colors">
                <i class="ri-menu-line"></i>
            </button>
            <span class="text-xl font-['Pacifico'] text-primary">logo</span>
            <h1 class="ml-2 text-lg font-medium text-text-primary">多模态智能助手</h1>
        </div>
        <div class="flex items-center space-x-3">
            <!-- 快速设置区域 -->
            <div class="flex items-center space-x-2">
                <!-- Temperature快速调节 -->
                <div class="flex items-center bg-bg-secondary rounded-lg px-2 py-1">
                    <span class="text-xs text-text-secondary mr-1">创造性:</span>
                    <span id="headerTemperatureValue" class="text-xs font-semibold text-primary min-w-[24px]">0.7</span>
                    <button id="headerTemperatureBtn" class="ml-1 text-text-secondary hover:text-text-primary">
                        <i class="ri-settings-4-line text-sm"></i>
                    </button>
                </div>

                <!-- System Prompt状态指示 -->
                <div class="flex items-center">
                    <button id="headerSystemPromptBtn"
                        class="flex items-center bg-bg-secondary hover:bg-border-primary rounded-lg px-2 py-1 transition-colors">
                        <i id="systemPromptIcon" class="ri-chat-settings-line text-sm text-text-secondary mr-1"></i>
                        <span id="systemPromptStatus" class="text-xs text-text-secondary">系统提示</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- System Prompt 设置弹窗 -->
    <div id="systemPromptModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="ri-chat-settings-line mr-2"></i>系统提示设置
                </h3>
                <button id="closeSystemPromptBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">系统提示内容</label>
                <textarea id="systemPromptInput"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                    rows="4" placeholder="输入系统提示，例如：你是一个专业的技术助手，请用简洁明了的语言回答问题..."></textarea>
                <p class="text-xs text-gray-500 mt-1">系统提示将影响AI的回答风格和行为，留空则不设置系统提示</p>
            </div>

            <!-- 预设模板 -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">快速模板</label>
                <div class="grid grid-cols-2 gap-2">
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="你是一个专业的技术助手，请用简洁明了的语言回答编程和技术相关问题。">
                        💻 技术助手
                    </button>
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="你是一个创意写作助手，擅长创作故事、诗歌和文案，请用富有想象力的语言回答。">
                        ✍️ 创意写作
                    </button>
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="你是一个学习助手，请用通俗易懂的语言解释复杂概念，多举例说明。">
                        📚 学习助手
                    </button>
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="你是一个商务助手，请用专业、正式的语言处理商业相关问题。">
                        💼 商务助手
                    </button>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button id="clearSystemPromptBtn"
                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    清空
                </button>
                <button id="saveSystemPromptBtn"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- Temperature 快速调节弹窗 -->
    <div id="temperatureModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="ri-settings-4-line mr-2"></i>创造性设置
                </h3>
                <button id="closeTemperatureBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    当前值: <span id="temperatureValue" class="text-blue-600 font-semibold text-lg">0.7</span>
                </label>
                <div class="flex items-center space-x-2 mb-3">
                    <span class="text-xs text-gray-500">精确(0)</span>
                    <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7"
                        class="flex-1 h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span class="text-xs text-gray-500">创造(2)</span>
                </div>

                <!-- 预设值 -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button class="temperature-preset px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border"
                        data-temp="0.1">
                        精准 (0.1)
                    </button>
                    <button class="temperature-preset px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border"
                        data-temp="0.7">
                        平衡 (0.7)
                    </button>
                    <button class="temperature-preset px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border"
                        data-temp="1.5">
                        创意 (1.5)
                    </button>
                </div>

                <p class="text-xs text-gray-500">数值越低回答越准确，数值越高回答越有创意</p>
            </div>

            <div class="flex justify-end">
                <button id="saveTemperatureBtn"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- 个性化设置面板 -->
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                    <i class="ri-settings-3-line"></i>
                    个性化设置
                </h2>
                <button id="closeSettingsBtn" class="text-text-secondary hover:text-text-primary">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
        </div>

        <!-- 主题设置 -->
        <div class="settings-section">
            <h3><i class="ri-palette-line"></i>主题设置</h3>
            <div class="theme-selector">
                <div class="theme-option active" data-theme="light">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1E88E5 0%, #E3F2FD 100%)">
                    </div>
                    <span>浅色主题</span>
                </div>
                <div class="theme-option" data-theme="dark">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #3B82F6 0%, #1E293B 100%)">
                    </div>
                    <span>暗黑主题</span>
                </div>
                <div class="theme-option" data-theme="purple">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #8B5CF6 0%, #F3E8FF 100%)">
                    </div>
                    <span>紫色主题</span>
                </div>
                <div class="theme-option" data-theme="green">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #10B981 0%, #D1FAE5 100%)">
                    </div>
                    <span>绿色主题</span>
                </div>
                <div class="theme-option" data-theme="orange">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #F59E0B 0%, #FEF3C7 100%)">
                    </div>
                    <span>橙色主题</span>
                </div>
                <div class="theme-option" data-theme="custom">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%)">
                    </div>
                    <span>自定义</span>
                </div>
            </div>
        </div>

        <!-- 自定义颜色 -->
        <div class="settings-section" id="customColorsSection" style="display: none;">
            <h3><i class="ri-color-filter-line"></i>自定义颜色</h3>
            <div class="color-picker-container">
                <label for="primaryColorPicker">主要颜色:</label>
                <input type="color" id="primaryColorPicker" class="color-picker" value="#1E88E5">
            </div>
            <div class="color-picker-container">
                <label for="userBubbleColorPicker">用户气泡:</label>
                <input type="color" id="userBubbleColorPicker" class="color-picker" value="#E8E8E8">
            </div>
            <div class="color-picker-container">
                <label for="botBubbleColorPicker">AI气泡:</label>
                <input type="color" id="botBubbleColorPicker" class="color-picker" value="#E3F2FD">
            </div>
        </div>

        <!-- 字体设置 -->
        <div class="settings-section">
            <h3><i class="ri-font-size-2"></i>字体设置</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-text-secondary mb-2">
                    字体大小: <span id="fontSizeValue">16px</span>
                </label>
                <input type="range" id="fontSizeSlider" min="12" max="24" value="16" step="1" class="range-input">
                <div class="flex justify-between text-xs text-text-secondary mt-1">
                    <span>12px</span>
                    <span>18px</span>
                    <span>24px</span>
                </div>
            </div>
        </div>

        <!-- 气泡样式 -->
        <div class="settings-section">
            <h3><i class="ri-chat-3-line"></i>气泡样式</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-text-secondary mb-2">
                    圆角大小: <span id="bubbleRadiusValue">18px</span>
                </label>
                <input type="range" id="bubbleRadiusSlider" min="0" max="30" value="18" step="2" class="range-input">
                <div class="flex justify-between text-xs text-text-secondary mt-1">
                    <span>方形</span>
                    <span>适中</span>
                    <span>圆润</span>
                </div>
            </div>
        </div>

        <!-- 导出设置 -->
        <div class="settings-section">
            <h3><i class="ri-download-line"></i>导出对话</h3>
            <div class="export-buttons">
                <button class="export-btn" id="exportTxtBtn">
                    <i class="ri-file-text-line mr-1"></i>TXT格式
                </button>
                <button class="export-btn" id="exportJsonBtn">
                    <i class="ri-file-code-line mr-1"></i>JSON格式
                </button>
                <button class="export-btn" id="exportMarkdownBtn">
                    <i class="ri-markdown-line mr-1"></i>Markdown格式
                </button>
                <button class="export-btn" id="exportPdfBtn">
                    <i class="ri-file-pdf-line mr-1"></i>PDF格式
                </button>
            </div>
        </div>

        <!-- 重置设置 -->
        <div class="settings-section">
            <h3><i class="ri-refresh-line"></i>重置设置</h3>
            <button id="resetSettingsBtn" class="export-btn"
                style="background: #ef4444; color: white; border-color: #ef4444;">
                <i class="ri-restart-line mr-1"></i>恢复默认设置
            </button>
        </div>
    </div>

    <!-- 快捷操作栏 (桌面端) -->
    <div class="quick-actions-bar hidden lg:flex">
        <button class="quick-action-btn" id="quickClearBtn" title="清空对话">
            <i class="ri-delete-bin-line"></i>
        </button>
        <button class="quick-action-btn" id="quickExportBtn" title="导出对话">
            <i class="ri-download-line"></i>
        </button>
        <button class="quick-action-btn" id="quickSettingsBtn" title="设置">
            <i class="ri-settings-3-line"></i>
        </button>

        <button class="quick-action-btn" id="quickScrollTopBtn" title="回到顶部">
            <i class="ri-arrow-up-line"></i>
        </button>
        <button class="quick-action-btn" id="quickScrollBottomBtn" title="回到底部">
            <i class="ri-arrow-down-line"></i>
        </button>
    </div>

    <!-- 移动端快捷操作栏 -->
    <div class="mobile-quick-actions lg:hidden">
        <button class="mobile-quick-btn" id="mobileQuickExportBtn" title="导出对话">
            <i class="ri-download-line"></i>
        </button>
        <button class="mobile-quick-btn" id="mobileQuickSettingsBtn" title="设置">
            <i class="ri-settings-3-line"></i>
        </button>
        <button class="mobile-quick-btn" id="mobileScrollTopBtn" title="回到顶部">
            <i class="ri-arrow-up-line"></i>
        </button>
    </div>

    <!-- 主要内容区域 -->
    <div class="flex flex-1 overflow-hidden relative">
        <!-- 历史对话侧边栏 -->
        <div id="sidebar"
            class="w-80 bg-bg-primary border-r border-border-primary flex flex-col transform transition-transform duration-300 -translate-x-full absolute lg:relative z-30 h-full lg:translate-x-0">
            <!-- 侧边栏头部 -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="ri-history-line mr-2"></i>对话历史
                    </h2>
                    <button id="closeSidebar" class="lg:hidden p-1 text-gray-400 hover:text-gray-600 rounded">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <!-- 搜索框 -->
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="搜索对话..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <i class="ri-search-line absolute left-3 top-2.5 text-gray-400"></i>
                </div>
            </div>

            <!-- 统计信息 -->
            <div id="statsSection" class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-lg font-semibold text-blue-600" id="totalSessions">0</div>
                        <div class="text-xs text-gray-500">总对话</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-green-600" id="totalMessages">0</div>
                        <div class="text-xs text-gray-500">总消息</div>
                    </div>
                </div>
            </div>

            <!-- 对话列表 -->
            <div class="flex-1 overflow-y-auto">
                <div id="sessionsList" class="p-2">
                    <!-- 对话列表项将在这里动态生成 -->
                </div>
                <div id="loadMoreSessions" class="p-4 text-center hidden">
                    <button class="text-blue-500 hover:text-blue-600 text-sm">加载更多...</button>
                </div>
            </div>
        </div>

        <!-- 右侧主要内容区域 -->
        <div class="flex-1 flex flex-col">
            <!-- 聊天内容区域 -->
            <div id="chatContainer" class="chat-container flex-1 overflow-y-auto p-4 bg-bg-secondary">
                <!-- 欢迎消息 -->
                <div class="flex mb-4">
                    <div class="message-bubble bot-message p-3 text-gray-800">
                        <p>我是 多模态机器人，很高兴见到你！</p>
                        <p class="mt-2">我可以帮你写代码、读文件、写作各种创意内容，请把你的任务交给我吧</p>
                    </div>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="input-area bg-bg-primary px-4 py-3 border-t border-border-primary">
                <!-- 开启新对话按钮 -->
                <div class="new-chat-button-container">
                    <button id="newChatButton" class="new-chat-button" title="清空当前对话，开始全新的对话">
                        <div class="new-chat-button-icon">
                            <div class="chat-bubble-icon"></div>
                        </div>
                        <span class="new-chat-button-text">开启新对话</span>
                    </button>
                </div>

                <!-- 预览区域 -->
                <div id="previewArea" class="hidden mb-3">
                    <div id="imagePreview" class="hidden relative inline-block mr-2 mb-2">
                        <img id="previewImage" class="h-20 w-auto rounded" alt="预览图片">
                        <button id="removeImageBtn"
                            class="absolute -top-2 -right-2 bg-gray-800 bg-opacity-70 rounded-full w-5 h-5 flex items-center justify-center text-white">
                            <div class="w-3 h-3 flex items-center justify-center">
                                <i class="ri-close-line"></i>
                            </div>
                        </button>
                    </div>

                    <div id="audioPreview" class="hidden relative inline-block mr-2 mb-2">
                        <div
                            class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center space-x-3 min-w-48">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="ri-file-music-line text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <div id="audioFileName" class="text-sm font-medium text-gray-800">音频文件</div>
                                <div id="audioFileSize" class="text-xs text-gray-500">0 MB</div>
                            </div>
                            <button id="removeAudioBtn"
                                class="w-6 h-6 bg-gray-800 bg-opacity-70 rounded-full flex items-center justify-center text-white hover:bg-opacity-90">
                                <i class="ri-close-line text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <div id="videoPreview" class="hidden relative inline-block mr-2 mb-2">
                        <div
                            class="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center space-x-3 min-w-48">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="ri-video-line text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <div id="videoFileName" class="text-sm font-medium text-gray-800">视频文件</div>
                                <div id="videoFileSize" class="text-xs text-gray-500">0 MB</div>
                            </div>
                            <button id="removeVideoBtn"
                                class="w-6 h-6 bg-gray-800 bg-opacity-70 rounded-full flex items-center justify-center text-white hover:bg-opacity-90">
                                <i class="ri-close-line text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <div id="audioRecording"
                        class="hidden bg-red-50 border border-red-200 rounded-lg p-3 inline-flex items-center space-x-3">
                        <div class="audio-wave">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="text-sm text-red-700 font-medium">正在录音...</span>
                        <button id="stopRecordingBtn"
                            class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white hover:bg-red-600">
                            <i class="ri-stop-circle-fill"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-end">
                    <div class="flex space-x-2 mr-3">
                        <button id="uploadAttachmentBtn"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-all duration-200"
                            title="上传附件（图片、音频、视频等）">
                            <div class="w-5 h-5 flex items-center justify-center">
                                <i class="ri-attachment-2"></i>
                            </div>
                        </button>
                        <button id="startVoiceBtn"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-all duration-200"
                            title="录音">
                            <div class="w-5 h-5 flex items-center justify-center">
                                <i class="ri-mic-line"></i>
                            </div>
                        </button>
                    </div>

                    <div class="flex-1 relative">
                        <textarea id="messageInput"
                            class="message-input w-full border-none focus:ring-0 rounded-xl bg-gray-100 px-4 py-2 text-gray-800 placeholder-gray-500"
                            placeholder="输入您想说的话..." rows="1"></textarea>
                    </div>

                    <!-- 联网搜索开关 -->
                    <div class="search-controls-inline ml-3">
                        <label class="switch-inline">
                            <input type="checkbox" id="enableSearch" checked>
                            <span class="slider-inline round"></span>
                        </label>
                        <label for="enableSearch" class="search-label-inline">
                            <span class="search-status-icon">🌐</span>
                        </label>
                    </div>



                    <button id="sendMessageBtn"
                        class="ml-3 px-4 py-2 !rounded-button bg-gray-200 text-gray-500 hover:bg-gray-300 transition-colors disabled:opacity-50 whitespace-nowrap">
                        <div class="w-5 h-5 flex items-center justify-center">
                            <i class="ri-send-plane-fill"></i>
                        </div>
                    </button>
                </div>

                <!-- 底部提示信息 -->
                <div class="input-hints mt-2 flex justify-center items-center text-xs">
                    <div class="text-text-secondary opacity-60">
                        <span>Shift + Enter 换行 • 自动识别内容类型切换模型</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文件上传隐藏输入 -->
    <input type="file" id="attachmentFileInput" accept="image/*,audio/*,video/*,application/*,text/*" multiple
        class="hidden">

    <!-- 隐藏的模型选择器（仅供JavaScript使用） -->
    <select id="modelSelect" class="hidden">
        <option value="loading">加载中...</option>
    </select>



    <script id="chatFunctionality">
        // 配置MathJax
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: { '[+]': ['ams', 'newcommand', 'autoload', 'color', 'physics', 'cancel', 'mathtools'] },
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams',
                processRefs: true,
                macros: {
                    // 添加一些常用的数学宏
                    RR: "{\\mathbb{R}}",
                    CC: "{\\mathbb{C}}",
                    NN: "{\\mathbb{N}}",
                    ZZ: "{\\mathbb{Z}}",
                    QQ: "{\\mathbb{Q}}",
                    vec: ["\\mathbf{#1}", 1],
                    norm: ["\\left\\|#1\\right\\|", 1],
                    abs: ["\\left|#1\\right|", 1],
                    floor: ["\\left\\lfloor#1\\right\\rfloor", 1],
                    ceil: ["\\left\\lceil#1\\right\\rceil", 1]
                }
            },
            svg: {
                fontCache: 'global',
                scale: 1.2,
                minScale: 0.9,
                mtextInheritFont: true,
                displayAlign: 'center',
                displayIndent: '0'
            },
            chtml: {
                scale: 1.2,
                minScale: 0.9,
                mtextInheritFont: true,
                displayAlign: 'center',
                displayIndent: '0'
            },
            options: {
                processHtmlClass: 'markdown-content',
                ignoreHtmlClass: 'tex2jax_ignore',
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                renderActions: {
                    addMenu: [0, '', '']
                }
            },
            loader: {
                load: ['[tex]/ams', '[tex]/color', '[tex]/newcommand', '[tex]/autoload', '[tex]/cancel', '[tex]/mathtools']
            },
            startup: {
                pageReady: () => {
                    console.log('MathJax页面准备就绪');
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax初始化完成');
                        // 确保MathJax正确初始化后，重新渲染页面上已有的数学公式
                        if (document.querySelector('.markdown-content')) {
                            console.log('重新渲染页面上的数学公式');
                            MathJax.typesetPromise([document.body]).catch(err => {
                                console.error('初始化时渲染数学公式失败:', err);
                            });
                        }
                    });
                },
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax已准备就绪');
                }
            }
        };

        // 配置Marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function (code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                } else {
                    return code;
                }
            }
        });

        // 简化的Markdown渲染函数
        function renderMarkdown(text) {
            console.log('渲染Markdown文本:', text.substring(0, 100) + '...');

            // 直接使用marked.js渲染，不做复杂的数学公式保护
            // MathJax会在后续处理数学公式
            return marked.parse(text);
        }

        // 渲染消息内容的函数
        function renderMessageContent(text, isMarkdown = true) {
            if (!text) return '';

            if (isMarkdown) {
                const html = renderMarkdown(text);
                return `<div class="markdown-content">${html}</div>`;
            } else {
                // 简单的文本处理，保留换行
                return text.replace(/\n/g, '<br>');
            }
        }

        // 处理代码高亮的函数
        function highlightCode(element) {
            // 对所有pre code元素应用语法高亮
            element.querySelectorAll('pre code').forEach((codeBlock) => {
                Prism.highlightElement(codeBlock);
            });
        }

        // 优化的数学公式渲染函数
        function renderMath(element) {
            console.log('开始渲染数学公式');

            // 检查是否包含数学公式
            const text = element.textContent || element.innerText || '';
            const hasMath = /\$|\\\(|\\\[|\\int|\\sum|\\frac|\\sqrt|\\alpha|\\beta|\\gamma|\\pi|\\theta|\\phi|\\psi|\\omega/.test(text);

            if (!hasMath) {
                console.log('未检测到数学公式标记，跳过渲染');
                return;
            }

            if (window.MathJax && window.MathJax.typesetPromise) {
                // 清除之前可能存在的渲染结果
                element.querySelectorAll('mjx-container').forEach(container => {
                    if (container.parentNode) {
                        container.remove();
                    }
                });

                window.MathJax.typesetPromise([element]).then(() => {
                    console.log('MathJax渲染完成');

                    // 优化渲染后的显示效果
                    element.querySelectorAll('mjx-container[display="block"]').forEach(container => {
                        // 确保块级公式居中显示
                        const parent = container.parentElement;
                        if (parent && !parent.style.textAlign) {
                            parent.style.textAlign = 'center';
                        }

                        // 处理长公式的滚动
                        if (container.scrollWidth > container.clientWidth) {
                            container.style.overflowX = 'auto';
                            container.style.overflowY = 'hidden';
                        }
                    });

                    // 为行内公式添加适当的间距
                    element.querySelectorAll('mjx-container[display="inline"]').forEach(container => {
                        container.style.verticalAlign = 'middle';
                    });

                    // 滚动到底部
                    if (typeof scrollToBottom === 'function') {
                        setTimeout(scrollToBottom, 150);
                    }

                    // 触发自定义事件，通知渲染完成
                    element.dispatchEvent(new CustomEvent('mathRendered', {
                        detail: { element: element }
                    }));

                }).catch((err) => {
                    console.error('MathJax渲染错误:', err);

                    // 显示友好的错误信息
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'math-error';
                    errorDiv.innerHTML = `
                        <strong>数学公式渲染失败</strong><br>
                        <small>${err.message}</small><br>
                        <em>请检查公式语法是否正确</em>
                    `;
                    element.appendChild(errorDiv);
                });
            } else {
                console.log('MathJax未加载，延迟重试');
                // MathJax未加载，延迟重试，最多重试5次
                if (!element._mathRetryCount) {
                    element._mathRetryCount = 0;
                }

                if (element._mathRetryCount < 5) {
                    element._mathRetryCount++;
                    setTimeout(() => renderMath(element), 500);
                } else {
                    console.error('MathJax加载失败，停止重试');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'math-error';
                    errorDiv.textContent = 'MathJax加载失败，无法渲染数学公式';
                    element.appendChild(errorDiv);
                }
            }
        }

        // 强制重新渲染所有数学公式的辅助函数
        function forceRerenderMath() {
            console.log('强制重新渲染所有数学公式');
            if (window.MathJax && window.MathJax.typesetPromise) {
                const mathElements = document.querySelectorAll('.markdown-content');
                if (mathElements.length > 0) {
                    window.MathJax.typesetPromise(Array.from(mathElements)).then(() => {
                        console.log('强制重新渲染完成');
                    }).catch((err) => {
                        console.error('强制重新渲染失败:', err);
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const uploadAttachmentBtn = document.getElementById('uploadAttachmentBtn');
            const attachmentFileInput = document.getElementById('attachmentFileInput');
            const previewArea = document.getElementById('previewArea');
            const imagePreview = document.getElementById('imagePreview');
            const audioPreview = document.getElementById('audioPreview');
            const videoPreview = document.getElementById('videoPreview');
            const previewImage = document.getElementById('previewImage');
            const audioFileName = document.getElementById('audioFileName');
            const audioFileSize = document.getElementById('audioFileSize');
            const videoFileName = document.getElementById('videoFileName');
            const videoFileSize = document.getElementById('videoFileSize');
            const removeImageBtn = document.getElementById('removeImageBtn');
            const removeAudioBtn = document.getElementById('removeAudioBtn');
            const removeVideoBtn = document.getElementById('removeVideoBtn');
            const startVoiceBtn = document.getElementById('startVoiceBtn');
            const audioRecording = document.getElementById('audioRecording');
            const stopRecordingBtn = document.getElementById('stopRecordingBtn');
            // const clearChatBtn = document.getElementById('clearChatBtn'); // 已删除按钮
            const modelSelect = document.getElementById('modelSelect');


            // 设置相关元素
            const headerTemperatureBtn = document.getElementById('headerTemperatureBtn');
            const headerTemperatureValue = document.getElementById('headerTemperatureValue');
            const headerSystemPromptBtn = document.getElementById('headerSystemPromptBtn');
            const systemPromptStatus = document.getElementById('systemPromptStatus');
            const systemPromptIcon = document.getElementById('systemPromptIcon');

            // System Prompt 弹窗元素
            const systemPromptModal = document.getElementById('systemPromptModal');
            const closeSystemPromptBtn = document.getElementById('closeSystemPromptBtn');
            const systemPromptInput = document.getElementById('systemPromptInput');
            const saveSystemPromptBtn = document.getElementById('saveSystemPromptBtn');
            const clearSystemPromptBtn = document.getElementById('clearSystemPromptBtn');

            // Temperature 弹窗元素
            const temperatureModal = document.getElementById('temperatureModal');
            const closeTemperatureBtn = document.getElementById('closeTemperatureBtn');
            const temperatureSlider = document.getElementById('temperatureSlider');
            const temperatureValue = document.getElementById('temperatureValue');
            const saveTemperatureBtn = document.getElementById('saveTemperatureBtn');

            let isRecording = false;
            let selectedImage = null;
            let selectedAudio = null;
            let selectedVideo = null;
            let mediaRecorder = null;
            let recordedChunks = [];

            // 设置相关变量
            let systemPrompt = '';
            let temperature = 0.7;

            // 更新界面状态显示
            function updateUIStatus() {
                // 更新temperature显示
                headerTemperatureValue.textContent = temperature;

                // 更新system prompt状态
                if (systemPrompt && systemPrompt.trim()) {
                    systemPromptStatus.textContent = '已设置';
                    systemPromptIcon.className = 'ri-chat-settings-fill text-sm text-blue-500 mr-1';
                    headerSystemPromptBtn.classList.add('bg-blue-50', 'border', 'border-blue-200');
                    headerSystemPromptBtn.classList.remove('bg-gray-100');
                } else {
                    systemPromptStatus.textContent = '系统提示';
                    systemPromptIcon.className = 'ri-chat-settings-line text-sm text-gray-500 mr-1';
                    headerSystemPromptBtn.classList.remove('bg-blue-50', 'border', 'border-blue-200');
                    headerSystemPromptBtn.classList.add('bg-gray-100');
                }
            }
            let currentModel = 'deepseek-ai/DeepSeek-V2.5';
            let conversationHistory = [];
            let currentSessionId = null;
            let sessionsData = [];
            let currentPage = 1;
            let isLoadingSessions = false;

            // 模型图标和描述映射
            const modelDisplayInfo = {
                'deepseek-ai/DeepSeek-V2.5': {
                    icon: '🧠',
                    description: '深度推理专家'
                },
                'Qwen/Qwen2.5-7B-Instruct': {
                    icon: '🔮',
                    description: '智能问答助手'
                },
                'meta-llama/llama-4-scout-17b-16e-instruct': {
                    icon: '🦙',
                    description: '多模态大师'
                },
                'meta-llama/llama-4-maverick-17b-128e-instruct': {
                    icon: '🚀',
                    description: '创新对话专家'
                }
            };

            // 加载可用模型
            async function loadModels() {
                try {
                    const response = await fetch('/api/models');
                    const data = await response.json();

                    if (data.success && data.models.length > 0) {
                        modelSelect.innerHTML = '';

                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;

                            // 获取模型显示信息
                            const displayInfo = modelDisplayInfo[model.id] || {
                                icon: '🤖',
                                description: '智能助手'
                            };

                            // 构建显示文本
                            const modelName = model.name.replace(/\(文本\)|\(多模态\)/g, '').trim();
                            const supportText = model.supports_image ? ' (多模态)' : ' (文本)';

                            option.textContent = `${displayInfo.icon} ${modelName} - ${displayInfo.description}${supportText}`;

                            if (model.default || model.id === currentModel) {
                                option.selected = true;
                                currentModel = model.id;
                            }
                            modelSelect.appendChild(option);
                        });

                        console.log('已加载模型:', data.models.length, '个');
                    } else {
                        modelSelect.innerHTML = '<option value="">无可用模型</option>';
                    }
                } catch (error) {
                    console.error('加载模型失败:', error);
                    modelSelect.innerHTML = '<option value="">加载失败</option>';
                }
            }

            // 模型选择事件
            modelSelect.addEventListener('change', function () {
                currentModel = this.value;
                console.log('切换模型:', currentModel);
            });

            // 页面加载时加载模型和历史记录
            loadModels();
            loadSessions();

            // 历史对话相关的DOM元素
            const sidebar = document.getElementById('sidebar');
            const toggleSidebar = document.getElementById('toggleSidebar');
            const closeSidebar = document.getElementById('closeSidebar');
            // const historyToggle = document.getElementById('historyToggle'); // 已删除按钮
            // const newChatBtn = document.getElementById('newChatBtn'); // 已删除按钮
            const searchInput = document.getElementById('searchInput');
            const sessionsList = document.getElementById('sessionsList');
            const totalSessions = document.getElementById('totalSessions');
            const totalMessages = document.getElementById('totalMessages');
            const loadMoreSessions = document.getElementById('loadMoreSessions');

            // 历史对话相关功能

            // 加载会话列表
            async function loadSessions(page = 1, reset = false) {
                if (isLoadingSessions) return;
                isLoadingSessions = true;

                try {
                    const response = await fetch(`/api/sessions?page=${page}&limit=20`);
                    const data = await response.json();

                    if (data.success) {
                        if (reset) {
                            sessionsData = data.sessions;
                            sessionsList.innerHTML = '';
                        } else {
                            sessionsData = [...sessionsData, ...data.sessions];
                        }

                        renderSessions(data.sessions, !reset);
                        updateStatistics(data.statistics);

                        // 显示/隐藏"加载更多"按钮
                        if (data.pagination.has_more) {
                            loadMoreSessions.classList.remove('hidden');
                            currentPage = page;
                        } else {
                            loadMoreSessions.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('加载会话列表失败:', error);
                } finally {
                    isLoadingSessions = false;
                }
            }

            // 渲染会话列表
            function renderSessions(sessions, append = false) {
                if (!append) {
                    sessionsList.innerHTML = '';
                }

                sessions.forEach(session => {
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = `session-item p-3 mb-2 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors ${currentSessionId === session.id ? 'bg-blue-50 border-2 border-blue-200' : ''}`;
                    sessionDiv.dataset.sessionId = session.id;

                    const timeStr = new Date(session.updated_at).toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    sessionDiv.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-800 truncate">${session.title}</h4>
                                <div class="flex items-center mt-1 text-xs text-gray-500">
                                    <i class="ri-message-3-line mr-1"></i>
                                    <span>${session.message_count} 条消息</span>
                                    <span class="mx-2">•</span>
                                    <span>${timeStr}</span>
                                </div>
                                ${session.model ? `<div class="mt-1 text-xs text-blue-600">${session.model.split('/').pop()}</div>` : ''}
                            </div>
                            <div class="flex items-center space-x-1 ml-2">
                                <button class="session-rename p-1 text-gray-400 hover:text-gray-600 rounded" title="重命名">
                                    <i class="ri-edit-2-line text-xs"></i>
                                </button>
                                <button class="session-delete p-1 text-gray-400 hover:text-red-600 rounded" title="删除">
                                    <i class="ri-delete-bin-line text-xs"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    // 点击会话项
                    sessionDiv.addEventListener('click', (e) => {
                        if (e.target.closest('.session-rename') || e.target.closest('.session-delete')) {
                            return;
                        }
                        loadSession(session.id);
                    });

                    // 重命名按钮
                    sessionDiv.querySelector('.session-rename').addEventListener('click', (e) => {
                        e.stopPropagation();
                        renameSession(session.id, session.title);
                    });

                    // 删除按钮
                    sessionDiv.querySelector('.session-delete').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteSession(session.id);
                    });

                    sessionsList.appendChild(sessionDiv);
                });
            }

            // 更新统计信息
            function updateStatistics(stats) {
                totalSessions.textContent = stats.total_sessions;
                totalMessages.textContent = stats.total_messages;
            }

            // 创建新对话
            async function createNewSession() {
                try {
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: currentModel
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        currentSessionId = data.session.id;
                        conversationHistory = [];
                        clearChatDisplay();
                        loadSessions(1, true); // 重新加载会话列表

                        // 关闭侧边栏（移动端）
                        if (window.innerWidth < 1024) {
                            sidebar.classList.add('-translate-x-full');
                        }
                    }
                } catch (error) {
                    console.error('创建新对话失败:', error);
                }
            }

            // 加载指定会话
            async function loadSession(sessionId) {
                try {
                    const response = await fetch(`/api/sessions/${sessionId}`);
                    const data = await response.json();

                    if (data.success) {
                        currentSessionId = sessionId;
                        conversationHistory = [];
                        clearChatDisplay();

                        // 渲染历史消息
                        data.messages.forEach(msg => {
                            if (msg.role === 'user') {
                                const userMessage = {
                                    role: 'user',
                                    text: msg.content,
                                    image: msg.image_data
                                };
                                conversationHistory.push(userMessage);
                                // 根据内容类型确定媒体类型
                                let image = null, audio = null, video = null;

                                if (msg.content_type === 'image') {
                                    image = msg.image_data;
                                } else if (msg.content_type === 'audio') {
                                    audio = msg.image_data; // image_data字段现在存储所有媒体数据
                                } else if (msg.content_type === 'video') {
                                    video = msg.image_data;
                                }

                                displayUserMessage(msg.content, image, audio, video, msg.content_type);
                            } else if (msg.role === 'assistant') {
                                conversationHistory.push({
                                    role: 'assistant',
                                    text: msg.content
                                });
                                displayBotMessage(msg.content, msg.provider);
                            }
                        });

                        // 更新会话列表中的选中状态
                        document.querySelectorAll('.session-item').forEach(item => {
                            if (item.dataset.sessionId === sessionId) {
                                item.classList.add('bg-blue-50', 'border-2', 'border-blue-200');
                            } else {
                                item.classList.remove('bg-blue-50', 'border-2', 'border-blue-200');
                            }
                        });

                        // 关闭侧边栏（移动端）
                        if (window.innerWidth < 1024) {
                            sidebar.classList.add('-translate-x-full');
                        }

                        scrollToBottom();
                    }
                } catch (error) {
                    console.error('加载会话失败:', error);
                }
            }

            // 重命名会话
            async function renameSession(sessionId, currentTitle) {
                const newTitle = prompt('请输入新的对话标题:', currentTitle);
                if (newTitle && newTitle !== currentTitle) {
                    try {
                        const response = await fetch(`/api/sessions/${sessionId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: newTitle
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            loadSessions(1, true); // 重新加载会话列表
                        }
                    } catch (error) {
                        console.error('重命名会话失败:', error);
                    }
                }
            }

            // 删除会话
            async function deleteSession(sessionId) {
                if (confirm('确定要删除这个对话吗？此操作不可撤销。')) {
                    try {
                        const response = await fetch(`/api/sessions/${sessionId}`, {
                            method: 'DELETE'
                        });

                        const data = await response.json();
                        if (data.success) {
                            if (currentSessionId === sessionId) {
                                currentSessionId = null;
                                conversationHistory = [];
                                clearChatDisplay();
                            }
                            loadSessions(1, true); // 重新加载会话列表
                        }
                    } catch (error) {
                        console.error('删除会话失败:', error);
                    }
                }
            }

            // 清空聊天显示
            function clearChatDisplay() {
                chatContainer.innerHTML = `
                    <!-- 欢迎消息 -->
                    <div class="flex mb-4">
                        <div class="message-bubble bot-message p-3 text-gray-800">
                            <p>我是 多模态机器人，很高兴见到你！</p>
                            <p class="mt-2">我可以帮你写代码、读文件、写作各种创意内容，请把你的任务交给我吧</p>
                        </div>
                    </div>
                `;
            }

            // 显示用户消息
            function displayUserMessage(text, image, audio, video, contentType) {
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex mb-4 justify-end';

                let messageContent = '';
                if (text) {
                    messageContent += `<div>${text}</div>`;
                }

                if (image) {
                    messageContent += `<img src="${image}" class="max-w-xs rounded mt-2 block">`;
                }

                if (audio) {
                    messageContent += `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-2 max-w-xs">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="ri-file-music-line text-blue-600 text-sm"></i>
                                </div>
                                <div class="text-sm font-medium text-gray-800">音频文件</div>
                            </div>
                            <audio controls class="w-full">
                                <source src="${audio}" type="audio/webm">
                                您的浏览器不支持音频播放
                            </audio>
                        </div>`;
                }

                if (video) {
                    messageContent += `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-2">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="ri-video-line text-green-600 text-sm"></i>
                                </div>
                                <div class="text-sm font-medium text-gray-800">视频文件</div>
                            </div>
                            <video controls class="w-full max-w-xs rounded">
                                <source src="${video}" type="video/mp4">
                                您的浏览器不支持视频播放
                            </video>
                        </div>`;
                }

                userMessageDiv.innerHTML = `
                    <div class="message-bubble user-message p-3 text-gray-800">
                        ${messageContent}
                    </div>
                `;

                chatContainer.appendChild(userMessageDiv);
            }

            // 显示机器人消息（支持Markdown渲染）
            function displayBotMessage(text, provider) {
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'flex mb-4';

                const providerBadge = provider === 'groq' ?
                    '<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">Groq 🖼️</span>' :
                    '<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">SiliconFlow 📝</span>';

                // 始终使用Markdown渲染，移除不可靠的hasMarkdown判断
                const contentHtml = renderMessageContent(text, true);

                botMessageDiv.innerHTML = `
                    <div class="message-bubble bot-message p-3 text-gray-800">
                        ${providerBadge}
                        <div class="mt-1">${contentHtml}</div>
                    </div>
                `;

                chatContainer.appendChild(botMessageDiv);

                // 始终应用代码高亮和数学公式渲染
                highlightCode(botMessageDiv);
                renderMath(botMessageDiv);
            }

            // 侧边栏控制事件
            toggleSidebar.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            closeSidebar.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
            });

            // historyToggle.addEventListener('click', () => {
            //     sidebar.classList.toggle('-translate-x-full');
            // }); // 已删除按钮

            // 新对话按钮
            // newChatBtn.addEventListener('click', createNewSession); // 已删除按钮

            // 搜索功能
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = searchInput.value.trim();
                    if (query) {
                        searchMessages(query);
                    } else {
                        loadSessions(1, true);
                    }
                }, 300);
            });

            // 搜索消息
            async function searchMessages(query) {
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.success) {
                        sessionsList.innerHTML = '';

                        if (data.results.length === 0) {
                            sessionsList.innerHTML = '<div class="p-4 text-center text-gray-500">未找到相关内容</div>';
                            return;
                        }

                        // 按会话分组显示搜索结果
                        const groupedResults = {};
                        data.results.forEach(msg => {
                            if (!groupedResults[msg.session_id]) {
                                groupedResults[msg.session_id] = {
                                    session_title: msg.session_title,
                                    messages: []
                                };
                            }
                            groupedResults[msg.session_id].messages.push(msg);
                        });

                        Object.entries(groupedResults).forEach(([sessionId, sessionData]) => {
                            const sessionDiv = document.createElement('div');
                            sessionDiv.className = 'p-3 mb-2 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors';
                            sessionDiv.dataset.sessionId = sessionId;

                            const previewText = sessionData.messages[0].content.substring(0, 100) + (sessionData.messages[0].content.length > 100 ? '...' : '');

                            sessionDiv.innerHTML = `
                                <div class="text-sm font-medium text-gray-800 mb-1">${sessionData.session_title}</div>
                                <div class="text-xs text-gray-600 mb-2">${previewText}</div>
                                <div class="text-xs text-blue-600">找到 ${sessionData.messages.length} 条匹配消息</div>
                            `;

                            sessionDiv.addEventListener('click', () => {
                                loadSession(sessionId);
                                searchInput.value = '';
                            });

                            sessionsList.appendChild(sessionDiv);
                        });
                    }
                } catch (error) {
                    console.error('搜索失败:', error);
                }
            }

            // 加载更多会话
            loadMoreSessions.addEventListener('click', () => {
                loadSessions(currentPage + 1);
            });

            // 自动调整文本框高度
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                updateSendButton();
            });

            // 更新发送按钮状态
            function updateSendButton() {
                if (messageInput.value.trim() || selectedImage || selectedAudio || selectedVideo) {
                    sendMessageBtn.classList.remove('bg-gray-200', 'text-gray-500');
                    sendMessageBtn.classList.add('bg-primary', 'text-white');
                } else {
                    sendMessageBtn.classList.add('bg-gray-200', 'text-gray-500');
                    sendMessageBtn.classList.remove('bg-primary', 'text-white');
                }
            }

            // 发送消息
            async function sendMessage() {
                const messageText = messageInput.value.trim();

                if (!messageText && !selectedImage && !selectedAudio && !selectedVideo) return;

                // 创建用户消息对象
                const userMessage = {
                    text: messageText,
                    image: selectedImage,
                    audio: selectedAudio,
                    video: selectedVideo
                };

                // 使用新的类型化消息系统
                const userMessageDiv = createTypedMessage(userMessage, true, { showTypeIndicator: true });
                chatContainer.appendChild(userMessageDiv);

                // 保存到对话历史
                conversationHistory.push({
                    role: 'user',
                    text: messageText,
                    image: selectedImage,
                    audio: selectedAudio,
                    video: selectedVideo
                });

                // 清空输入框和预览
                messageInput.value = '';
                messageInput.style.height = 'auto';
                selectedImage = null;
                selectedAudio = null;
                selectedVideo = null;
                previewArea.classList.add('hidden');
                imagePreview.classList.add('hidden');
                audioPreview.classList.add('hidden');
                videoPreview.classList.add('hidden');

                // 显示现代加载状态
                const loadingDiv = showLoadingState(LoadingType.CHAT, '正在生成回复...', true);
                loadingDiv.classList.add('typing-message'); // 添加类名以便后续识别

                try {
                    // 如果当前没有会话，先创建一个新会话
                    if (!currentSessionId) {
                        const sessionResponse = await fetch('/api/sessions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: messageText.length > 30 ? messageText.substring(0, 30) + '...' : messageText,
                                model: currentModel
                            })
                        });

                        const sessionData = await sessionResponse.json();
                        if (sessionData.success) {
                            currentSessionId = sessionData.session.id;
                            loadSessions(1, true); // 重新加载会话列表
                        }
                    }

                    // 发送到后端API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: conversationHistory,
                            model: currentModel,
                            session_id: currentSessionId,
                            system_prompt: systemPrompt,
                            temperature: temperature
                        })
                    });

                    const data = await response.json();

                    // 移除loading状态
                    const typingMessages = document.getElementsByClassName('typing-message');
                    if (typingMessages.length > 0) {
                        hideLoadingState(typingMessages[0]);
                    }

                    if (response.ok && data.success) {
                        // 检查是否自动切换了模型
                        if (data.model && data.model !== currentModel) {
                            // 显示模型切换提示
                            const switchNoticeDiv = document.createElement('div');
                            switchNoticeDiv.className = 'flex mb-2';
                            switchNoticeDiv.innerHTML = `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 text-sm text-blue-700">
                                    <i class="ri-information-line"></i> 检测到图片内容，已自动切换到多模态模型: ${data.model}
                                </div>
                            `;
                            chatContainer.appendChild(switchNoticeDiv);
                        }

                        // 检测Bot回复类型
                        const context = {
                            isAnalysis: selectedImage || selectedAudio || selectedVideo,
                            isSearch: false,
                            showTypeIndicator: true
                        };

                        const botMessage = { text: data.response };
                        const botMessageType = detectBotResponseType(data.response, context);

                        // 创建Bot消息容器
                        const botMessageDiv = document.createElement('div');
                        botMessageDiv.className = 'flex mb-4';

                        // 显示使用的服务提供商信息
                        const providerBadge = data.provider === 'groq' ?
                            '<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">Groq 🖼️</span>' :
                            '<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">SiliconFlow 📝</span>';

                        const typeIndicator = createTypeIndicator(botMessageType);

                        botMessageDiv.innerHTML = `
                            <div class="message-bubble bot-message message-type-${botMessageType} p-3">
                                <div class="message-content-group">
                                    ${typeIndicator}
                                    ${providerBadge}
                                    <div class="text-content mt-1">
                                        <span class="typewriter-text"></span><span class="typewriter-cursor"></span>
                                    </div>
                                </div>
                            </div>
                        `;

                        chatContainer.appendChild(botMessageDiv);
                        scrollToBottom();

                        // 使用打字机效果显示回复
                        const messageElement = botMessageDiv.querySelector('.text-content');
                        await typewriterEffect(messageElement, data.response, 25);

                        // 保存机器人回复到历史
                        conversationHistory.push({
                            role: 'assistant',
                            text: data.response
                        });
                    } else {
                        // 显示错误信息
                        const errorMessageDiv = document.createElement('div');
                        errorMessageDiv.className = 'flex mb-4';
                        errorMessageDiv.innerHTML = `
                            <div class="message-bubble bot-message p-3 text-red-600">
                                ❌ 抱歉，发生了错误: ${data.error || '未知错误'}
                            </div>
                        `;
                        chatContainer.appendChild(errorMessageDiv);
                    }
                } catch (error) {
                    // 移除loading状态
                    const typingMessages = document.getElementsByClassName('typing-message');
                    if (typingMessages.length > 0) {
                        hideLoadingState(typingMessages[0]);
                    }

                    // 显示网络错误
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'flex mb-4';
                    errorMessageDiv.innerHTML = `
                        <div class="message-bubble bot-message p-3 text-red-600">
                            ❌ 网络连接错误，请检查后端服务是否启动 (${error.message})
                        </div>
                    `;
                    chatContainer.appendChild(errorMessageDiv);
                }

                scrollToBottom();
                updateSendButton();
            }

            // 滚动到底部
            function scrollToBottom() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // 打字机效果函数（支持Markdown渲染）
            function typewriterEffect(element, text, speed = 30) {
                return new Promise((resolve) => {
                    const textSpan = element.querySelector('.typewriter-text');
                    const cursor = element.querySelector('.typewriter-cursor');

                    // 检查是否包含Markdown格式或数学公式
                    const hasMarkdown = /[#*`|\\]/.test(text) ||
                        text.includes('```') ||
                        text.includes('|') ||
                        text.includes('$$') ||
                        text.includes('\\(') ||
                        text.includes('\\[') ||
                        /\$[^$]+\$/.test(text);

                    if (hasMarkdown) {
                        // 使用Markdown渲染
                        const renderedContent = renderMessageContent(text, true);

                        // 移除打字机结构，直接显示渲染的内容
                        element.innerHTML = renderedContent;

                        // 应用代码高亮
                        highlightCode(element);

                        // 渲染数学公式
                        renderMath(element);

                        resolve();
                    } else {
                        // 原有的打字机效果
                        let i = 0;

                        function type() {
                            if (i < text.length) {
                                // 处理换行符
                                if (text.charAt(i) === '\n') {
                                    textSpan.innerHTML += '<br>';
                                } else {
                                    textSpan.innerHTML += text.charAt(i);
                                }
                                i++;
                                scrollToBottom(); // 在打字过程中保持滚动到底部
                                setTimeout(type, speed);
                            } else {
                                // 打字完成后移除光标
                                if (cursor) {
                                    cursor.remove();
                                }
                                resolve();
                            }
                        }

                        type();
                    }
                });
            }

            // 发送按钮点击事件
            sendMessageBtn.addEventListener('click', sendMessage);

            // 回车键发送消息
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 统一附件上传按钮点击事件
            uploadAttachmentBtn.addEventListener('click', function () {
                attachmentFileInput.click();
            });

            // 统一附件文件选择事件
            attachmentFileInput.addEventListener('change', async function () {
                if (this.files && this.files.length > 0) {
                    const file = this.files[0]; // 处理第一个文件

                    // 检测文件类型
                    const fileType = getFileType(file);

                    if (!fileType) {
                        alert('不支持的文件格式');
                        return;
                    }

                    // 根据文件类型处理
                    switch (fileType) {
                        case 'image':
                            await handleImageUpload(file);
                            break;
                        case 'audio':
                            await handleAudioUpload(file);
                            break;
                        case 'video':
                            await handleVideoUpload(file);
                            break;
                        default:
                            alert('暂不支持该文件类型');
                    }
                }
            });

            // 文件类型检测函数
            function getFileType(file) {
                const imageTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
                const audioTypes = ['audio/mp3', 'audio/wav', 'audio/ogg', 'audio/m4a', 'audio/aac', 'audio/flac', 'audio/webm'];
                const videoTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/wmv', 'video/flv', 'video/webm', 'video/mkv'];

                if (imageTypes.includes(file.type) || file.name.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
                    return 'image';
                } else if (audioTypes.includes(file.type) || file.name.match(/\.(mp3|wav|ogg|m4a|aac|flac|webm)$/i)) {
                    return 'audio';
                } else if (videoTypes.includes(file.type) || file.name.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv)$/i)) {
                    return 'video';
                }
                return null;
            }

            // 图片上传处理函数
            async function handleImageUpload(file) {
                // 检查文件大小（4MB限制）
                if (file.size > 4 * 1024 * 1024) {
                    alert(`图片文件过大 (${(file.size / 1024 / 1024).toFixed(1)}MB)，最大支持4MB`);
                    return;
                }

                // 自动切换到多模态模型（llama）
                switchToMultimodalModel();

                // 显示上传进度
                uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-loader-4-line animate-spin"></i></div>';
                uploadAttachmentBtn.disabled = true;

                // 显示上传状态提示
                const uploadToast = showUploadToast('正在上传图片...');

                try {
                    // 使用FormData上传到后端
                    const formData = new FormData();
                    formData.append('image', file);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        selectedImage = result.image_data;
                        previewImage.src = selectedImage;
                        previewArea.classList.remove('hidden');
                        imagePreview.classList.remove('hidden');
                        updateSendButton();
                    } else {
                        alert('图片上传失败: ' + result.error);
                    }
                } catch (error) {
                    alert('图片上传失败: ' + error.message);
                } finally {
                    // 恢复上传按钮
                    uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-attachment-2"></i></div>';
                    uploadAttachmentBtn.disabled = false;
                    hideUploadToast(uploadToast);
                }
            }

            // 音频上传处理函数
            async function handleAudioUpload(file) {
                // 检查文件大小（10MB限制）
                if (file.size > 10 * 1024 * 1024) {
                    alert(`音频文件过大 (${(file.size / 1024 / 1024).toFixed(1)}MB)，最大支持10MB`);
                    return;
                }

                // 显示上传进度
                uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-loader-4-line animate-spin"></i></div>';
                uploadAttachmentBtn.disabled = true;

                const uploadToast = showUploadToast('正在上传音频...');

                try {
                    // 使用FormData上传到后端
                    const formData = new FormData();
                    formData.append('audio', file);

                    const response = await fetch('/api/upload/audio', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        selectedAudio = result.audio_data;
                        audioFileName.textContent = file.name;
                        audioFileSize.textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                        previewArea.classList.remove('hidden');
                        audioPreview.classList.remove('hidden');
                        updateSendButton();
                    } else {
                        alert('音频上传失败: ' + result.error);
                    }
                } catch (error) {
                    alert('音频上传失败: ' + error.message);
                } finally {
                    // 恢复上传按钮
                    uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-attachment-2"></i></div>';
                    uploadAttachmentBtn.disabled = false;
                    hideUploadToast(uploadToast);
                }
            }

            // 视频上传处理函数
            async function handleVideoUpload(file) {
                // 检查文件大小（50MB限制）
                if (file.size > 50 * 1024 * 1024) {
                    alert(`视频文件过大 (${(file.size / 1024 / 1024).toFixed(1)}MB)，最大支持50MB`);
                    return;
                }

                // 自动切换到多模态模型（llama）
                switchToMultimodalModel();

                // 显示上传进度
                uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-loader-4-line animate-spin"></i></div>';
                uploadAttachmentBtn.disabled = true;

                const uploadToast = showUploadToast('正在上传视频...');

                try {
                    // 使用FormData上传到后端
                    const formData = new FormData();
                    formData.append('video', file);

                    const response = await fetch('/api/upload/video', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        selectedVideo = result.video_data;
                        videoFileName.textContent = file.name;
                        videoFileSize.textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                        previewArea.classList.remove('hidden');
                        videoPreview.classList.remove('hidden');
                        updateSendButton();
                    } else {
                        alert('视频上传失败: ' + result.error);
                    }
                } catch (error) {
                    alert('视频上传失败: ' + error.message);
                } finally {
                    // 恢复上传按钮
                    uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-attachment-2"></i></div>';
                    uploadAttachmentBtn.disabled = false;
                    hideUploadToast(uploadToast);
                }
            }

            // 显示上传提示
            function showUploadToast(message) {
                const uploadToast = document.createElement('div');
                uploadToast.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                uploadToast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="spinner-loading w-4 h-4 border-white"></div>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(uploadToast);
                return uploadToast;
            }

            // 隐藏上传提示
            function hideUploadToast(uploadToast) {
                setTimeout(() => {
                    if (uploadToast && uploadToast.parentNode) {
                        uploadToast.remove();
                    }
                }, 2000);
            }

            // 自动切换到多模态模型
            function switchToMultimodalModel() {
                // 查找llama模型
                const modelSelect = document.getElementById('modelSelect');
                const llamaOption = Array.from(modelSelect.options).find(option =>
                    option.value.includes('llama') || option.value.includes('Llama')
                );

                if (llamaOption && currentModel !== llamaOption.value) {
                    const previousModel = currentModel;
                    currentModel = llamaOption.value;
                    modelSelect.value = currentModel;

                    // 显示模型切换提示
                    showModelSwitchToast(previousModel, currentModel);
                    console.log('自动切换模型:', previousModel, '->', currentModel);
                }
            }

            // 显示模型切换提示
            function showModelSwitchToast(fromModel, toModel) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="ri-refresh-line"></i>
                        <span>已自动切换到多模态模型</span>
                    </div>
                `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    if (toast && toast.parentNode) {
                        toast.remove();
                    }
                }, 3000);
            }

            // 移除预览图片
            removeImageBtn.addEventListener('click', function () {
                selectedImage = null;
                imagePreview.classList.add('hidden');
                if (!isRecording && !selectedAudio && !selectedVideo) {
                    previewArea.classList.add('hidden');
                }
                attachmentFileInput.value = '';
                updateSendButton();
            });



            // 移除音频预览
            removeAudioBtn.addEventListener('click', function () {
                selectedAudio = null;
                audioPreview.classList.add('hidden');
                if (!isRecording && !selectedImage && !selectedVideo) {
                    previewArea.classList.add('hidden');
                }
                attachmentFileInput.value = '';
                updateSendButton();
            });

            // 移除视频预览
            removeVideoBtn.addEventListener('click', function () {
                selectedVideo = null;
                videoPreview.classList.add('hidden');
                if (!isRecording && !selectedImage && !selectedAudio) {
                    previewArea.classList.add('hidden');
                }
                attachmentFileInput.value = '';
                updateSendButton();
            });

            // 语音按钮点击事件
            startVoiceBtn.addEventListener('click', async function () {
                if (!isRecording) {
                    try {
                        // 首先尝试使用浏览器语音识别API
                        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                            startSpeechRecognition();
                        } else {
                            // 回退到录音模式
                            startAudioRecording();
                        }
                    } catch (error) {
                        alert('无法访问麦克风: ' + error.message);
                        console.error('录音错误:', error);
                    }
                } else {
                    stopRecording();
                }
            });

            // 语音识别功能
            function startSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();

                recognition.lang = 'zh-CN'; // 中文
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = function () {
                    isRecording = true;
                    previewArea.classList.remove('hidden');
                    audioRecording.classList.remove('hidden');
                    console.log('开始语音识别...');
                };

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('语音识别结果:', transcript);

                    // 直接将识别结果填入输入框
                    messageInput.value = transcript;
                    messageInput.focus();

                    // 显示成功提示
                    showSuccessMessage(`🎙️ 语音识别成功！识别文字：${transcript.substring(0, 20)}${transcript.length > 20 ? '...' : ''}`);
                };

                recognition.onerror = function (event) {
                    console.error('语音识别错误:', event.error);

                    let errorMessage = '语音识别失败';
                    switch (event.error) {
                        case 'no-speech':
                            errorMessage = '没有检测到语音，请重试';
                            break;
                        case 'audio-capture':
                            errorMessage = '无法访问麦克风';
                            break;
                        case 'not-allowed':
                            errorMessage = '麦克风权限被拒绝';
                            break;
                        case 'network':
                            errorMessage = '网络错误，请检查网络连接';
                            break;
                        default:
                            errorMessage = `语音识别失败: ${event.error}`;
                    }

                    showErrorMessage(errorMessage);

                    // 回退到录音模式
                    startAudioRecording();
                };

                recognition.onend = function () {
                    isRecording = false;
                    audioRecording.classList.add('hidden');
                    if (!selectedImage && !selectedAudio && !selectedVideo) {
                        previewArea.classList.add('hidden');
                    }
                };

                recognition.start();
            }

            // 录音功能（作为语音识别的备选方案）
            function startAudioRecording() {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(function (stream) {
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = function (event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async function () {
                        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                        const reader = new FileReader();

                        reader.onload = async function () {
                            const audioData = reader.result;

                            try {
                                const response = await fetch('/api/upload/record', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        audio_data: audioData,
                                        transcribe: true,
                                        language: 'zh'
                                    })
                                });

                                const result = await response.json();

                                if (result.success) {
                                    selectedAudio = result.audio_data;
                                    audioFileName.textContent = result.file_name;
                                    audioFileSize.textContent = `${(result.file_size / 1024 / 1024).toFixed(2)} MB`;
                                    audioPreview.classList.remove('hidden');
                                    updateSendButton();

                                    // 处理语音转文字结果
                                    if (result.transcription && result.transcription.text) {
                                        const transcribedText = result.transcription.text.trim();
                                        if (transcribedText) {
                                            // 将转录的文字自动填入输入框
                                            messageInput.value = transcribedText;
                                            messageInput.focus();

                                            // 显示转录成功的提示
                                            showSuccessMessage(`🎙️ 语音转文字成功！识别文字：${transcribedText.substring(0, 20)}${transcribedText.length > 20 ? '...' : ''}`);
                                        } else {
                                            messageInput.value = '请描述这段录音的内容';
                                            messageInput.focus();
                                        }
                                    } else {
                                        // 如果转录失败，给出提示
                                        if (result.transcription_error) {
                                            console.warn('语音转文字失败:', result.transcription_error);
                                            showErrorMessage('语音转文字功能暂不可用，请手动描述录音内容');
                                        }

                                        if (!messageInput.value.trim()) {
                                            messageInput.value = '请描述这段录音的内容';
                                            messageInput.focus();
                                        }
                                    }
                                } else {
                                    alert('录音保存失败: ' + result.error);
                                }
                            } catch (error) {
                                alert('录音保存失败: ' + error.message);
                            }
                        };

                        reader.readAsDataURL(blob);

                        // 停止所有音频轨道
                        stream.getTracks().forEach(track => track.stop());
                    };

                    isRecording = true;
                    previewArea.classList.remove('hidden');
                    audioRecording.classList.remove('hidden');

                    mediaRecorder.start();
                    console.log('开始录音（备选模式）...');

                }).catch(function (error) {
                    alert('无法访问麦克风: ' + error.message);
                    console.error('录音错误:', error);
                });
            }

            // 停止录音按钮点击事件
            stopRecordingBtn.addEventListener('click', stopRecording);

            // 停止录音函数
            function stopRecording() {
                if (isRecording && mediaRecorder) {
                    isRecording = false;
                    audioRecording.classList.add('hidden');
                    if (!selectedImage && !selectedAudio && !selectedVideo) {
                        previewArea.classList.add('hidden');
                    }

                    mediaRecorder.stop();
                    console.log('停止录音...');
                }
            }

            // 清空聊天记录功能（按钮已删除，但保留函数供其他地方调用）
            function clearChat() {
                if (confirm('确定要清空当前对话吗？')) {
                    conversationHistory = [];
                    currentSessionId = null;
                    clearChatDisplay();

                    // 清空所有媒体选择
                    selectedImage = null;
                    selectedAudio = null;
                    selectedVideo = null;
                    previewArea.classList.add('hidden');
                    imagePreview.classList.add('hidden');
                    audioPreview.classList.add('hidden');
                    videoPreview.classList.add('hidden');

                    // 清空文件输入
                    attachmentFileInput.value = '';

                    // 更新会话列表中的选中状态
                    document.querySelectorAll('.session-item').forEach(item => {
                        item.classList.remove('bg-blue-50', 'border-2', 'border-blue-200');
                    });

                    updateSendButton();
                    console.log('对话历史已清空');
                }
            }

            // 将clearChat函数添加到全局作用域
            window.clearChat = clearChat;

            // 将createNewSession函数添加到全局作用域
            window.createNewSession = createNewSession;

            // 设置功能相关事件处理

            // 加载设置
            function loadSettings() {
                const savedSystemPrompt = localStorage.getItem('chatbot_system_prompt');
                const savedTemperature = localStorage.getItem('chatbot_temperature');

                if (savedSystemPrompt) {
                    systemPrompt = savedSystemPrompt;
                }

                if (savedTemperature) {
                    temperature = parseFloat(savedTemperature);
                }

                updateUIStatus();
            }

            // 保存设置
            function saveSettings() {
                localStorage.setItem('chatbot_system_prompt', systemPrompt);
                localStorage.setItem('chatbot_temperature', temperature.toString());
            }

            // 显示成功提示
            function showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successDiv.innerHTML = `<i class="ri-check-line mr-2"></i>${message}`;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 3000);
            }

            // 显示错误提示
            function showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                errorDiv.innerHTML = `<i class="ri-error-warning-line mr-2"></i>${message}`;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    if (document.body.contains(errorDiv)) {
                        document.body.removeChild(errorDiv);
                    }
                }, 5000);
            }

            // ===== System Prompt 相关事件 =====

            // 打开系统提示设置
            headerSystemPromptBtn.addEventListener('click', function () {
                systemPromptInput.value = systemPrompt;
                systemPromptModal.classList.remove('hidden');
            });

            // 关闭系统提示弹窗
            closeSystemPromptBtn.addEventListener('click', function () {
                systemPromptModal.classList.add('hidden');
            });

            // 点击弹窗背景关闭
            systemPromptModal.addEventListener('click', function (e) {
                if (e.target === systemPromptModal) {
                    systemPromptModal.classList.add('hidden');
                }
            });

            // 系统提示模板按钮
            document.querySelectorAll('.system-prompt-template').forEach(btn => {
                btn.addEventListener('click', function () {
                    const template = this.dataset.template;
                    systemPromptInput.value = template;
                });
            });

            // 清空系统提示
            clearSystemPromptBtn.addEventListener('click', function () {
                systemPromptInput.value = '';
            });

            // 保存系统提示
            saveSystemPromptBtn.addEventListener('click', function () {
                systemPrompt = systemPromptInput.value.trim();
                saveSettings();
                updateUIStatus();
                systemPromptModal.classList.add('hidden');
                showSuccessMessage('系统提示已保存');
            });

            // ===== Temperature 相关事件 =====

            // 打开温度设置
            headerTemperatureBtn.addEventListener('click', function () {
                temperatureSlider.value = temperature;
                temperatureValue.textContent = temperature;
                temperatureModal.classList.remove('hidden');
            });

            // 关闭温度弹窗
            closeTemperatureBtn.addEventListener('click', function () {
                temperatureModal.classList.add('hidden');
            });

            // 点击弹窗背景关闭
            temperatureModal.addEventListener('click', function (e) {
                if (e.target === temperatureModal) {
                    temperatureModal.classList.add('hidden');
                }
            });

            // Temperature滑块变化事件
            temperatureSlider.addEventListener('input', function () {
                const value = parseFloat(this.value);
                temperatureValue.textContent = value;
            });

            // 温度预设按钮
            document.querySelectorAll('.temperature-preset').forEach(btn => {
                btn.addEventListener('click', function () {
                    const temp = parseFloat(this.dataset.temp);
                    temperatureSlider.value = temp;
                    temperatureValue.textContent = temp;
                });
            });

            // 保存温度设置
            saveTemperatureBtn.addEventListener('click', function () {
                temperature = parseFloat(temperatureSlider.value);
                saveSettings();
                updateUIStatus();
                temperatureModal.classList.add('hidden');
                showSuccessMessage('创造性设置已保存');
            });

            // 页面加载时加载设置
            loadSettings();

            // 初始化
            messageInput.focus();
            updateSendButton();

            // 添加联网搜索功能
            async function performWebSearch(query) {
                const loadingDiv = showLoadingState(LoadingType.SEARCH, `正在搜索: ${query}`);

                try {
                    const response = await fetch('/api/search/web', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: query,
                            count: 5,
                            include_images: true,
                            format_for_ai: true
                        })
                    });

                    const data = await response.json();
                    hideLoadingState(loadingDiv);

                    if (data.success) {
                        const searchDiv = document.createElement('div');
                        searchDiv.className = 'flex mb-4';

                        const typeIndicator = createTypeIndicator(MessageType.SEARCH);

                        let searchHTML = `
                            <div class="message-bubble bot-message message-type-search p-3">
                                <div class="message-content-group">
                                    ${typeIndicator}
                                    <div class="search-indicator">
                                        <span>🌐</span>
                                        <span>搜索结果 (${data.search_provider})</span>
                                    </div>
                                    <div class="search-results">
                        `;

                        data.results.forEach((result, index) => {
                            searchHTML += `
                                <div class="search-result-item">
                                    <div class="search-result-title">${result.title}</div>
                                    <a href="${result.url}" target="_blank" class="search-result-url">${result.url}</a>
                                    <div class="search-result-snippet">${result.snippet || result.summary}</div>
                                </div>
                            `;
                        });

                        if (data.images && data.images.length > 0) {
                            searchHTML += `
                                <div style="margin-top: 15px;">
                                    <strong>🖼️ 相关图片:</strong>
                                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            `;
                            data.images.slice(0, 3).forEach(img => {
                                searchHTML += `
                                    <img src="${img.thumbnailUrl}" 
                                         alt="${img.name}" 
                                         style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                                         onclick="window.open('${img.contentUrl}', '_blank')">
                                `;
                            });
                            searchHTML += `</div></div>`;
                        }

                        searchHTML += `
                                    </div>
                                </div>
                            </div>`;
                        searchDiv.innerHTML = searchHTML;
                        chatContainer.appendChild(searchDiv);
                        scrollToBottom();

                        return data;
                    } else {
                        throw new Error(data.error || '搜索失败');
                    }
                } catch (error) {
                    hideLoadingState(loadingDiv);
                    showErrorMessage('搜索失败: ' + error.message);
                    return null;
                }
            }

            // ===== 新的加载状态管理系统 =====

            // 加载状态类型枚举
            const LoadingType = {
                CHAT: 'chat',
                SEARCH: 'search',
                IMAGE: 'image',
                UPLOAD: 'upload'
            };

            // 创建骨架屏
            function createMessageSkeleton() {
                const skeletonDiv = document.createElement('div');
                skeletonDiv.className = 'message bot-message';
                skeletonDiv.innerHTML = `
                    <div class="message-skeleton">
                        <div class="skeleton-header">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="skeleton skeleton-title"></div>
                        </div>
                        <div class="skeleton skeleton-line long"></div>
                        <div class="skeleton skeleton-line medium"></div>
                        <div class="skeleton skeleton-line short"></div>
                        <div class="skeleton skeleton-line extra-short"></div>
                    </div>
                `;
                return skeletonDiv;
            }

            // 创建现代加载指示器
            function createModernLoading(type = LoadingType.CHAT, message = '正在思考...') {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message';

                let specialClass = '';
                let iconContent = '🤖';

                switch (type) {
                    case LoadingType.SEARCH:
                        specialClass = 'search-loading';
                        iconContent = '🔍';
                        break;
                    case LoadingType.IMAGE:
                        specialClass = 'image-processing-loading';
                        iconContent = '🖼️';
                        break;
                    case LoadingType.UPLOAD:
                        specialClass = '';
                        iconContent = '📤';
                        break;
                }

                loadingDiv.innerHTML = `
                    <div class="modern-loading-indicator ${specialClass}">
                        <div class="loading-icon">
                            <span style="font-size: 12px;">${iconContent}</span>
                        </div>
                        <div class="loading-text">${message}</div>
                        <div class="wave-loading">
                            <div class="wave-dot"></div>
                            <div class="wave-dot"></div>
                            <div class="wave-dot"></div>
                        </div>
                    </div>
                `;

                return loadingDiv;
            }

            // 创建简单的spinner加载
            function createSpinnerLoading(message = '加载中...') {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message';
                loadingDiv.innerHTML = `
                    <div class="modern-loading-indicator">
                        <div class="spinner-loading"></div>
                        <div class="loading-text">${message}</div>
                    </div>
                `;
                return loadingDiv;
            }

            // 显示加载状态
            function showLoadingState(type = LoadingType.CHAT, message = '正在处理...', useSkeleton = false) {
                let loadingElement;

                if (useSkeleton) {
                    loadingElement = createMessageSkeleton();
                } else {
                    loadingElement = createModernLoading(type, message);
                }

                // 添加到聊天容器
                chatContainer.appendChild(loadingElement);
                scrollToBottom();

                return loadingElement;
            }

            // 隐藏加载状态（带动画）
            function hideLoadingState(loadingElement) {
                if (loadingElement && loadingElement.parentNode) {
                    // 添加退出动画
                    loadingElement.classList.add('loading-exit');

                    // 动画完成后移除元素
                    setTimeout(() => {
                        if (loadingElement.parentNode) {
                            loadingElement.parentNode.removeChild(loadingElement);
                        }
                    }, 300);
                }
            }

            // 更新加载状态消息
            function updateLoadingMessage(loadingElement, newMessage) {
                if (loadingElement) {
                    const loadingText = loadingElement.querySelector('.loading-text');
                    if (loadingText) {
                        loadingText.textContent = newMessage;
                    }
                }
            }

            // 创建会话列表骨架屏
            function createSessionSkeleton() {
                const skeletonDiv = document.createElement('div');
                skeletonDiv.className = 'session-skeleton p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-50';
                skeletonDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="skeleton skeleton-line short mb-2"></div>
                            <div class="skeleton skeleton-line extra-short"></div>
                        </div>
                        <div class="skeleton skeleton-avatar w-6 h-6"></div>
                    </div>
                `;
                return skeletonDiv;
            }

            // 显示会话列表加载状态
            function showSessionsLoading() {
                const sessionsList = document.getElementById('sessionsList');
                if (sessionsList) {
                    // 清空现有会话
                    sessionsList.innerHTML = '';

                    // 添加多个骨架屏项目
                    for (let i = 0; i < 5; i++) {
                        sessionsList.appendChild(createSessionSkeleton());
                    }
                }
            }

            // 创建Toast通知系统
            function showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                const bgColor = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                }[type] || 'bg-blue-500';

                const icon = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                }[type] || 'ℹ️';

                toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${icon}</span>
                        <span>${message}</span>
                    </div>
                `;

                document.body.appendChild(toast);

                // 动画显示
                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                }, 10);

                // 自动隐藏
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }, duration);

                return toast;
            }

            // 全局Loading管理器
            class LoadingManager {
                constructor() {
                    this.activeLoadings = new Set();
                    this.loadingCounter = 0;
                }

                // 开始loading
                startLoading(id = null) {
                    const loadingId = id || `loading_${++this.loadingCounter}`;
                    this.activeLoadings.add(loadingId);
                    this.updateGlobalLoadingState();
                    return loadingId;
                }

                // 结束loading
                endLoading(loadingId) {
                    this.activeLoadings.delete(loadingId);
                    this.updateGlobalLoadingState();
                }

                // 更新全局loading状态
                updateGlobalLoadingState() {
                    const hasActiveLoading = this.activeLoadings.size > 0;
                    document.body.classList.toggle('loading-active', hasActiveLoading);

                    // 可以在这里添加全局loading指示器
                    const globalSpinner = document.getElementById('globalSpinner');
                    if (globalSpinner) {
                        globalSpinner.style.display = hasActiveLoading ? 'block' : 'none';
                    }
                }

                // 检查是否有活跃的loading
                hasActiveLoading() {
                    return this.activeLoadings.size > 0;
                }
            }

            // 初始化全局Loading管理器
            const loadingManager = new LoadingManager();

            // ===== 消息类型识别和样式管理系统 =====

            // 消息类型枚举
            const MessageType = {
                TEXT: 'text',
                IMAGE: 'image',
                AUDIO: 'audio',
                VIDEO: 'video',
                MIXED: 'mixed',
                ANALYSIS: 'analysis',
                SEARCH: 'search'
            };

            // 检测消息类型
            function detectMessageType(message) {
                const hasText = message.text && message.text.trim();
                const hasImage = message.image;
                const hasAudio = message.audio;
                const hasVideo = message.video;

                const mediaCount = (hasImage ? 1 : 0) + (hasAudio ? 1 : 0) + (hasVideo ? 1 : 0);

                if (mediaCount > 1 || (mediaCount === 1 && hasText)) {
                    return MessageType.MIXED;
                } else if (hasImage) {
                    return MessageType.IMAGE;
                } else if (hasAudio) {
                    return MessageType.AUDIO;
                } else if (hasVideo) {
                    return MessageType.VIDEO;
                } else {
                    return MessageType.TEXT;
                }
            }

            // 检测Bot回复类型
            function detectBotResponseType(text, context = {}) {
                if (context.isSearch || text.includes('搜索') || text.includes('查找')) {
                    return MessageType.SEARCH;
                }
                if (context.isAnalysis || text.includes('分析') || text.includes('解释') || text.includes('识别')) {
                    return MessageType.ANALYSIS;
                }
                return MessageType.TEXT;
            }

            // 创建消息类型指示器
            function createTypeIndicator(type) {
                const indicators = {
                    [MessageType.TEXT]: { icon: '💬', label: '文本', class: 'type-indicator-text' },
                    [MessageType.IMAGE]: { icon: '🖼️', label: '图片', class: 'type-indicator-image' },
                    [MessageType.AUDIO]: { icon: '🎵', label: '音频', class: 'type-indicator-audio' },
                    [MessageType.VIDEO]: { icon: '🎬', label: '视频', class: 'type-indicator-video' },
                    [MessageType.MIXED]: { icon: '📎', label: '多媒体', class: 'type-indicator-mixed' },
                    [MessageType.ANALYSIS]: { icon: '🤖', label: '智能分析', class: 'type-indicator-text' },
                    [MessageType.SEARCH]: { icon: '🔍', label: '搜索结果', class: 'type-indicator-text' }
                };

                const indicator = indicators[type];
                if (!indicator) return '';

                return `<div class="message-type-indicator ${indicator.class}">
                    <span>${indicator.icon}</span>
                    <span>${indicator.label}</span>
                </div>`;
            }

            // 创建增强的媒体容器
            function createMediaContainer(message) {
                let mediaHTML = '';

                if (message.image) {
                    mediaHTML += `
                        <div class="media-container">
                            <div class="image-container">
                                <img src="${message.image}" alt="用户上传的图片" loading="lazy">
                            </div>
                        </div>
                    `;
                }

                if (message.audio) {
                    mediaHTML += `
                        <div class="media-container">
                            <div class="audio-container">
                                <div class="audio-icon">
                                    <i class="ri-music-line"></i>
                                </div>
                                <div class="audio-info">
                                    <div class="audio-title">音频文件</div>
                                    <audio controls class="audio-controls">
                                        <source src="${message.audio}" type="audio/webm">
                                        <source src="${message.audio}" type="audio/mp3">
                                        您的浏览器不支持音频播放
                                    </audio>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (message.video) {
                    mediaHTML += `
                        <div class="media-container">
                            <div class="video-container">
                                <div class="video-header">
                                    <div class="video-icon">
                                        <i class="ri-video-line"></i>
                                    </div>
                                    <div class="video-title">视频文件</div>
                                </div>
                                <video controls class="video-controls">
                                    <source src="${message.video}" type="video/mp4">
                                    <source src="${message.video}" type="video/webm">
                                    您的浏览器不支持视频播放
                                </video>
                            </div>
                        </div>
                    `;
                }

                return mediaHTML;
            }

            // 创建类型化消息
            function createTypedMessage(message, isUser = true, context = {}) {
                const messageType = isUser ? detectMessageType(message) : detectBotResponseType(message.text || '', context);
                const typeClass = `message-type-${messageType}`;
                const roleClass = isUser ? 'user-message' : 'bot-message';

                let contentHTML = '';

                // 添加类型指示器（可选）
                if (context.showTypeIndicator !== false) {
                    contentHTML += createTypeIndicator(messageType);
                }

                // 添加文本内容
                if (message.text && message.text.trim()) {
                    contentHTML += `<div class="text-content">${message.text}</div>`;
                }

                // 添加媒体内容
                if (isUser && (message.image || message.audio || message.video)) {
                    contentHTML += `<div class="media-content">${createMediaContainer(message)}</div>`;
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isUser ? 'justify-end' : ''} mb-4`;

                messageDiv.innerHTML = `
                    <div class="message-bubble ${roleClass} ${typeClass} p-3">
                        <div class="message-content-group">
                            ${contentHTML}
                        </div>
                    </div>
                `;

                return messageDiv;
            }

            // 更新现有消息的类型样式
            function updateMessageType(messageElement, type) {
                const bubble = messageElement.querySelector('.message-bubble');
                if (bubble) {
                    // 移除现有类型类
                    bubble.classList.remove(
                        'message-type-text',
                        'message-type-image',
                        'message-type-audio',
                        'message-type-video',
                        'message-type-mixed',
                        'message-type-analysis',
                        'message-type-search'
                    );

                    // 添加新类型类
                    bubble.classList.add(`message-type-${type}`);
                }
            }

            // 批量更新消息样式
            function refreshMessageStyles() {
                const messages = chatContainer.querySelectorAll('.message-bubble');
                messages.forEach(bubble => {
                    // 触发重新渲染动画
                    bubble.style.animation = 'none';
                    bubble.offsetHeight; // 触发重排
                    bubble.style.animation = 'messageSlideIn 0.3s ease-out';
                });
            }

            // 演示不同消息类型的功能（开发调试用）
            function demoMessageTypes() {
                if (confirm('是否要展示不同类型消息的效果？这将清空当前聊天记录。')) {
                    chatContainer.innerHTML = '';

                    // 纯文本消息
                    const textMessage = createTypedMessage({ text: '这是一条普通的文本消息' }, true);
                    chatContainer.appendChild(textMessage);

                    // 图片消息（模拟）
                    const imageMessage = createTypedMessage({
                        text: '我发送了一张图片',
                        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="100"><rect width="200" height="100" fill="%23e2e8f0"/><text x="100" y="55" text-anchor="middle" fill="%236b7280">示例图片</text></svg>'
                    }, true);
                    chatContainer.appendChild(imageMessage);

                    // 混合消息（模拟）
                    const mixedMessage = createTypedMessage({
                        text: '这是包含图片和文字的混合消息',
                        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="80"><rect width="150" height="80" fill="%23ddd6fe"/><text x="75" y="45" text-anchor="middle" fill="%235b21b6">混合内容</text></svg>'
                    }, true);
                    chatContainer.appendChild(mixedMessage);

                    // Bot回复 - 普通文本
                    const botTextMessage = createTypedMessage({
                        text: '这是机器人的普通文本回复，包含一些有用的信息。'
                    }, false, { showTypeIndicator: true });
                    chatContainer.appendChild(botTextMessage);

                    // Bot回复 - 分析类型
                    const analysisMessage = createTypedMessage({
                        text: '这是一个智能分析回复。我已经分析了您上传的图片内容，发现了以下信息...'
                    }, false, {
                        showTypeIndicator: true,
                        isAnalysis: true
                    });
                    chatContainer.appendChild(analysisMessage);

                    // Bot回复 - 搜索类型
                    const searchMessage = createTypedMessage({
                        text: '根据最新搜索结果，我找到了相关信息。这里是综合多个来源的回答...'
                    }, false, {
                        showTypeIndicator: true,
                        isSearch: true
                    });
                    chatContainer.appendChild(searchMessage);

                    scrollToBottom();
                    showToast('已展示不同类型的消息样式！', 'success');
                }
            }

            // 在控制台中暴露演示函数（开发用）
            window.demoMessageTypes = demoMessageTypes;

            // 格式化消息文本
            function formatMessage(text) {
                // 简单的格式化，支持换行
                return text.replace(/\n/g, '<br>');
            }

            // 添加消息到聊天容器（简化版，主要用于纯文本）
            function addMessage(text, role) {
                const message = { text: text };
                const isUser = role === 'user';
                const messageDiv = createTypedMessage(message, isUser, { showTypeIndicator: false });

                chatContainer.appendChild(messageDiv);
                scrollToBottom();
            }

            // 带搜索的智能对话
            async function chatWithSearch(message) {
                const enableSearch = document.getElementById('enableSearch').checked;
                const model = document.getElementById('modelSelect').value;

                if (!enableSearch) {
                    return await sendMessage(message);
                }

                const loadingDiv = showLoadingState(LoadingType.SEARCH, '正在思考并搜索...');

                try {
                    const response = await fetch('/api/chat/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            model: model,
                            auto_search: true,
                            session_id: currentSessionId || 'default'
                        })
                    });

                    const data = await response.json();
                    hideLoadingState(loadingDiv);

                    if (data.success) {
                        // 检测回复类型
                        const context = {
                            isSearch: data.search_performed,
                            showTypeIndicator: true
                        };

                        const botMessageType = detectBotResponseType(data.response, context);
                        const typeIndicator = createTypeIndicator(botMessageType);

                        const responseDiv = document.createElement('div');
                        responseDiv.className = 'flex mb-4';

                        let responseHTML = `
                            <div class="message-bubble bot-message message-type-${botMessageType} p-3">
                                <div class="message-content-group">
                                    ${typeIndicator}
                        `;

                        if (data.search_performed && data.search_results && data.search_results.success) {
                            responseHTML += `
                                    <div class="search-indicator">
                                        <span>🔍</span>
                                        <span>已搜索最新信息</span>
                                    </div>
                            `;
                        }

                        responseHTML += `
                                    <div class="text-content">${formatMessage(data.response)}</div>
                        `;

                        if (data.model_used) {
                            responseHTML += `
                                    <div class="model-indicator">模型: ${data.model_used}</div>
                            `;
                        }

                        responseHTML += `
                                </div>
                            </div>`;

                        responseDiv.innerHTML = responseHTML;
                        chatContainer.appendChild(responseDiv);
                        scrollToBottom();

                        return data;
                    } else {
                        throw new Error(data.error || '对话失败');
                    }
                } catch (error) {
                    hideLoadingState(loadingDiv);
                    showErrorMessage('智能对话失败: ' + error.message);
                    return null;
                }
            }

            // 事件监听器
            sendMessageBtn.addEventListener('click', () => {
                const message = messageInput.value.trim();
                if (message) {
                    addMessage(message, 'user');
                    messageInput.value = '';
                    // 使用带搜索的智能对话
                    chatWithSearch(message);
                    updateSendButton();
                }
            });





            // 联网搜索开关状态管理
            const enableSearchCheckbox = document.getElementById('enableSearch');
            const searchStatusIcon = document.querySelector('.search-status-icon');
            const searchControls = document.querySelector('.search-controls-inline');

            function updateSearchStatus() {
                if (enableSearchCheckbox.checked) {
                    searchStatusIcon.textContent = '🌐';
                    searchStatusIcon.title = '智能联网已开启';
                    searchControls.style.borderColor = 'rgba(102, 126, 234, 0.3)';
                    searchControls.style.background = 'rgba(102, 126, 234, 0.1)';
                } else {
                    searchStatusIcon.textContent = '🔌';
                    searchStatusIcon.title = '离线模式';
                    searchControls.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                    searchControls.style.background = 'rgba(0, 0, 0, 0.05)';
                }
            }

            enableSearchCheckbox.addEventListener('change', updateSearchStatus);

            // 初始化状态
            updateSearchStatus();
        });
    </script>

    <script id="textareaAutoResize">
        document.addEventListener('DOMContentLoaded', function () {
            const messageInput = document.getElementById('messageInput');

            // 自动调整文本框高度的函数
            function adjustTextareaHeight() {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            }

            // 监听输入事件
            messageInput.addEventListener('input', adjustTextareaHeight);

            // 初始化
            adjustTextareaHeight();
        });
    </script>

    <script id="enhancedFeatures">
        document.addEventListener('DOMContentLoaded', function () {
            // 主题和个性化设置管理
            class ThemeManager {
                constructor() {
                    this.settingsKey = 'chatbot-settings';
                    this.currentTheme = 'light';
                    this.settings = {
                        theme: 'light',
                        fontSize: 16,
                        bubbleRadius: 18,
                        customColors: {
                            primary: '#1E88E5',
                            userBubble: '#E8E8E8',
                            botBubble: '#E3F2FD'
                        }
                    };
                    this.loadSettings();
                    this.initializeEventListeners();
                    this.applySettings();
                }

                loadSettings() {
                    const saved = localStorage.getItem(this.settingsKey);
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                    this.currentTheme = this.settings.theme;
                }

                saveSettings() {
                    localStorage.setItem(this.settingsKey, JSON.stringify(this.settings));
                }

                applySettings() {
                    // 应用主题
                    document.documentElement.setAttribute('data-theme', this.currentTheme);

                    // 应用字体大小
                    document.documentElement.style.setProperty('--chat-font-size', `${this.settings.fontSize}px`);

                    // 应用气泡圆角
                    document.documentElement.style.setProperty('--bubble-radius', `${this.settings.bubbleRadius}px`);

                    // 应用自定义颜色
                    if (this.currentTheme === 'custom') {
                        document.documentElement.style.setProperty('--primary-color', this.settings.customColors.primary);
                        document.documentElement.style.setProperty('--user-bubble-color', this.settings.customColors.userBubble);
                        document.documentElement.style.setProperty('--bot-bubble-color', this.settings.customColors.botBubble);
                    }

                    // 更新UI控件
                    this.updateUIControls();
                }

                updateUIControls() {
                    // 更新主题选择器
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.classList.toggle('active', option.dataset.theme === this.currentTheme);
                    });

                    // 更新滑块值
                    const fontSizeSlider = document.getElementById('fontSizeSlider');
                    const bubbleRadiusSlider = document.getElementById('bubbleRadiusSlider');

                    if (fontSizeSlider) fontSizeSlider.value = this.settings.fontSize;
                    if (bubbleRadiusSlider) bubbleRadiusSlider.value = this.settings.bubbleRadius;

                    // 更新显示值
                    document.getElementById('fontSizeValue').textContent = `${this.settings.fontSize}px`;
                    document.getElementById('bubbleRadiusValue').textContent = `${this.settings.bubbleRadius}px`;

                    // 更新颜色选择器
                    document.getElementById('primaryColorPicker').value = this.settings.customColors.primary;
                    document.getElementById('userBubbleColorPicker').value = this.settings.customColors.userBubble;
                    document.getElementById('botBubbleColorPicker').value = this.settings.customColors.botBubble;

                    // 更新主题按钮图标
                    const themeIcon = document.getElementById('themeIcon');
                    if (themeIcon) {
                        themeIcon.className = this.currentTheme === 'dark' ? 'ri-moon-line' : 'ri-sun-line';
                    }

                    // 显示/隐藏自定义颜色区域
                    const customColorsSection = document.getElementById('customColorsSection');
                    if (customColorsSection) {
                        customColorsSection.style.display = this.currentTheme === 'custom' ? 'block' : 'none';
                    }
                }

                setTheme(theme) {
                    this.currentTheme = theme;
                    this.settings.theme = theme;
                    this.applySettings();
                    this.saveSettings();
                }

                setFontSize(size) {
                    this.settings.fontSize = size;
                    this.applySettings();
                    this.saveSettings();
                }

                setBubbleRadius(radius) {
                    this.settings.bubbleRadius = radius;
                    this.applySettings();
                    this.saveSettings();
                }

                setCustomColor(type, color) {
                    this.settings.customColors[type] = color;
                    if (this.currentTheme === 'custom') {
                        this.applySettings();
                    }
                    this.saveSettings();
                }

                resetSettings() {
                    this.settings = {
                        theme: 'light',
                        fontSize: 16,
                        bubbleRadius: 18,
                        customColors: {
                            primary: '#1E88E5',
                            userBubble: '#E8E8E8',
                            botBubble: '#E3F2FD'
                        }
                    };
                    this.currentTheme = 'light';
                    this.applySettings();
                    this.saveSettings();
                }

                toggleTheme() {
                    const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                }

                initializeEventListeners() {
                    // 主题切换按钮 (已删除，但保留功能)
                    // const themeToggle = document.getElementById('themeToggle');
                    // if (themeToggle) {
                    //     themeToggle.addEventListener('click', () => this.toggleTheme());
                    // }

                    // 主题选择器
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.addEventListener('click', () => {
                            this.setTheme(option.dataset.theme);
                        });
                    });

                    // 字体大小滑块
                    const fontSizeSlider = document.getElementById('fontSizeSlider');
                    if (fontSizeSlider) {
                        fontSizeSlider.addEventListener('input', (e) => {
                            this.setFontSize(parseInt(e.target.value));
                        });
                    }

                    // 气泡圆角滑块
                    const bubbleRadiusSlider = document.getElementById('bubbleRadiusSlider');
                    if (bubbleRadiusSlider) {
                        bubbleRadiusSlider.addEventListener('input', (e) => {
                            this.setBubbleRadius(parseInt(e.target.value));
                        });
                    }

                    // 自定义颜色选择器
                    document.getElementById('primaryColorPicker').addEventListener('change', (e) => {
                        this.setCustomColor('primary', e.target.value);
                    });

                    document.getElementById('userBubbleColorPicker').addEventListener('change', (e) => {
                        this.setCustomColor('userBubble', e.target.value);
                    });

                    document.getElementById('botBubbleColorPicker').addEventListener('change', (e) => {
                        this.setCustomColor('botBubble', e.target.value);
                    });

                    // 重置设置按钮
                    const resetBtn = document.getElementById('resetSettingsBtn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            if (confirm('确定要重置所有设置吗？')) {
                                this.resetSettings();
                            }
                        });
                    }
                }
            }

            // 设置面板管理
            class SettingsPanel {
                constructor() {
                    this.panel = document.getElementById('settingsPanel');
                    this.isOpen = false;
                    this.initializeEventListeners();
                }

                open() {
                    this.panel.classList.add('open');
                    this.isOpen = true;
                    document.body.style.overflow = 'hidden';
                }

                close() {
                    this.panel.classList.remove('open');
                    this.isOpen = false;
                    document.body.style.overflow = '';
                }

                toggle() {
                    if (this.isOpen) {
                        this.close();
                    } else {
                        this.open();
                    }
                }

                initializeEventListeners() {
                    // 设置按钮 (已删除，但保留功能)
                    // const settingsToggle = document.getElementById('settingsToggle');
                    // if (settingsToggle) {
                    //     settingsToggle.addEventListener('click', () => this.toggle());
                    // }

                    // 快捷操作栏设置按钮
                    const quickSettingsBtn = document.getElementById('quickSettingsBtn');
                    if (quickSettingsBtn) {
                        quickSettingsBtn.addEventListener('click', () => this.open());
                    }

                    const mobileQuickSettingsBtn = document.getElementById('mobileQuickSettingsBtn');
                    if (mobileQuickSettingsBtn) {
                        mobileQuickSettingsBtn.addEventListener('click', () => this.open());
                    }

                    // 关闭按钮
                    const closeBtn = document.getElementById('closeSettingsBtn');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => this.close());
                    }

                    // 点击面板外部关闭
                    this.panel.addEventListener('click', (e) => {
                        if (e.target === this.panel) {
                            this.close();
                        }
                    });

                    // ESC键关闭
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.isOpen) {
                            this.close();
                        }
                    });
                }
            }

            // 导出功能管理
            class ExportManager {
                constructor() {
                    this.initializeEventListeners();
                }

                getCurrentMessages() {
                    const messages = [];
                    const chatContainer = document.getElementById('chatContainer');
                    const messageElements = chatContainer.querySelectorAll('.message-bubble');

                    messageElements.forEach((element, index) => {
                        const isUser = element.classList.contains('user-message');
                        const text = element.textContent || element.innerText;

                        messages.push({
                            role: isUser ? 'user' : 'assistant',
                            content: text.trim(),
                            timestamp: new Date().toISOString()
                        });
                    });

                    return messages;
                }

                exportAsTxt() {
                    const messages = this.getCurrentMessages();
                    let content = `聊天记录导出\n导出时间: ${new Date().toLocaleString()}\n\n`;

                    messages.forEach((msg, index) => {
                        const sender = msg.role === 'user' ? '用户' : 'AI助手';
                        content += `${sender}: ${msg.content}\n\n`;
                    });

                    this.downloadFile(content, 'chat-export.txt', 'text/plain');
                }

                exportAsJson() {
                    const messages = this.getCurrentMessages();
                    const exportData = {
                        title: '聊天记录',
                        exportTime: new Date().toISOString(),
                        messages: messages
                    };

                    const content = JSON.stringify(exportData, null, 2);
                    this.downloadFile(content, 'chat-export.json', 'application/json');
                }

                exportAsMarkdown() {
                    const messages = this.getCurrentMessages();
                    let content = `# 聊天记录\n\n**导出时间:** ${new Date().toLocaleString()}\n\n---\n\n`;

                    messages.forEach((msg, index) => {
                        const sender = msg.role === 'user' ? '👤 **用户**' : '🤖 **AI助手**';
                        content += `${sender}\n\n${msg.content}\n\n---\n\n`;
                    });

                    this.downloadFile(content, 'chat-export.md', 'text/markdown');
                }

                exportAsPdf() {
                    // 简化版PDF导出（使用浏览器打印功能）
                    const messages = this.getCurrentMessages();
                    const printWindow = window.open('', '_blank');

                    let htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>聊天记录</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                                .message { margin-bottom: 20px; padding: 10px; border-radius: 8px; }
                                .user { background-color: #e3f2fd; text-align: right; }
                                .assistant { background-color: #f5f5f5; }
                                .sender { font-weight: bold; margin-bottom: 5px; }
                                @media print { body { margin: 0; } }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>聊天记录</h1>
                                <p>导出时间: ${new Date().toLocaleString()}</p>
                            </div>
                    `;

                    messages.forEach(msg => {
                        const className = msg.role === 'user' ? 'user' : 'assistant';
                        const sender = msg.role === 'user' ? '用户' : 'AI助手';
                        htmlContent += `
                            <div class="message ${className}">
                                <div class="sender">${sender}</div>
                                <div>${msg.content.replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    });

                    htmlContent += '</body></html>';

                    printWindow.document.write(htmlContent);
                    printWindow.document.close();

                    setTimeout(() => {
                        printWindow.print();
                    }, 1000);
                }

                downloadFile(content, filename, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }

                initializeEventListeners() {
                    // 导出按钮事件
                    const exportTxtBtn = document.getElementById('exportTxtBtn');
                    if (exportTxtBtn) {
                        exportTxtBtn.addEventListener('click', () => this.exportAsTxt());
                    }

                    const exportJsonBtn = document.getElementById('exportJsonBtn');
                    if (exportJsonBtn) {
                        exportJsonBtn.addEventListener('click', () => this.exportAsJson());
                    }

                    const exportMarkdownBtn = document.getElementById('exportMarkdownBtn');
                    if (exportMarkdownBtn) {
                        exportMarkdownBtn.addEventListener('click', () => this.exportAsMarkdown());
                    }

                    const exportPdfBtn = document.getElementById('exportPdfBtn');
                    if (exportPdfBtn) {
                        exportPdfBtn.addEventListener('click', () => this.exportAsPdf());
                    }

                    // 快捷导出按钮
                    const quickExportBtn = document.getElementById('quickExportBtn');
                    if (quickExportBtn) {
                        quickExportBtn.addEventListener('click', () => this.exportAsMarkdown());
                    }

                    const mobileQuickExportBtn = document.getElementById('mobileQuickExportBtn');
                    if (mobileQuickExportBtn) {
                        mobileQuickExportBtn.addEventListener('click', () => this.exportAsMarkdown());
                    }
                }
            }

            // 快捷操作管理
            class QuickActionsManager {
                constructor() {
                    this.initializeEventListeners();
                }

                scrollToTop() {
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
                }

                scrollToBottom() {
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
                }

                clearChat() {
                    // 直接调用清空聊天功能
                    if (confirm('确定要清空当前对话吗？')) {
                        // 调用全局的清空函数
                        window.clearChat();
                    }
                }

                newChat() {
                    // 直接调用新建对话功能
                    if (typeof window.createNewSession === 'function') {
                        window.createNewSession();
                    } else {
                        console.error('createNewSession function not available');
                    }
                }

                initializeEventListeners() {
                    // 桌面端快捷操作
                    const quickClearBtn = document.getElementById('quickClearBtn');
                    if (quickClearBtn) {
                        quickClearBtn.addEventListener('click', () => this.clearChat());
                    }

                    // 输入区域顶部的新对话按钮
                    const newChatButton = document.getElementById('newChatButton');
                    if (newChatButton) {
                        newChatButton.addEventListener('click', () => this.newChat());
                    }

                    const quickScrollTopBtn = document.getElementById('quickScrollTopBtn');
                    if (quickScrollTopBtn) {
                        quickScrollTopBtn.addEventListener('click', () => this.scrollToTop());
                    }

                    const quickScrollBottomBtn = document.getElementById('quickScrollBottomBtn');
                    if (quickScrollBottomBtn) {
                        quickScrollBottomBtn.addEventListener('click', () => this.scrollToBottom());
                    }

                    // 移动端快捷操作
                    const mobileScrollTopBtn = document.getElementById('mobileScrollTopBtn');
                    if (mobileScrollTopBtn) {
                        mobileScrollTopBtn.addEventListener('click', () => this.scrollToTop());
                    }

                    // 键盘快捷键
                    document.addEventListener('keydown', (e) => {
                        // Ctrl/Cmd + E 导出
                        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                            e.preventDefault();
                            const exportManager = new ExportManager();
                            exportManager.exportAsMarkdown();
                        }

                        // Ctrl/Cmd + L 清空对话
                        if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                            e.preventDefault();
                            this.clearChat();
                        }

                        // Ctrl/Cmd + N 新对话
                        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                            e.preventDefault();
                            this.newChat();
                        }

                        // Ctrl/Cmd + , 打开设置
                        if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                            e.preventDefault();
                            const settingsPanel = new SettingsPanel();
                            settingsPanel.open();
                        }
                    });
                }
            }

            // 初始化所有功能
            const themeManager = new ThemeManager();
            const settingsPanel = new SettingsPanel();
            const exportManager = new ExportManager();
            const quickActionsManager = new QuickActionsManager();

            // 全局访问
            window.themeManager = themeManager;
            window.settingsPanel = settingsPanel;
            window.exportManager = exportManager;
            window.quickActionsManager = quickActionsManager;

            console.log('界面优化功能已加载完成！');
        });
    </script>
</body>

</html>

</html>