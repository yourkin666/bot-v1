<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ¨¡æ€æ™ºèƒ½åŠ©æ‰‹ - SiliconFlow & Groq</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>

    <!-- Markdownæ¸²æŸ“ç›¸å…³ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-shell.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-xml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-html.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markdown.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css">

    <!-- æ•°å­¦å…¬å¼æ”¯æŒ -->
    <script>
        // ä¼˜åŒ–çš„MathJaxé…ç½® - å¹³è¡¡åŠŸèƒ½æ€§å’Œå¯é æ€§
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: { '[+]': ['base', 'ams', 'newcommand', 'configmacros', 'action', 'unicode'] },
                macros: {
                    // å¸¸ç”¨æ•°å­¦é›†åˆ
                    RR: "{\\mathbb{R}}",
                    CC: "{\\mathbb{C}}",
                    NN: "{\\mathbb{N}}",
                    ZZ: "{\\mathbb{Z}}",
                    QQ: "{\\mathbb{Q}}",
                    // å¸¸ç”¨å‡½æ•°
                    d: "{\\mathrm{d}}",
                    e: "{\\mathrm{e}}",
                    i: "{\\mathrm{i}}",
                    // å‘é‡å’ŒèŒƒæ•°
                    vec: ["\\mathbf{#1}", 1],
                    norm: ["\\left\\|#1\\right\\|", 1],
                    abs: ["\\left|#1\\right|", 1],
                    // å–æ•´å‡½æ•°
                    floor: ["\\left\\lfloor#1\\right\\rfloor", 1],
                    ceil: ["\\left\\lceil#1\\right\\rceil", 1],
                    // å¾®åˆ†ç®—å­
                    diff: ["\\frac{\\mathrm{d}#1}{\\mathrm{d}#2}", 2],
                    pdiff: ["\\frac{\\partial#1}{\\partial#2}", 2]
                }
            },
            chtml: {
                scale: 1.1,
                minScale: 0.5,
                mtextInheritFont: true,
                displayAlign: 'center',
                displayIndent: '0em'
            },
            options: {
                processHtmlClass: 'markdown-content',
                ignoreHtmlClass: 'tex2jax_ignore',
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml']
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJaxé…ç½®å®Œæˆï¼Œæ”¯æŒé«˜çº§æ•°å­¦æ¸²æŸ“');
                }
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'var(--primary-color, #1E88E5)',
                        secondary: 'var(--secondary-color, #E3F2FD)',
                        accent: 'var(--accent-color, #42A5F5)',
                        'bg-primary': 'var(--bg-primary, #ffffff)',
                        'bg-secondary': 'var(--bg-secondary, #f8fafc)',
                        'text-primary': 'var(--text-primary, #1f2937)',
                        'text-secondary': 'var(--text-secondary, #6b7280)',
                        'border-primary': 'var(--border-primary, #e5e7eb)',
                        'user-bubble': 'var(--user-bubble-color, #E8E8E8)',
                        'bot-bubble': 'var(--bot-bubble-color, #E3F2FD)'
                    },
                    borderRadius: {
                        'none': '0px',
                        'sm': '4px',
                        DEFAULT: 'var(--bubble-radius, 8px)',
                        'md': '12px',
                        'lg': '16px',
                        'xl': '20px',
                        '2xl': '24px',
                        '3xl': '32px',
                        'full': '9999px',
                        'button': 'var(--button-radius, 8px)',
                        'bubble': 'var(--bubble-radius, 18px)'
                    },
                    fontSize: {
                        'chat': 'var(--chat-font-size, 1rem)'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>

    <style>
        /* CSSå˜é‡å®šä¹‰ - æ”¯æŒä¸»é¢˜åˆ‡æ¢å’Œä¸ªæ€§åŒ–è®¾ç½® */
        :root {
            /* æµ…è‰²ä¸»é¢˜ */
            --primary-color: #1E88E5;
            --secondary-color: #E3F2FD;
            --accent-color: #42A5F5;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-primary: #e5e7eb;
            --user-bubble-color: #E8E8E8;
            --bot-bubble-color: #E3F2FD;

            /* ä¸ªæ€§åŒ–è®¾ç½® */
            --chat-font-size: 1rem;
            --bubble-radius: 18px;
            --button-radius: 8px;
        }

        /* æš—é»‘ä¸»é¢˜ */
        [data-theme="dark"] {
            --primary-color: #3B82F6;
            --secondary-color: #1E293B;
            --accent-color: #60A5FA;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-primary: #334155;
            --user-bubble-color: #374151;
            --bot-bubble-color: #1e293b;
        }

        /* è‡ªå®šä¹‰ä¸»é¢˜é¢œè‰² */
        [data-theme="purple"] {
            --primary-color: #8B5CF6;
            --secondary-color: #F3E8FF;
            --accent-color: #A78BFA;
            --bot-bubble-color: #F3E8FF;
        }

        [data-theme="green"] {
            --primary-color: #10B981;
            --secondary-color: #D1FAE5;
            --accent-color: #34D399;
            --bot-bubble-color: #D1FAE5;
        }

        [data-theme="orange"] {
            --primary-color: #F59E0B;
            --secondary-color: #FEF3C7;
            --accent-color: #FBBF24;
            --bot-bubble-color: #FEF3C7;
        }

        /* åŸºç¡€æ ·å¼ */
        body {
            font-size: var(--chat-font-size);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        :where([class^="ri-"])::before {
            content: "\f3c2";
        }

        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
            font-size: var(--chat-font-size);
            transition: all 0.3s ease;
        }

        .user-message {
            background-color: var(--user-bubble-color);
            border-radius: var(--bubble-radius) var(--bubble-radius) 0 var(--bubble-radius);
            color: var(--text-primary);
        }

        .bot-message {
            background-color: var(--bot-bubble-color);
            border-radius: var(--bubble-radius) var(--bubble-radius) var(--bubble-radius) 0;
            color: var(--text-primary);
        }

        /* ===== æ¶ˆæ¯ç±»å‹ä¸“ç”¨æ ·å¼ç³»ç»Ÿ ===== */

        /* åŸºç¡€æ¶ˆæ¯ç±»å‹æ ·å¼ */
        .message-type-text {
            /* çº¯æ–‡æœ¬æ¶ˆæ¯ä¿æŒé»˜è®¤æ ·å¼ */
        }

        .message-type-image {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-left: 4px solid #10b981;
            position: relative;
            overflow: hidden;
        }

        .message-type-image::before {
            content: 'ğŸ–¼ï¸';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.6;
            z-index: 1;
        }

        .message-type-audio {
            background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 20%, #fbbf24 100%);
            border-left: 4px solid #f59e0b;
            position: relative;
            color: #92400e;
        }

        .message-type-audio::before {
            content: 'ğŸµ';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        .message-type-video {
            background: linear-gradient(135deg, #ddd6fe 0%, #8b5cf6 20%, #a78bfa 100%);
            border-left: 4px solid #8b5cf6;
            position: relative;
            color: #5b21b6;
        }

        .message-type-video::before {
            content: 'ğŸ¬';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        .message-type-mixed {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
            border-left: 4px solid #6366f1;
            position: relative;
        }

        .message-type-mixed::before {
            content: 'ğŸ“';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        /* Botæ¶ˆæ¯çš„ç‰¹æ®Šæ ·å¼ */
        .bot-message.message-type-text {
            background: var(--bot-bubble-color);
        }

        .bot-message.message-type-analysis {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid #10b981;
            position: relative;
        }

        .bot-message.message-type-analysis::before {
            content: 'ğŸ¤–';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        .bot-message.message-type-search {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #3b82f6;
            position: relative;
        }

        .bot-message.message-type-search::before {
            content: 'ğŸ”';
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 14px;
            opacity: 0.8;
            z-index: 1;
        }

        /* åª’ä½“å†…å®¹å®¹å™¨æ ·å¼ */
        .media-container {
            margin-top: 8px;
            border-radius: calc(var(--bubble-radius) - 4px);
            overflow: hidden;
            position: relative;
        }

        .image-container {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: calc(var(--bubble-radius) - 4px);
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .image-container:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .image-container img {
            width: 100%;
            height: auto;
            display: block;
            transition: opacity 0.3s ease;
        }

        .audio-container {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: calc(var(--bubble-radius) - 4px);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .audio-icon {
            width: 40px;
            height: 40px;
            background: #f59e0b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }

        .audio-info {
            flex: 1;
            min-width: 0;
        }

        .audio-title {
            font-weight: 600;
            color: #92400e;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .audio-controls {
            width: 100%;
            margin-top: 8px;
        }

        .video-container {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            border: 2px solid #8b5cf6;
            border-radius: calc(var(--bubble-radius) - 4px);
            overflow: hidden;
            position: relative;
        }

        .video-header {
            background: rgba(139, 92, 246, 0.1);
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .video-icon {
            width: 24px;
            height: 24px;
            background: #8b5cf6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .video-title {
            font-weight: 600;
            color: #5b21b6;
            font-size: 14px;
        }

        .video-controls {
            width: 100%;
            border-radius: 0;
        }

        /* æ¶ˆæ¯ç±»å‹æŒ‡ç¤ºå™¨ */
        .message-type-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .type-indicator-text {
            background: rgba(107, 114, 128, 0.1);
            color: #374151;
        }

        .type-indicator-image {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
        }

        .type-indicator-audio {
            background: rgba(245, 158, 11, 0.1);
            color: #92400e;
        }

        .type-indicator-video {
            background: rgba(139, 92, 246, 0.1);
            color: #5b21b6;
        }

        .type-indicator-mixed {
            background: rgba(99, 102, 241, 0.1);
            color: #3730a3;
        }

        /* æš—é»‘ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .message-type-image {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-left-color: #10b981;
        }

        [data-theme="dark"] .message-type-audio {
            background: linear-gradient(135deg, #422006 0%, #78350f 20%, #92400e 100%);
            color: #fbbf24;
        }

        [data-theme="dark"] .message-type-video {
            background: linear-gradient(135deg, #2e1065 0%, #5b21b6 20%, #7c3aed 100%);
            color: #c4b5fd;
        }

        [data-theme="dark"] .message-type-mixed {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #3730a3 100%);
            color: #c7d2fe;
        }

        [data-theme="dark"] .bot-message.message-type-analysis {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            color: #a7f3d0;
        }

        [data-theme="dark"] .bot-message.message-type-search {
            background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
            color: #bfdbfe;
        }

        [data-theme="dark"] .image-container {
            background: #1e293b;
            border-color: #334155;
        }

        [data-theme="dark"] .audio-container {
            background: linear-gradient(135deg, #422006 0%, #78350f 100%);
            border-color: #f59e0b;
        }

        [data-theme="dark"] .video-container {
            background: linear-gradient(135deg, #2e1065 0%, #5b21b6 100%);
            border-color: #8b5cf6;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {

            .message-type-image::before,
            .message-type-audio::before,
            .message-type-video::before,
            .message-type-mixed::before {
                font-size: 12px;
                top: 6px;
                right: 6px;
            }

            .media-container {
                margin-top: 6px;
            }

            .audio-container,
            .video-header {
                padding: 8px;
            }

            .audio-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .message-bubble {
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ¶ˆæ¯å†…å®¹åˆ†ç»„æ ·å¼ */
        .message-content-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .text-content {
            order: 1;
        }

        .media-content {
            order: 2;
        }

        /* æœç´¢ç»“æœç‰¹æ®Šæ ·å¼ */
        .search-results {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-result-item {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            padding: 8px 12px;
            border-left: 3px solid var(--primary-color);
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 4px;
        }

        .search-result-url {
            color: var(--primary-color);
            font-size: 12px;
            text-decoration: none;
            display: block;
            margin-bottom: 4px;
        }

        .search-result-url:hover {
            text-decoration: underline;
        }

        .search-result-snippet {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
        }

        /* æœç´¢æŒ‡ç¤ºå™¨æ ·å¼ */
        .search-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        /* æ¨¡å‹æŒ‡ç¤ºå™¨æ ·å¼ */
        .model-indicator {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            opacity: 0.7;
        }

        /* ç‰¹æ®Šæ ·å¼å¢å¼º */
        .message-type-search .search-indicator {
            color: #1d4ed8;
        }

        .message-type-analysis .model-indicator {
            color: #059669;
        }

        /* æš—é»‘ä¸»é¢˜ä¸‹çš„æœç´¢ç»“æœ */
        [data-theme="dark"] .search-result-item {
            background: rgba(0, 0, 0, 0.3);
            border-left-color: var(--primary-color);
        }

        [data-theme="dark"] .search-result-title {
            color: var(--text-primary);
        }

        [data-theme="dark"] .search-result-snippet {
            color: var(--text-secondary);
        }

        /* ===== å¼€å¯æ–°å¯¹è¯æŒ‰é’®ä¸“ç”¨æ ·å¼ ===== */
        .new-chat-button-container {
            display: flex;
            justify-content: center;
            padding: 16px 0 12px 0;
            border-bottom: 1px solid var(--border-primary);
            margin-bottom: 16px;
        }

        .new-chat-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Microsoft YaHei', sans-serif;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            position: relative;
            overflow: hidden;
            min-width: 160px;
            justify-content: center;
        }

        .new-chat-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .new-chat-button:hover::before {
            left: 100%;
        }

        .new-chat-button:hover {
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .new-chat-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .new-chat-button-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .new-chat-button-text {
            color: white;
            font-weight: 500;
            white-space: nowrap;
        }

        /* å¯¹è¯æ°”æ³¡å›¾æ ‡ */
        .chat-bubble-icon {
            position: relative;
            width: 18px;
            height: 18px;
        }

        .chat-bubble-icon::before {
            content: '';
            position: absolute;
            width: 10px;
            height: 8px;
            background: currentColor;
            border-radius: 6px 6px 6px 1px;
            top: 2px;
            left: 2px;
        }

        .chat-bubble-icon::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 6px;
            background: currentColor;
            border-radius: 4px 4px 1px 4px;
            top: 6px;
            right: 2px;
            opacity: 0.8;
        }

        /* æš—é»‘ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .new-chat-button-container {
            border-bottom-color: var(--border-primary);
        }

        [data-theme="dark"] .new-chat-button {
            background: linear-gradient(135deg, #1E40AF 0%, #1E3A8A 100%);
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.4);
        }

        [data-theme="dark"] .new-chat-button:hover {
            background: linear-gradient(135deg, #1D4ED8 0%, #1E3A8A 100%);
            box-shadow: 0 4px 16px rgba(30, 64, 175, 0.5);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .new-chat-button-container {
                padding: 12px 0 8px 0;
                margin-bottom: 12px;
            }

            .new-chat-button {
                padding: 10px 20px;
                font-size: 14px;
                min-width: 140px;
            }

            .new-chat-button-icon {
                width: 16px;
                height: 16px;
            }
        }

        /* é«˜å¯¹æ¯”åº¦æ”¯æŒ */
        @media (prefers-contrast: high) {
            .new-chat-button {
                border: 2px solid #1E40AF;
                background: #3B82F6;
            }

            .new-chat-button:hover {
                border-color: #1D4ED8;
                background: #2563EB;
            }
        }

        /* å‡å°‘åŠ¨ç”»åå¥½æ”¯æŒ */
        @media (prefers-reduced-motion: reduce) {
            .new-chat-button {
                transition: none;
            }

            .new-chat-button::before {
                display: none;
            }

            .new-chat-button:hover {
                transform: none;
            }
        }

        /* ===== ç»Ÿä¸€é™„ä»¶æŒ‰é’®æ ·å¼å¢å¼º ===== */

        /* ä¸ºå›å½¢é’ˆå›¾æ ‡æä¾›æ›´å¥½çš„æ‚¬åœæ•ˆæœ */
        #uploadAttachmentBtn:hover {
            background-color: var(--hover-bg, rgba(59, 130, 246, 0.1));
            color: var(--primary-color, #3B82F6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* æš—é»‘ä¸»é¢˜ä¸‹çš„é™„ä»¶æŒ‰é’® */
        [data-theme="dark"] #uploadAttachmentBtn {
            color: var(--text-secondary);
        }

        [data-theme="dark"] #uploadAttachmentBtn:hover {
            background-color: rgba(59, 130, 246, 0.2);
            color: var(--primary-color);
        }

        /* æŒ‰é’®ç»„çš„é—´è·ä¼˜åŒ– */
        .flex.space-x-2 {
            gap: 8px;
        }

        /* ä¸ºé™„ä»¶ä¸Šä¼ å¢åŠ loadingçŠ¶æ€æ ·å¼ */
        #uploadAttachmentBtn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #uploadAttachmentBtn[disabled]:hover {
            background-color: transparent;
            color: var(--text-muted);
            box-shadow: none;
        }

        /* ===== åº•éƒ¨æç¤ºä¿¡æ¯æ ·å¼ ===== */
        .input-hints {
            padding: 0 4px;
            margin-top: 8px;
            padding-top: 8px;
        }

        .input-hints span {
            color: var(--text-secondary);
            font-size: 11px;
            user-select: none;
            white-space: nowrap;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .input-hints:hover span {
            opacity: 0.9;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .input-hints {
                margin-top: 6px;
                padding-top: 6px;
            }

            .input-hints span {
                font-size: 10px;
            }
        }

        /* æš—é»‘ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .input-hints span {
            color: var(--text-secondary);
        }



        /* å“åº”å¼è®¾è®¡æ”¹è¿› */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 90%;
                font-size: max(14px, var(--chat-font-size));
            }

            /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
            button,
            .button {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }

            /* ç§»åŠ¨ç«¯å¿«æ·æ“ä½œæ  */
            .mobile-quick-actions {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 40;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .mobile-quick-btn {
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: var(--primary-color);
                color: white;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s ease;
                border: none;
                cursor: pointer;
            }

            .mobile-quick-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            }
        }

        /* å¿«æ·æ“ä½œæ æ ·å¼ */
        .quick-actions-bar {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 30;
            display: flex;
            flex-direction: column;
            gap: 12px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .quick-actions-bar:hover {
            opacity: 1;
        }

        .quick-action-btn {
            width: 48px;
            height: 48px;
            border-radius: var(--button-radius);
            background: var(--bg-primary);
            border: 2px solid var(--border-primary);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
            border-color: var(--primary-color);
        }

        /* è®¾ç½®é¢æ¿æ ·å¼ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-primary);
            z-index: 50;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-primary);
        }

        .settings-section h3 {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .theme-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .theme-option {
            padding: 12px;
            border: 2px solid var(--border-primary);
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
        }

        .theme-option.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }

        .theme-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid currentColor;
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: var(--button-radius);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-picker:hover {
            transform: scale(1.05);
        }

        .range-input {
            width: 100%;
            margin: 8px 0;
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-primary);
            border-radius: var(--button-radius);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .export-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* ç°æœ‰æ ·å¼ç»§ç»­ä¿æŒ */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            opacity: 0.6;
        }

        .typing-indicator span:nth-child(1) {
            animation: bounce 1s infinite 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation: bounce 1s infinite 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation: bounce 1s infinite 0.4s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        /* ===== å…¨æ–°çš„éª¨æ¶å±å’ŒåŠ è½½åŠ¨ç”»ç³»ç»Ÿ ===== */

        /* éª¨æ¶å±åŸºç¡€æ ·å¼ */
        .skeleton {
            background: linear-gradient(90deg, #f0f2f5 25%, #e6e9ed 50%, #f0f2f5 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* æš—é»‘ä¸»é¢˜ä¸‹çš„éª¨æ¶å± */
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #333333 50%, #2a2a2a 75%);
            background-size: 200% 100%;
        }

        /* æ¶ˆæ¯éª¨æ¶å±å®¹å™¨ */
        .message-skeleton {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: var(--bot-bubble-color);
            border-radius: var(--bubble-radius);
            max-width: 80%;
            margin-bottom: 16px;
            animation: skeleton-fade-in 0.3s ease-out;
        }

        @keyframes skeleton-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* éª¨æ¶å±è¡Œ */
        .skeleton-line {
            height: 16px;
            border-radius: 8px;
        }

        .skeleton-line.short {
            width: 60%;
        }

        .skeleton-line.medium {
            width: 80%;
        }

        .skeleton-line.long {
            width: 100%;
        }

        .skeleton-line.extra-short {
            width: 40%;
        }

        /* éª¨æ¶å±å¤´éƒ¨ */
        .skeleton-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .skeleton-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .skeleton-title {
            height: 14px;
            width: 120px;
            border-radius: 7px;
        }

        /* ç°ä»£åŠ è½½æŒ‡ç¤ºå™¨ */
        .modern-loading-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bot-bubble-color);
            border-radius: var(--bubble-radius);
            max-width: 80%;
            margin-bottom: 16px;
            animation: loading-fade-in 0.3s ease-out;
            border: 1px solid var(--border-primary);
        }

        @keyframes loading-fade-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* åŠ è½½å›¾æ ‡å®¹å™¨ */
        .loading-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: loading-pulse 2s infinite;
        }

        @keyframes loading-pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        /* åŠ è½½æ–‡æœ¬åŠ¨ç”» */
        .loading-text {
            font-size: 14px;
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
        }

        .loading-text::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.8) 50%, transparent 100%);
            animation: loading-text-shimmer 2s infinite;
        }

        @keyframes loading-text-shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* æ³¢æµªåŠ è½½åŠ¨ç”» */
        .wave-loading {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .wave-loading .wave-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: wave-bounce 1.4s infinite ease-in-out;
        }

        .wave-loading .wave-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .wave-loading .wave-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        .wave-loading .wave-dot:nth-child(3) {
            animation-delay: 0s;
        }

        @keyframes wave-bounce {

            0%,
            80%,
            100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* æ—‹è½¬åŠ è½½åŠ¨ç”» */
        .spinner-loading {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-primary);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spinner-rotate 1s linear infinite;
        }

        @keyframes spinner-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* æœç´¢çŠ¶æ€ç‰¹æ®Šæ ·å¼ */
        .search-loading {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 4px solid var(--primary-color);
        }

        .search-loading .loading-icon {
            background: linear-gradient(45deg, #1e88e5, #9c27b0);
            animation: search-icon-rotate 2s linear infinite;
        }

        @keyframes search-icon-rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* å›¾åƒå¤„ç†åŠ è½½æ ·å¼ */
        .image-processing-loading {
            background: linear-gradient(135deg, #fff3e0 0%, #e8f5e8 100%);
            border-left: 4px solid #ff9800;
        }

        .image-processing-loading .loading-icon {
            background: linear-gradient(45deg, #ff9800, #4caf50);
        }

        /* åŠ è½½çŠ¶æ€è¿‡æ¸¡æ•ˆæœ */
        .loading-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .loading-exit {
            animation: loading-exit-animation 0.3s ease-in-out forwards;
        }

        @keyframes loading-exit-animation {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            50% {
                opacity: 0.5;
                transform: translateY(-5px) scale(0.98);
            }

            100% {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {

            .message-skeleton,
            .modern-loading-indicator {
                max-width: 90%;
            }

            .skeleton-line {
                height: 14px;
            }

            .loading-icon {
                width: 20px;
                height: 20px;
            }
        }

        /* é«˜å¯¹æ¯”åº¦æ”¯æŒ */
        @media (prefers-contrast: high) {
            .skeleton {
                background: linear-gradient(90deg, #d0d0d0 25%, #a0a0a0 50%, #d0d0d0 75%);
            }

            .modern-loading-indicator {
                border: 2px solid var(--text-primary);
            }
        }

        /* å‡å°‘åŠ¨ç”»åå¥½æ”¯æŒ */
        @media (prefers-reduced-motion: reduce) {

            .skeleton,
            .loading-icon,
            .wave-loading .wave-dot,
            .spinner-loading {
                animation: none;
            }

            .skeleton {
                background: #f0f2f5;
            }

            [data-theme="dark"] .skeleton {
                background: #2a2a2a;
            }
        }

        /* å…¨å±€loadingçŠ¶æ€æ ·å¼ */
        body.loading-active {
            cursor: wait;
        }

        body.loading-active * {
            pointer-events: none;
        }

        body.loading-active .loading-allowed {
            pointer-events: auto;
        }

        /* Toasté€šçŸ¥æ ·å¼å¢å¼º */
        .toast-enter {
            transform: translateX(100%);
            opacity: 0;
        }

        .toast-enter-active {
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }

        .toast-exit {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-exit-active {
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease-in;
        }

        /* ä¼šè¯éª¨æ¶å±æ ·å¼ */
        .session-skeleton:hover {
            background-color: transparent !important;
        }

        .session-skeleton .skeleton {
            pointer-events: none;
        }

        /* å¢å¼ºçš„åŠ è½½æŒ‰é’®çŠ¶æ€ */
        .loading-button {
            position: relative;
            overflow: hidden;
        }

        .loading-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: button-loading-shimmer 1.5s infinite;
        }

        @keyframes button-loading-shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        /* æ™ºèƒ½åŠ è½½çŠ¶æ€åˆ‡æ¢ */
        .smart-loading-container {
            position: relative;
            min-height: 60px;
        }

        .smart-loading-content {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .smart-loading-container.loading .smart-loading-content {
            opacity: 0.6;
        }

        /* é«˜çº§éª¨æ¶å±åŠ¨ç”» */
        .skeleton-advanced {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.4) 20%,
                    rgba(255, 255, 255, 0.5) 60%,
                    rgba(255, 255, 255, 0) 100%);
            background-size: 200px 100%;
            background-repeat: no-repeat;
            animation: skeleton-advanced-loading 2s infinite;
        }

        @keyframes skeleton-advanced-loading {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        /* æš—é»‘ä¸»é¢˜éª¨æ¶å±å¢å¼º */
        [data-theme="dark"] .skeleton-advanced {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.1) 20%,
                    rgba(255, 255, 255, 0.2) 60%,
                    rgba(255, 255, 255, 0) 100%);
        }

        /* æ‰“å­—æœºæ•ˆæœæ ·å¼ */
        .typewriter-text {
            display: inline;
        }

        .typewriter-cursor {
            display: inline-block;
            background-color: var(--primary-color);
            margin-left: 2px;
            width: 2px;
            height: 1.2em;
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        .chat-container::-webkit-scrollbar {
            width: 6px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        .input-area {
            border-top: 1px solid #E5E7EB;
        }

        .message-input {
            resize: none;
            min-height: 24px;
            max-height: 120px;
            overflow-y: auto;
        }

        .message-input::-webkit-scrollbar {
            width: 4px;
        }

        .message-input::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .message-input::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }

        .audio-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
        }

        .audio-wave span {
            display: inline-block;
            width: 3px;
            height: 100%;
            margin: 0 2px;
            background-color: #1E88E5;
            border-radius: 3px;
            animation: wave 1s infinite ease-in-out;
        }

        .audio-wave span:nth-child(2) {
            animation-delay: 0.1s;
        }

        .audio-wave span:nth-child(3) {
            animation-delay: 0.2s;
        }

        .audio-wave span:nth-child(4) {
            animation-delay: 0.3s;
        }

        .audio-wave span:nth-child(5) {
            animation-delay: 0.4s;
        }

        /* ä¼˜åŒ–çš„æ•°å­¦å…¬å¼æ ·å¼ */
        .markdown-content mjx-container {
            margin: 0.3em 0;
            line-height: 1.4;
        }

        /* è¡Œå†…æ•°å­¦å…¬å¼æ ·å¼ */
        .markdown-content mjx-container[display="inline"] {
            display: inline-block;
            vertical-align: middle;
            margin: 0 0.15em;
            padding: 0.1em 0.2em;
            background-color: rgba(240, 248, 255, 0.8);
            border-radius: 3px;
            border: 1px solid rgba(173, 216, 230, 0.3);
        }

        /* å—çº§æ•°å­¦å…¬å¼æ ·å¼ */
        .markdown-content mjx-container[display="block"] {
            display: block;
            margin: 1.2em auto;
            padding: 1em;
            text-align: center;
            max-width: 100%;
            overflow-x: auto;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
        }

        /* æ•°å­¦å…¬å¼å­—ä½“ä¼˜åŒ– */
        .markdown-content mjx-container[jax="CHTML"] {
            font-size: 1.05em;
            font-family: 'Times New Roman', 'STIX Two Math', serif;
        }

        /* æ•°å­¦å…¬å¼æ‚¬åœæ•ˆæœ */
        .markdown-content mjx-container[display="block"]:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }

        /* æ•°å­¦å…¬å¼é”™è¯¯æ ·å¼ */
        .math-error {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85em;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.1);
        }

        /* é•¿å…¬å¼æ¨ªå‘æ»šåŠ¨ä¼˜åŒ– */
        .markdown-content mjx-container[display="block"] mjx-math {
            max-width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* ç§»åŠ¨è®¾å¤‡ä¼˜åŒ– */
        @media (max-width: 768px) {
            .markdown-content mjx-container[display="block"] {
                font-size: 0.95em;
                margin: 1em 0;
                padding: 0.8em;
            }

            .markdown-content mjx-container[display="inline"] {
                font-size: 0.9em;
                margin: 0 0.1em;
                padding: 0.05em 0.1em;
            }
        }

        /* é«˜åˆ†è¾¨ç‡å±å¹•ä¼˜åŒ– */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {
            .markdown-content mjx-container[jax="CHTML"] {
                font-size: 1.1em;
            }
        }

        @keyframes wave {

            0%,
            100% {
                height: 15px;
            }

            50% {
                height: 30px;
            }
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
        }

        /* Markdown æ¸²æŸ“æ ·å¼ */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            margin-top: 1rem;
        }

        .markdown-content h1 {
            font-size: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }

        .markdown-content h2 {
            font-size: 1.375rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }

        .markdown-content h3 {
            font-size: 1.25rem;
        }

        .markdown-content h4 {
            font-size: 1.125rem;
        }

        .markdown-content p {
            margin-bottom: 1rem;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .markdown-content ul {
            list-style-type: disc;
        }

        .markdown-content ol {
            list-style-type: decimal;
        }

        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6b7280;
        }

        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.875rem;
        }

        .markdown-content pre {
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #e9ecef;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            border-radius: 0;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.875rem;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        .markdown-content table th {
            background-color: #f9fafb;
            font-weight: bold;
        }

        .markdown-content table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .markdown-content a {
            color: #1e88e5;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #1565c0;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1.5rem 0;
        }

        /* ä»£ç é«˜äº®æ ·å¼å¢å¼º */
        .markdown-content .token.comment,
        .markdown-content .token.prolog,
        .markdown-content .token.doctype,
        .markdown-content .token.cdata {
            color: #708090;
        }

        .markdown-content .token.punctuation {
            color: #999;
        }

        .markdown-content .token.property,
        .markdown-content .token.tag,
        .markdown-content .token.boolean,
        .markdown-content .token.number,
        .markdown-content .token.constant,
        .markdown-content .token.symbol,
        .markdown-content .token.deleted {
            color: #905;
        }

        .markdown-content .token.selector,
        .markdown-content .token.attr-name,
        .markdown-content .token.string,
        .markdown-content .token.char,
        .markdown-content .token.builtin,
        .markdown-content .token.inserted {
            color: #690;
        }

        .markdown-content .token.operator,
        .markdown-content .token.entity,
        .markdown-content .token.url,
        .markdown-content .language-css .token.string,
        .markdown-content .style .token.string {
            color: #9a6e3a;
        }

        .markdown-content .token.atrule,
        .markdown-content .token.attr-value,
        .markdown-content .token.keyword {
            color: #07a;
        }

        .markdown-content .token.function,
        .markdown-content .token.class-name {
            color: #dd4a68;
        }

        /* æ•°å­¦å…¬å¼æ ·å¼ä¼˜åŒ– */
        .markdown-content .MathJax {
            font-size: 1.15em !important;
            outline: none;
            color: #2d3748 !important;
        }

        .markdown-content .MathJax_Display {
            margin: 1.5rem 0 !important;
            text-align: center;
            overflow-x: auto;
            overflow-y: visible;
            padding: 0.5rem 0;
        }

        .markdown-content .MathJax_Preview {
            color: #888;
            font-style: italic;
            background-color: #f7fafc;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* SVGæ¸²æŸ“çš„æ•°å­¦å…¬å¼æ ·å¼ */
        .markdown-content mjx-container {
            display: inline-block;
            margin: 0.3em 0.1em;
            color: #2d3748 !important;
        }

        .markdown-content mjx-container[display="block"] {
            display: block;
            text-align: center;
            margin: 1.5em 0;
            overflow-x: auto;
            overflow-y: visible;
            padding: 0.8em 0;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .markdown-content mjx-math {
            line-height: 1.3;
            font-size: 1.1em !important;
        }

        /* å¤„ç†é•¿å…¬å¼çš„æ»šåŠ¨ */
        .markdown-content mjx-container[display="block"] mjx-math {
            min-width: min-content;
            padding: 0 1em;
        }

        /* è¡Œå†…æ•°å­¦å…¬å¼çš„åŸºçº¿å¯¹é½ */
        .markdown-content mjx-container:not([display="block"]) {
            vertical-align: baseline;
            background-color: #f7fafc;
            padding: 2px 4px;
            border-radius: 3px;
            border: 1px solid #e2e8f0;
        }

        /* æ•°å­¦å…¬å¼çš„é”™è¯¯æ˜¾ç¤º */
        .markdown-content .MathJax_Error {
            color: #e53e3e !important;
            background-color: #fed7d7 !important;
            border: 1px solid #feb2b2;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        /* æ•°å­¦å…¬å¼æ˜¾ç¤ºå®¹å™¨ */
        .markdown-content .math-display-container {
            text-align: center;
            margin: 1.5em 0;
            padding: 1em;
            overflow-x: auto;
            overflow-y: visible;
            border-radius: 10px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* æ•°å­¦å…¬å¼é”™è¯¯æç¤º */
        .markdown-content .math-error {
            display: inline-block;
            color: #e53e3e;
            background-color: #fed7d7;
            border: 1px solid #feb2b2;
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            margin: 4px;
            font-weight: 500;
        }

        /* å“åº”å¼æ•°å­¦å…¬å¼ */
        @media (max-width: 768px) {
            .markdown-content .math-display-container {
                font-size: 0.95em;
                padding: 0.8em;
                margin: 1.2em 0;
            }

            .markdown-content mjx-container {
                font-size: 0.95em !important;
            }

            .markdown-content mjx-container[display="block"] {
                padding: 0.6em 0;
            }

            .markdown-content mjx-container[display="block"] mjx-math {
                padding: 0 0.5em;
            }
        }



        .search-controls-inline {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.05);
            padding: 6px 10px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-controls-inline:hover {
            background: rgba(0, 0, 0, 0.08);
            border-color: rgba(0, 0, 0, 0.15);
        }

        .search-label-inline {
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }

        /* å¼€å…³æ ·å¼ */
        .switch,
        .switch-inline {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input,
        .switch-inline input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider,
        .slider-inline {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before,
        .slider-inline:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider,
        input:checked+.slider-inline {
            background-color: #1E88E5;
        }

        input:checked+.slider:before,
        input:checked+.slider-inline:before {
            transform: translateX(20px);
        }

        /* æœç´¢ç»“æœæ ·å¼ */
        .search-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(30, 136, 229, 0.1);
            border-radius: 8px;
            font-weight: 500;
            color: #1E88E5;
        }

        .search-results {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
        }

        .search-result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .search-result-title {
            font-weight: 600;
            color: #1565C0;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .search-result-url {
            color: #4CAF50;
            text-decoration: none;
            font-size: 14px;
            display: block;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .search-result-url:hover {
            text-decoration: underline;
        }

        .search-result-snippet {
            color: #666;
            line-height: 1.4;
            font-size: 14px;
        }

        .model-indicator {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>

<body class="bg-bg-secondary h-screen flex flex-col transition-all duration-300">
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="bg-bg-primary shadow-sm py-3 px-4 flex items-center justify-between border-b border-border-primary">
        <div class="flex items-center">
            <button id="toggleSidebar"
                class="lg:hidden mr-3 w-8 h-8 rounded flex items-center justify-center text-text-secondary hover:bg-bg-secondary transition-colors">
                <i class="ri-menu-line"></i>
            </button>
            <span class="text-xl font-['Pacifico'] text-primary">logo</span>
            <h1 class="ml-2 text-lg font-medium text-text-primary">å¤šæ¨¡æ€æ™ºèƒ½åŠ©æ‰‹</h1>
        </div>
        <div class="flex items-center space-x-3">
            <!-- å¿«é€Ÿè®¾ç½®åŒºåŸŸ -->
            <div class="flex items-center space-x-2">
                <!-- Temperatureå¿«é€Ÿè°ƒèŠ‚ -->
                <div class="flex items-center bg-bg-secondary rounded-lg px-2 py-1">
                    <span class="text-xs text-text-secondary mr-1">åˆ›é€ æ€§:</span>
                    <span id="headerTemperatureValue" class="text-xs font-semibold text-primary min-w-[24px]">0.7</span>
                    <button id="headerTemperatureBtn" class="ml-1 text-text-secondary hover:text-text-primary">
                        <i class="ri-settings-4-line text-sm"></i>
                    </button>
                </div>

                <!-- System PromptçŠ¶æ€æŒ‡ç¤º -->
                <div class="flex items-center">
                    <button id="headerSystemPromptBtn"
                        class="flex items-center bg-bg-secondary hover:bg-border-primary rounded-lg px-2 py-1 transition-colors">
                        <i id="systemPromptIcon" class="ri-chat-settings-line text-sm text-text-secondary mr-1"></i>
                        <span id="systemPromptStatus" class="text-xs text-text-secondary">ç³»ç»Ÿæç¤º</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- System Prompt è®¾ç½®å¼¹çª— -->
    <div id="systemPromptModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="ri-chat-settings-line mr-2"></i>ç³»ç»Ÿæç¤ºè®¾ç½®
                </h3>
                <button id="closeSystemPromptBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ç³»ç»Ÿæç¤ºå†…å®¹</label>
                <textarea id="systemPromptInput"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                    rows="4" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºï¼Œä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯åŠ©æ‰‹ï¼Œè¯·ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€å›ç­”é—®é¢˜..."></textarea>
                <p class="text-xs text-gray-500 mt-1">ç³»ç»Ÿæç¤ºå°†å½±å“AIçš„å›ç­”é£æ ¼å’Œè¡Œä¸ºï¼Œç•™ç©ºåˆ™ä¸è®¾ç½®ç³»ç»Ÿæç¤º</p>
            </div>

            <!-- é¢„è®¾æ¨¡æ¿ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿæ¨¡æ¿</label>
                <div class="grid grid-cols-2 gap-2">
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯åŠ©æ‰‹ï¼Œè¯·ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€å›ç­”ç¼–ç¨‹å’ŒæŠ€æœ¯ç›¸å…³é—®é¢˜ã€‚">
                        ğŸ’» æŠ€æœ¯åŠ©æ‰‹
                    </button>
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="ä½ æ˜¯ä¸€ä¸ªåˆ›æ„å†™ä½œåŠ©æ‰‹ï¼Œæ“…é•¿åˆ›ä½œæ•…äº‹ã€è¯—æ­Œå’Œæ–‡æ¡ˆï¼Œè¯·ç”¨å¯Œæœ‰æƒ³è±¡åŠ›çš„è¯­è¨€å›ç­”ã€‚">
                        âœï¸ åˆ›æ„å†™ä½œ
                    </button>
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="ä½ æ˜¯ä¸€ä¸ªå­¦ä¹ åŠ©æ‰‹ï¼Œè¯·ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šå¤æ‚æ¦‚å¿µï¼Œå¤šä¸¾ä¾‹è¯´æ˜ã€‚">
                        ğŸ“š å­¦ä¹ åŠ©æ‰‹
                    </button>
                    <button
                        class="system-prompt-template text-left text-xs p-2 bg-gray-50 hover:bg-gray-100 rounded border"
                        data-template="ä½ æ˜¯ä¸€ä¸ªå•†åŠ¡åŠ©æ‰‹ï¼Œè¯·ç”¨ä¸“ä¸šã€æ­£å¼çš„è¯­è¨€å¤„ç†å•†ä¸šç›¸å…³é—®é¢˜ã€‚">
                        ğŸ’¼ å•†åŠ¡åŠ©æ‰‹
                    </button>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button id="clearSystemPromptBtn"
                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    æ¸…ç©º
                </button>
                <button id="saveSystemPromptBtn"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- Temperature å¿«é€Ÿè°ƒèŠ‚å¼¹çª— -->
    <div id="temperatureModal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="ri-settings-4-line mr-2"></i>åˆ›é€ æ€§è®¾ç½®
                </h3>
                <button id="closeTemperatureBtn" class="text-gray-400 hover:text-gray-600">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    å½“å‰å€¼: <span id="temperatureValue" class="text-blue-600 font-semibold text-lg">0.7</span>
                </label>
                <div class="flex items-center space-x-2 mb-3">
                    <span class="text-xs text-gray-500">ç²¾ç¡®(0)</span>
                    <input type="range" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7"
                        class="flex-1 h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <span class="text-xs text-gray-500">åˆ›é€ (2)</span>
                </div>

                <!-- é¢„è®¾å€¼ -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button class="temperature-preset px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border"
                        data-temp="0.1">
                        ç²¾å‡† (0.1)
                    </button>
                    <button class="temperature-preset px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border"
                        data-temp="0.7">
                        å¹³è¡¡ (0.7)
                    </button>
                    <button class="temperature-preset px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded border"
                        data-temp="1.5">
                        åˆ›æ„ (1.5)
                    </button>
                </div>

                <p class="text-xs text-gray-500">æ•°å€¼è¶Šä½å›ç­”è¶Šå‡†ç¡®ï¼Œæ•°å€¼è¶Šé«˜å›ç­”è¶Šæœ‰åˆ›æ„</p>
            </div>

            <div class="flex justify-end">
                <button id="saveTemperatureBtn"
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                    ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸ªæ€§åŒ–è®¾ç½®é¢æ¿ -->
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-section">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-text-primary flex items-center gap-2">
                    <i class="ri-settings-3-line"></i>
                    ä¸ªæ€§åŒ–è®¾ç½®
                </h2>
                <button id="closeSettingsBtn" class="text-text-secondary hover:text-text-primary">
                    <i class="ri-close-line text-xl"></i>
                </button>
            </div>
        </div>

        <!-- ä¸»é¢˜è®¾ç½® -->
        <div class="settings-section">
            <h3><i class="ri-palette-line"></i>ä¸»é¢˜è®¾ç½®</h3>
            <div class="theme-selector">
                <div class="theme-option active" data-theme="light">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #1E88E5 0%, #E3F2FD 100%)">
                    </div>
                    <span>æµ…è‰²ä¸»é¢˜</span>
                </div>
                <div class="theme-option" data-theme="dark">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #3B82F6 0%, #1E293B 100%)">
                    </div>
                    <span>æš—é»‘ä¸»é¢˜</span>
                </div>
                <div class="theme-option" data-theme="purple">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #8B5CF6 0%, #F3E8FF 100%)">
                    </div>
                    <span>ç´«è‰²ä¸»é¢˜</span>
                </div>
                <div class="theme-option" data-theme="green">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #10B981 0%, #D1FAE5 100%)">
                    </div>
                    <span>ç»¿è‰²ä¸»é¢˜</span>
                </div>
                <div class="theme-option" data-theme="orange">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #F59E0B 0%, #FEF3C7 100%)">
                    </div>
                    <span>æ©™è‰²ä¸»é¢˜</span>
                </div>
                <div class="theme-option" data-theme="custom">
                    <div class="theme-preview" style="background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%)">
                    </div>
                    <span>è‡ªå®šä¹‰</span>
                </div>
            </div>
        </div>

        <!-- è‡ªå®šä¹‰é¢œè‰² -->
        <div class="settings-section" id="customColorsSection" style="display: none;">
            <h3><i class="ri-color-filter-line"></i>è‡ªå®šä¹‰é¢œè‰²</h3>
            <div class="color-picker-container">
                <label for="primaryColorPicker">ä¸»è¦é¢œè‰²:</label>
                <input type="color" id="primaryColorPicker" class="color-picker" value="#1E88E5">
            </div>
            <div class="color-picker-container">
                <label for="userBubbleColorPicker">ç”¨æˆ·æ°”æ³¡:</label>
                <input type="color" id="userBubbleColorPicker" class="color-picker" value="#E8E8E8">
            </div>
            <div class="color-picker-container">
                <label for="botBubbleColorPicker">AIæ°”æ³¡:</label>
                <input type="color" id="botBubbleColorPicker" class="color-picker" value="#E3F2FD">
            </div>
        </div>

        <!-- å­—ä½“è®¾ç½® -->
        <div class="settings-section">
            <h3><i class="ri-font-size-2"></i>å­—ä½“è®¾ç½®</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-text-secondary mb-2">
                    å­—ä½“å¤§å°: <span id="fontSizeValue">16px</span>
                </label>
                <input type="range" id="fontSizeSlider" min="12" max="24" value="16" step="1" class="range-input">
                <div class="flex justify-between text-xs text-text-secondary mt-1">
                    <span>12px</span>
                    <span>18px</span>
                    <span>24px</span>
                </div>
            </div>
        </div>

        <!-- æ°”æ³¡æ ·å¼ -->
        <div class="settings-section">
            <h3><i class="ri-chat-3-line"></i>æ°”æ³¡æ ·å¼</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-text-secondary mb-2">
                    åœ†è§’å¤§å°: <span id="bubbleRadiusValue">18px</span>
                </label>
                <input type="range" id="bubbleRadiusSlider" min="0" max="30" value="18" step="2" class="range-input">
                <div class="flex justify-between text-xs text-text-secondary mt-1">
                    <span>æ–¹å½¢</span>
                    <span>é€‚ä¸­</span>
                    <span>åœ†æ¶¦</span>
                </div>
            </div>
        </div>

        <!-- å¯¼å‡ºè®¾ç½® -->
        <div class="settings-section">
            <h3><i class="ri-download-line"></i>å¯¼å‡ºå¯¹è¯</h3>
            <div class="export-buttons">
                <button class="export-btn" id="exportTxtBtn">
                    <i class="ri-file-text-line mr-1"></i>TXTæ ¼å¼
                </button>
                <button class="export-btn" id="exportJsonBtn">
                    <i class="ri-file-code-line mr-1"></i>JSONæ ¼å¼
                </button>
                <button class="export-btn" id="exportMarkdownBtn">
                    <i class="ri-markdown-line mr-1"></i>Markdownæ ¼å¼
                </button>
                <button class="export-btn" id="exportPdfBtn">
                    <i class="ri-file-pdf-line mr-1"></i>PDFæ ¼å¼
                </button>
            </div>
        </div>

        <!-- é‡ç½®è®¾ç½® -->
        <div class="settings-section">
            <h3><i class="ri-refresh-line"></i>é‡ç½®è®¾ç½®</h3>
            <button id="resetSettingsBtn" class="export-btn"
                style="background: #ef4444; color: white; border-color: #ef4444;">
                <i class="ri-restart-line mr-1"></i>æ¢å¤é»˜è®¤è®¾ç½®
            </button>
        </div>
    </div>

    <!-- å¿«æ·æ“ä½œæ  (æ¡Œé¢ç«¯) -->
    <div class="quick-actions-bar hidden lg:flex">
        <button class="quick-action-btn" id="quickClearBtn" title="æ¸…ç©ºå¯¹è¯">
            <i class="ri-delete-bin-line"></i>
        </button>
        <button class="quick-action-btn" id="quickExportBtn" title="å¯¼å‡ºå¯¹è¯">
            <i class="ri-download-line"></i>
        </button>
        <button class="quick-action-btn" id="quickSettingsBtn" title="è®¾ç½®">
            <i class="ri-settings-3-line"></i>
        </button>

        <button class="quick-action-btn" id="quickScrollTopBtn" title="å›åˆ°é¡¶éƒ¨">
            <i class="ri-arrow-up-line"></i>
        </button>
        <button class="quick-action-btn" id="quickScrollBottomBtn" title="å›åˆ°åº•éƒ¨">
            <i class="ri-arrow-down-line"></i>
        </button>
    </div>

    <!-- ç§»åŠ¨ç«¯å¿«æ·æ“ä½œæ  -->
    <div class="mobile-quick-actions lg:hidden">
        <button class="mobile-quick-btn" id="mobileQuickExportBtn" title="å¯¼å‡ºå¯¹è¯">
            <i class="ri-download-line"></i>
        </button>
        <button class="mobile-quick-btn" id="mobileQuickSettingsBtn" title="è®¾ç½®">
            <i class="ri-settings-3-line"></i>
        </button>
        <button class="mobile-quick-btn" id="mobileScrollTopBtn" title="å›åˆ°é¡¶éƒ¨">
            <i class="ri-arrow-up-line"></i>
        </button>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="flex flex-1 overflow-hidden relative">
        <!-- å†å²å¯¹è¯ä¾§è¾¹æ  -->
        <div id="sidebar"
            class="w-80 bg-bg-primary border-r border-border-primary flex flex-col transform transition-transform duration-300 -translate-x-full absolute lg:relative z-30 h-full lg:translate-x-0">
            <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="ri-history-line mr-2"></i>å¯¹è¯å†å²
                    </h2>
                    <button id="closeSidebar" class="lg:hidden p-1 text-gray-400 hover:text-gray-600 rounded">
                        <i class="ri-close-line text-xl"></i>
                    </button>
                </div>

                <!-- æœç´¢æ¡† -->
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="æœç´¢å¯¹è¯..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <i class="ri-search-line absolute left-3 top-2.5 text-gray-400"></i>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div id="statsSection" class="px-4 py-3 bg-gray-50 border-b border-gray-200">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <div class="text-lg font-semibold text-blue-600" id="totalSessions">0</div>
                        <div class="text-xs text-gray-500">æ€»å¯¹è¯</div>
                    </div>
                    <div>
                        <div class="text-lg font-semibold text-green-600" id="totalMessages">0</div>
                        <div class="text-xs text-gray-500">æ€»æ¶ˆæ¯</div>
                    </div>
                </div>
            </div>

            <!-- å¯¹è¯åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto">
                <div id="sessionsList" class="p-2">
                    <!-- å¯¹è¯åˆ—è¡¨é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div id="loadMoreSessions" class="p-4 text-center hidden">
                    <button class="text-blue-500 hover:text-blue-600 text-sm">åŠ è½½æ›´å¤š...</button>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="flex-1 flex flex-col">
            <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
            <div id="chatContainer" class="chat-container flex-1 overflow-y-auto p-4 bg-bg-secondary">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="flex mb-4">
                    <div class="message-bubble bot-message p-3 text-gray-800">
                        <p>æˆ‘æ˜¯ å¤šæ¨¡æ€æœºå™¨äººï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼</p>
                        <p class="mt-2">æˆ‘å¯ä»¥å¸®ä½ å†™ä»£ç ã€è¯»æ–‡ä»¶ã€å†™ä½œå„ç§åˆ›æ„å†…å®¹ï¼Œè¯·æŠŠä½ çš„ä»»åŠ¡äº¤ç»™æˆ‘å§</p>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area bg-bg-primary px-4 py-3 border-t border-border-primary">
                <!-- å¼€å¯æ–°å¯¹è¯æŒ‰é’® -->
                <div class="new-chat-button-container">
                    <button id="newChatButton" class="new-chat-button" title="æ¸…ç©ºå½“å‰å¯¹è¯ï¼Œå¼€å§‹å…¨æ–°çš„å¯¹è¯">
                        <div class="new-chat-button-icon">
                            <div class="chat-bubble-icon"></div>
                        </div>
                        <span class="new-chat-button-text">å¼€å¯æ–°å¯¹è¯</span>
                    </button>
                </div>

                <!-- é¢„è§ˆåŒºåŸŸ -->
                <div id="previewArea" class="hidden mb-3">
                    <div id="imagePreview" class="hidden relative inline-block mr-2 mb-2">
                        <img id="previewImage" class="h-20 w-auto rounded" alt="é¢„è§ˆå›¾ç‰‡">
                        <button id="removeImageBtn"
                            class="absolute -top-2 -right-2 bg-gray-800 bg-opacity-70 rounded-full w-5 h-5 flex items-center justify-center text-white">
                            <div class="w-3 h-3 flex items-center justify-center">
                                <i class="ri-close-line"></i>
                            </div>
                        </button>
                    </div>

                    <div id="audioPreview" class="hidden relative inline-block mr-2 mb-2">
                        <div
                            class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center space-x-3 min-w-48">
                            <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="ri-file-music-line text-blue-600"></i>
                            </div>
                            <div class="flex-1">
                                <div id="audioFileName" class="text-sm font-medium text-gray-800">éŸ³é¢‘æ–‡ä»¶</div>
                                <div id="audioFileSize" class="text-xs text-gray-500">0 MB</div>
                            </div>
                            <button id="removeAudioBtn"
                                class="w-6 h-6 bg-gray-800 bg-opacity-70 rounded-full flex items-center justify-center text-white hover:bg-opacity-90">
                                <i class="ri-close-line text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <div id="videoPreview" class="hidden relative inline-block mr-2 mb-2">
                        <div
                            class="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center space-x-3 min-w-48">
                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="ri-video-line text-green-600"></i>
                            </div>
                            <div class="flex-1">
                                <div id="videoFileName" class="text-sm font-medium text-gray-800">è§†é¢‘æ–‡ä»¶</div>
                                <div id="videoFileSize" class="text-xs text-gray-500">0 MB</div>
                            </div>
                            <button id="removeVideoBtn"
                                class="w-6 h-6 bg-gray-800 bg-opacity-70 rounded-full flex items-center justify-center text-white hover:bg-opacity-90">
                                <i class="ri-close-line text-sm"></i>
                            </button>
                        </div>
                    </div>

                    <div id="audioRecording"
                        class="hidden bg-red-50 border border-red-200 rounded-lg p-3 inline-flex items-center space-x-3">
                        <div class="audio-wave">
                            <span></span>
                            <span></span>
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="text-sm text-red-700 font-medium">æ­£åœ¨å½•éŸ³...</span>
                        <button id="stopRecordingBtn"
                            class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white hover:bg-red-600">
                            <i class="ri-stop-circle-fill"></i>
                        </button>
                    </div>
                </div>

                <div class="flex items-end">
                    <div class="flex space-x-2 mr-3">
                        <button id="uploadAttachmentBtn"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-all duration-200"
                            title="ä¸Šä¼ é™„ä»¶ï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰ï¼‰">
                            <div class="w-5 h-5 flex items-center justify-center">
                                <i class="ri-attachment-2"></i>
                            </div>
                        </button>
                        <button id="startVoiceBtn"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition-all duration-200"
                            title="å½•éŸ³">
                            <div class="w-5 h-5 flex items-center justify-center">
                                <i class="ri-mic-line"></i>
                            </div>
                        </button>
                    </div>

                    <div class="flex-1 relative">
                        <textarea id="messageInput"
                            class="message-input w-full border-none focus:ring-0 rounded-xl bg-gray-100 px-4 py-2 text-gray-800 placeholder-gray-500"
                            placeholder="è¾“å…¥æ‚¨æƒ³è¯´çš„è¯..." rows="1"></textarea>
                    </div>

                    <!-- è”ç½‘æœç´¢å¼€å…³ -->
                    <div class="search-controls-inline ml-3">
                        <label class="switch-inline">
                            <input type="checkbox" id="enableSearch" checked>
                            <span class="slider-inline round"></span>
                        </label>
                        <label for="enableSearch" class="search-label-inline">
                            <span class="search-status-icon">ğŸŒ</span>
                        </label>
                    </div>



                    <button id="sendMessageBtn"
                        class="ml-3 px-4 py-2 !rounded-button bg-gray-200 text-gray-500 hover:bg-gray-300 transition-colors disabled:opacity-50 whitespace-nowrap">
                        <div class="w-5 h-5 flex items-center justify-center">
                            <i class="ri-send-plane-fill"></i>
                        </div>
                    </button>
                </div>

                <!-- åº•éƒ¨æç¤ºä¿¡æ¯ -->
                <div class="input-hints mt-2 flex justify-center items-center text-xs">
                    <div class="text-text-secondary opacity-60">
                        <span>Shift + Enter æ¢è¡Œ â€¢ è‡ªåŠ¨è¯†åˆ«å†…å®¹ç±»å‹åˆ‡æ¢æ¨¡å‹</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ éšè—è¾“å…¥ -->
    <input type="file" id="attachmentFileInput" accept="image/*,audio/*,video/*,application/*,text/*" multiple
        class="hidden">

    <!-- éšè—çš„æ¨¡å‹é€‰æ‹©å™¨ï¼ˆä»…ä¾›JavaScriptä½¿ç”¨ï¼‰ -->
    <select id="modelSelect" class="hidden">
        <option value="loading">åŠ è½½ä¸­...</option>
    </select>



    <script id="chatFunctionality">
        // é…ç½®MathJax
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: { '[+]': ['ams', 'newcommand', 'autoload', 'color', 'physics', 'cancel', 'mathtools'] },
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams',
                processRefs: true,
                macros: {
                    // æ·»åŠ ä¸€äº›å¸¸ç”¨çš„æ•°å­¦å®
                    RR: "{\\mathbb{R}}",
                    CC: "{\\mathbb{C}}",
                    NN: "{\\mathbb{N}}",
                    ZZ: "{\\mathbb{Z}}",
                    QQ: "{\\mathbb{Q}}",
                    vec: ["\\mathbf{#1}", 1],
                    norm: ["\\left\\|#1\\right\\|", 1],
                    abs: ["\\left|#1\\right|", 1],
                    floor: ["\\left\\lfloor#1\\right\\rfloor", 1],
                    ceil: ["\\left\\lceil#1\\right\\rceil", 1]
                }
            },
            svg: {
                fontCache: 'global',
                scale: 1.2,
                minScale: 0.9,
                mtextInheritFont: true,
                displayAlign: 'center',
                displayIndent: '0'
            },
            chtml: {
                scale: 1.2,
                minScale: 0.9,
                mtextInheritFont: true,
                displayAlign: 'center',
                displayIndent: '0'
            },
            options: {
                processHtmlClass: 'markdown-content',
                ignoreHtmlClass: 'tex2jax_ignore',
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                renderActions: {
                    addMenu: [0, '', '']
                }
            },
            loader: {
                load: ['[tex]/ams', '[tex]/color', '[tex]/newcommand', '[tex]/autoload', '[tex]/cancel', '[tex]/mathtools']
            },
            startup: {
                pageReady: () => {
                    console.log('MathJaxé¡µé¢å‡†å¤‡å°±ç»ª');
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJaxåˆå§‹åŒ–å®Œæˆ');
                        // ç¡®ä¿MathJaxæ­£ç¡®åˆå§‹åŒ–åï¼Œé‡æ–°æ¸²æŸ“é¡µé¢ä¸Šå·²æœ‰çš„æ•°å­¦å…¬å¼
                        if (document.querySelector('.markdown-content')) {
                            console.log('é‡æ–°æ¸²æŸ“é¡µé¢ä¸Šçš„æ•°å­¦å…¬å¼');
                            MathJax.typesetPromise([document.body]).catch(err => {
                                console.error('åˆå§‹åŒ–æ—¶æ¸²æŸ“æ•°å­¦å…¬å¼å¤±è´¥:', err);
                            });
                        }
                    });
                },
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJaxå·²å‡†å¤‡å°±ç»ª');
                }
            }
        };

        // é…ç½®Marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function (code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                } else {
                    return code;
                }
            }
        });

        // ç®€åŒ–çš„Markdownæ¸²æŸ“å‡½æ•°
        function renderMarkdown(text) {
            console.log('æ¸²æŸ“Markdownæ–‡æœ¬:', text.substring(0, 100) + '...');

            // ç›´æ¥ä½¿ç”¨marked.jsæ¸²æŸ“ï¼Œä¸åšå¤æ‚çš„æ•°å­¦å…¬å¼ä¿æŠ¤
            // MathJaxä¼šåœ¨åç»­å¤„ç†æ•°å­¦å…¬å¼
            return marked.parse(text);
        }

        // æ¸²æŸ“æ¶ˆæ¯å†…å®¹çš„å‡½æ•°
        function renderMessageContent(text, isMarkdown = true) {
            if (!text) return '';

            if (isMarkdown) {
                const html = renderMarkdown(text);
                return `<div class="markdown-content">${html}</div>`;
            } else {
                // ç®€å•çš„æ–‡æœ¬å¤„ç†ï¼Œä¿ç•™æ¢è¡Œ
                return text.replace(/\n/g, '<br>');
            }
        }

        // å¤„ç†ä»£ç é«˜äº®çš„å‡½æ•°
        function highlightCode(element) {
            // å¯¹æ‰€æœ‰pre codeå…ƒç´ åº”ç”¨è¯­æ³•é«˜äº®
            element.querySelectorAll('pre code').forEach((codeBlock) => {
                Prism.highlightElement(codeBlock);
            });
        }

        // ä¼˜åŒ–çš„æ•°å­¦å…¬å¼æ¸²æŸ“å‡½æ•°
        function renderMath(element) {
            console.log('å¼€å§‹æ¸²æŸ“æ•°å­¦å…¬å¼');

            // æ£€æŸ¥æ˜¯å¦åŒ…å«æ•°å­¦å…¬å¼
            const text = element.textContent || element.innerText || '';
            const hasMath = /\$|\\\(|\\\[|\\int|\\sum|\\frac|\\sqrt|\\alpha|\\beta|\\gamma|\\pi|\\theta|\\phi|\\psi|\\omega/.test(text);

            if (!hasMath) {
                console.log('æœªæ£€æµ‹åˆ°æ•°å­¦å…¬å¼æ ‡è®°ï¼Œè·³è¿‡æ¸²æŸ“');
                return;
            }

            if (window.MathJax && window.MathJax.typesetPromise) {
                // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„æ¸²æŸ“ç»“æœ
                element.querySelectorAll('mjx-container').forEach(container => {
                    if (container.parentNode) {
                        container.remove();
                    }
                });

                window.MathJax.typesetPromise([element]).then(() => {
                    console.log('MathJaxæ¸²æŸ“å®Œæˆ');

                    // ä¼˜åŒ–æ¸²æŸ“åçš„æ˜¾ç¤ºæ•ˆæœ
                    element.querySelectorAll('mjx-container[display="block"]').forEach(container => {
                        // ç¡®ä¿å—çº§å…¬å¼å±…ä¸­æ˜¾ç¤º
                        const parent = container.parentElement;
                        if (parent && !parent.style.textAlign) {
                            parent.style.textAlign = 'center';
                        }

                        // å¤„ç†é•¿å…¬å¼çš„æ»šåŠ¨
                        if (container.scrollWidth > container.clientWidth) {
                            container.style.overflowX = 'auto';
                            container.style.overflowY = 'hidden';
                        }
                    });

                    // ä¸ºè¡Œå†…å…¬å¼æ·»åŠ é€‚å½“çš„é—´è·
                    element.querySelectorAll('mjx-container[display="inline"]').forEach(container => {
                        container.style.verticalAlign = 'middle';
                    });

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    if (typeof scrollToBottom === 'function') {
                        setTimeout(scrollToBottom, 150);
                    }

                    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥æ¸²æŸ“å®Œæˆ
                    element.dispatchEvent(new CustomEvent('mathRendered', {
                        detail: { element: element }
                    }));

                }).catch((err) => {
                    console.error('MathJaxæ¸²æŸ“é”™è¯¯:', err);

                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'math-error';
                    errorDiv.innerHTML = `
                        <strong>æ•°å­¦å…¬å¼æ¸²æŸ“å¤±è´¥</strong><br>
                        <small>${err.message}</small><br>
                        <em>è¯·æ£€æŸ¥å…¬å¼è¯­æ³•æ˜¯å¦æ­£ç¡®</em>
                    `;
                    element.appendChild(errorDiv);
                });
            } else {
                console.log('MathJaxæœªåŠ è½½ï¼Œå»¶è¿Ÿé‡è¯•');
                // MathJaxæœªåŠ è½½ï¼Œå»¶è¿Ÿé‡è¯•ï¼Œæœ€å¤šé‡è¯•5æ¬¡
                if (!element._mathRetryCount) {
                    element._mathRetryCount = 0;
                }

                if (element._mathRetryCount < 5) {
                    element._mathRetryCount++;
                    setTimeout(() => renderMath(element), 500);
                } else {
                    console.error('MathJaxåŠ è½½å¤±è´¥ï¼Œåœæ­¢é‡è¯•');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'math-error';
                    errorDiv.textContent = 'MathJaxåŠ è½½å¤±è´¥ï¼Œæ— æ³•æ¸²æŸ“æ•°å­¦å…¬å¼';
                    element.appendChild(errorDiv);
                }
            }
        }

        // å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ‰€æœ‰æ•°å­¦å…¬å¼çš„è¾…åŠ©å‡½æ•°
        function forceRerenderMath() {
            console.log('å¼ºåˆ¶é‡æ–°æ¸²æŸ“æ‰€æœ‰æ•°å­¦å…¬å¼');
            if (window.MathJax && window.MathJax.typesetPromise) {
                const mathElements = document.querySelectorAll('.markdown-content');
                if (mathElements.length > 0) {
                    window.MathJax.typesetPromise(Array.from(mathElements)).then(() => {
                        console.log('å¼ºåˆ¶é‡æ–°æ¸²æŸ“å®Œæˆ');
                    }).catch((err) => {
                        console.error('å¼ºåˆ¶é‡æ–°æ¸²æŸ“å¤±è´¥:', err);
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const uploadAttachmentBtn = document.getElementById('uploadAttachmentBtn');
            const attachmentFileInput = document.getElementById('attachmentFileInput');
            const previewArea = document.getElementById('previewArea');
            const imagePreview = document.getElementById('imagePreview');
            const audioPreview = document.getElementById('audioPreview');
            const videoPreview = document.getElementById('videoPreview');
            const previewImage = document.getElementById('previewImage');
            const audioFileName = document.getElementById('audioFileName');
            const audioFileSize = document.getElementById('audioFileSize');
            const videoFileName = document.getElementById('videoFileName');
            const videoFileSize = document.getElementById('videoFileSize');
            const removeImageBtn = document.getElementById('removeImageBtn');
            const removeAudioBtn = document.getElementById('removeAudioBtn');
            const removeVideoBtn = document.getElementById('removeVideoBtn');
            const startVoiceBtn = document.getElementById('startVoiceBtn');
            const audioRecording = document.getElementById('audioRecording');
            const stopRecordingBtn = document.getElementById('stopRecordingBtn');
            // const clearChatBtn = document.getElementById('clearChatBtn'); // å·²åˆ é™¤æŒ‰é’®
            const modelSelect = document.getElementById('modelSelect');


            // è®¾ç½®ç›¸å…³å…ƒç´ 
            const headerTemperatureBtn = document.getElementById('headerTemperatureBtn');
            const headerTemperatureValue = document.getElementById('headerTemperatureValue');
            const headerSystemPromptBtn = document.getElementById('headerSystemPromptBtn');
            const systemPromptStatus = document.getElementById('systemPromptStatus');
            const systemPromptIcon = document.getElementById('systemPromptIcon');

            // System Prompt å¼¹çª—å…ƒç´ 
            const systemPromptModal = document.getElementById('systemPromptModal');
            const closeSystemPromptBtn = document.getElementById('closeSystemPromptBtn');
            const systemPromptInput = document.getElementById('systemPromptInput');
            const saveSystemPromptBtn = document.getElementById('saveSystemPromptBtn');
            const clearSystemPromptBtn = document.getElementById('clearSystemPromptBtn');

            // Temperature å¼¹çª—å…ƒç´ 
            const temperatureModal = document.getElementById('temperatureModal');
            const closeTemperatureBtn = document.getElementById('closeTemperatureBtn');
            const temperatureSlider = document.getElementById('temperatureSlider');
            const temperatureValue = document.getElementById('temperatureValue');
            const saveTemperatureBtn = document.getElementById('saveTemperatureBtn');

            let isRecording = false;
            let selectedImage = null;
            let selectedAudio = null;
            let selectedVideo = null;
            let mediaRecorder = null;
            let recordedChunks = [];

            // è®¾ç½®ç›¸å…³å˜é‡
            let systemPrompt = '';
            let temperature = 0.7;

            // æ›´æ–°ç•Œé¢çŠ¶æ€æ˜¾ç¤º
            function updateUIStatus() {
                // æ›´æ–°temperatureæ˜¾ç¤º
                headerTemperatureValue.textContent = temperature;

                // æ›´æ–°system promptçŠ¶æ€
                if (systemPrompt && systemPrompt.trim()) {
                    systemPromptStatus.textContent = 'å·²è®¾ç½®';
                    systemPromptIcon.className = 'ri-chat-settings-fill text-sm text-blue-500 mr-1';
                    headerSystemPromptBtn.classList.add('bg-blue-50', 'border', 'border-blue-200');
                    headerSystemPromptBtn.classList.remove('bg-gray-100');
                } else {
                    systemPromptStatus.textContent = 'ç³»ç»Ÿæç¤º';
                    systemPromptIcon.className = 'ri-chat-settings-line text-sm text-gray-500 mr-1';
                    headerSystemPromptBtn.classList.remove('bg-blue-50', 'border', 'border-blue-200');
                    headerSystemPromptBtn.classList.add('bg-gray-100');
                }
            }
            let currentModel = 'deepseek-ai/DeepSeek-V2.5';
            let conversationHistory = [];
            let currentSessionId = null;
            let sessionsData = [];
            let currentPage = 1;
            let isLoadingSessions = false;

            // æ¨¡å‹å›¾æ ‡å’Œæè¿°æ˜ å°„
            const modelDisplayInfo = {
                'deepseek-ai/DeepSeek-V2.5': {
                    icon: 'ğŸ§ ',
                    description: 'æ·±åº¦æ¨ç†ä¸“å®¶'
                },
                'Qwen/Qwen2.5-7B-Instruct': {
                    icon: 'ğŸ”®',
                    description: 'æ™ºèƒ½é—®ç­”åŠ©æ‰‹'
                },
                'meta-llama/llama-4-scout-17b-16e-instruct': {
                    icon: 'ğŸ¦™',
                    description: 'å¤šæ¨¡æ€å¤§å¸ˆ'
                },
                'meta-llama/llama-4-maverick-17b-128e-instruct': {
                    icon: 'ğŸš€',
                    description: 'åˆ›æ–°å¯¹è¯ä¸“å®¶'
                }
            };

            // åŠ è½½å¯ç”¨æ¨¡å‹
            async function loadModels() {
                try {
                    const response = await fetch('/api/models');
                    const data = await response.json();

                    if (data.success && data.models.length > 0) {
                        modelSelect.innerHTML = '';

                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.id;

                            // è·å–æ¨¡å‹æ˜¾ç¤ºä¿¡æ¯
                            const displayInfo = modelDisplayInfo[model.id] || {
                                icon: 'ğŸ¤–',
                                description: 'æ™ºèƒ½åŠ©æ‰‹'
                            };

                            // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬
                            const modelName = model.name.replace(/\(æ–‡æœ¬\)|\(å¤šæ¨¡æ€\)/g, '').trim();
                            const supportText = model.supports_image ? ' (å¤šæ¨¡æ€)' : ' (æ–‡æœ¬)';

                            option.textContent = `${displayInfo.icon} ${modelName} - ${displayInfo.description}${supportText}`;

                            if (model.default || model.id === currentModel) {
                                option.selected = true;
                                currentModel = model.id;
                            }
                            modelSelect.appendChild(option);
                        });

                        console.log('å·²åŠ è½½æ¨¡å‹:', data.models.length, 'ä¸ª');
                    } else {
                        modelSelect.innerHTML = '<option value="">æ— å¯ç”¨æ¨¡å‹</option>';
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¨¡å‹å¤±è´¥:', error);
                    modelSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                }
            }

            // æ¨¡å‹é€‰æ‹©äº‹ä»¶
            modelSelect.addEventListener('change', function () {
                currentModel = this.value;
                console.log('åˆ‡æ¢æ¨¡å‹:', currentModel);
            });

            // é¡µé¢åŠ è½½æ—¶åŠ è½½æ¨¡å‹å’Œå†å²è®°å½•
            loadModels();
            loadSessions();

            // å†å²å¯¹è¯ç›¸å…³çš„DOMå…ƒç´ 
            const sidebar = document.getElementById('sidebar');
            const toggleSidebar = document.getElementById('toggleSidebar');
            const closeSidebar = document.getElementById('closeSidebar');
            // const historyToggle = document.getElementById('historyToggle'); // å·²åˆ é™¤æŒ‰é’®
            // const newChatBtn = document.getElementById('newChatBtn'); // å·²åˆ é™¤æŒ‰é’®
            const searchInput = document.getElementById('searchInput');
            const sessionsList = document.getElementById('sessionsList');
            const totalSessions = document.getElementById('totalSessions');
            const totalMessages = document.getElementById('totalMessages');
            const loadMoreSessions = document.getElementById('loadMoreSessions');

            // å†å²å¯¹è¯ç›¸å…³åŠŸèƒ½

            // åŠ è½½ä¼šè¯åˆ—è¡¨
            async function loadSessions(page = 1, reset = false) {
                if (isLoadingSessions) return;
                isLoadingSessions = true;

                try {
                    const response = await fetch(`/api/sessions?page=${page}&limit=20`);
                    const data = await response.json();

                    if (data.success) {
                        if (reset) {
                            sessionsData = data.sessions;
                            sessionsList.innerHTML = '';
                        } else {
                            sessionsData = [...sessionsData, ...data.sessions];
                        }

                        renderSessions(data.sessions, !reset);
                        updateStatistics(data.statistics);

                        // æ˜¾ç¤º/éšè—"åŠ è½½æ›´å¤š"æŒ‰é’®
                        if (data.pagination.has_more) {
                            loadMoreSessions.classList.remove('hidden');
                            currentPage = page;
                        } else {
                            loadMoreSessions.classList.add('hidden');
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                } finally {
                    isLoadingSessions = false;
                }
            }

            // æ¸²æŸ“ä¼šè¯åˆ—è¡¨
            function renderSessions(sessions, append = false) {
                if (!append) {
                    sessionsList.innerHTML = '';
                }

                sessions.forEach(session => {
                    const sessionDiv = document.createElement('div');
                    sessionDiv.className = `session-item p-3 mb-2 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors ${currentSessionId === session.id ? 'bg-blue-50 border-2 border-blue-200' : ''}`;
                    sessionDiv.dataset.sessionId = session.id;

                    const timeStr = new Date(session.updated_at).toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    sessionDiv.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-800 truncate">${session.title}</h4>
                                <div class="flex items-center mt-1 text-xs text-gray-500">
                                    <i class="ri-message-3-line mr-1"></i>
                                    <span>${session.message_count} æ¡æ¶ˆæ¯</span>
                                    <span class="mx-2">â€¢</span>
                                    <span>${timeStr}</span>
                                </div>
                                ${session.model ? `<div class="mt-1 text-xs text-blue-600">${session.model.split('/').pop()}</div>` : ''}
                            </div>
                            <div class="flex items-center space-x-1 ml-2">
                                <button class="session-rename p-1 text-gray-400 hover:text-gray-600 rounded" title="é‡å‘½å">
                                    <i class="ri-edit-2-line text-xs"></i>
                                </button>
                                <button class="session-delete p-1 text-gray-400 hover:text-red-600 rounded" title="åˆ é™¤">
                                    <i class="ri-delete-bin-line text-xs"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    // ç‚¹å‡»ä¼šè¯é¡¹
                    sessionDiv.addEventListener('click', (e) => {
                        if (e.target.closest('.session-rename') || e.target.closest('.session-delete')) {
                            return;
                        }
                        loadSession(session.id);
                    });

                    // é‡å‘½åæŒ‰é’®
                    sessionDiv.querySelector('.session-rename').addEventListener('click', (e) => {
                        e.stopPropagation();
                        renameSession(session.id, session.title);
                    });

                    // åˆ é™¤æŒ‰é’®
                    sessionDiv.querySelector('.session-delete').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteSession(session.id);
                    });

                    sessionsList.appendChild(sessionDiv);
                });
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            function updateStatistics(stats) {
                totalSessions.textContent = stats.total_sessions;
                totalMessages.textContent = stats.total_messages;
            }

            // åˆ›å»ºæ–°å¯¹è¯
            async function createNewSession() {
                try {
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: currentModel
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        currentSessionId = data.session.id;
                        conversationHistory = [];
                        clearChatDisplay();
                        loadSessions(1, true); // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨

                        // å…³é—­ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
                        if (window.innerWidth < 1024) {
                            sidebar.classList.add('-translate-x-full');
                        }
                    }
                } catch (error) {
                    console.error('åˆ›å»ºæ–°å¯¹è¯å¤±è´¥:', error);
                }
            }

            // åŠ è½½æŒ‡å®šä¼šè¯
            async function loadSession(sessionId) {
                try {
                    const response = await fetch(`/api/sessions/${sessionId}`);
                    const data = await response.json();

                    if (data.success) {
                        currentSessionId = sessionId;
                        conversationHistory = [];
                        clearChatDisplay();

                        // æ¸²æŸ“å†å²æ¶ˆæ¯
                        data.messages.forEach(msg => {
                            if (msg.role === 'user') {
                                const userMessage = {
                                    role: 'user',
                                    text: msg.content,
                                    image: msg.image_data
                                };
                                conversationHistory.push(userMessage);
                                // æ ¹æ®å†…å®¹ç±»å‹ç¡®å®šåª’ä½“ç±»å‹
                                let image = null, audio = null, video = null;

                                if (msg.content_type === 'image') {
                                    image = msg.image_data;
                                } else if (msg.content_type === 'audio') {
                                    audio = msg.image_data; // image_dataå­—æ®µç°åœ¨å­˜å‚¨æ‰€æœ‰åª’ä½“æ•°æ®
                                } else if (msg.content_type === 'video') {
                                    video = msg.image_data;
                                }

                                displayUserMessage(msg.content, image, audio, video, msg.content_type);
                            } else if (msg.role === 'assistant') {
                                conversationHistory.push({
                                    role: 'assistant',
                                    text: msg.content
                                });
                                displayBotMessage(msg.content, msg.provider);
                            }
                        });

                        // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„é€‰ä¸­çŠ¶æ€
                        document.querySelectorAll('.session-item').forEach(item => {
                            if (item.dataset.sessionId === sessionId) {
                                item.classList.add('bg-blue-50', 'border-2', 'border-blue-200');
                            } else {
                                item.classList.remove('bg-blue-50', 'border-2', 'border-blue-200');
                            }
                        });

                        // å…³é—­ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
                        if (window.innerWidth < 1024) {
                            sidebar.classList.add('-translate-x-full');
                        }

                        scrollToBottom();
                    }
                } catch (error) {
                    console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
                }
            }

            // é‡å‘½åä¼šè¯
            async function renameSession(sessionId, currentTitle) {
                const newTitle = prompt('è¯·è¾“å…¥æ–°çš„å¯¹è¯æ ‡é¢˜:', currentTitle);
                if (newTitle && newTitle !== currentTitle) {
                    try {
                        const response = await fetch(`/api/sessions/${sessionId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: newTitle
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            loadSessions(1, true); // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
                        }
                    } catch (error) {
                        console.error('é‡å‘½åä¼šè¯å¤±è´¥:', error);
                    }
                }
            }

            // åˆ é™¤ä¼šè¯
            async function deleteSession(sessionId) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    try {
                        const response = await fetch(`/api/sessions/${sessionId}`, {
                            method: 'DELETE'
                        });

                        const data = await response.json();
                        if (data.success) {
                            if (currentSessionId === sessionId) {
                                currentSessionId = null;
                                conversationHistory = [];
                                clearChatDisplay();
                            }
                            loadSessions(1, true); // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
                        }
                    } catch (error) {
                        console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                    }
                }
            }

            // æ¸…ç©ºèŠå¤©æ˜¾ç¤º
            function clearChatDisplay() {
                chatContainer.innerHTML = `
                    <!-- æ¬¢è¿æ¶ˆæ¯ -->
                    <div class="flex mb-4">
                        <div class="message-bubble bot-message p-3 text-gray-800">
                            <p>æˆ‘æ˜¯ å¤šæ¨¡æ€æœºå™¨äººï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼</p>
                            <p class="mt-2">æˆ‘å¯ä»¥å¸®ä½ å†™ä»£ç ã€è¯»æ–‡ä»¶ã€å†™ä½œå„ç§åˆ›æ„å†…å®¹ï¼Œè¯·æŠŠä½ çš„ä»»åŠ¡äº¤ç»™æˆ‘å§</p>
                        </div>
                    </div>
                `;
            }

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            function displayUserMessage(text, image, audio, video, contentType) {
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex mb-4 justify-end';

                let messageContent = '';
                if (text) {
                    messageContent += `<div>${text}</div>`;
                }

                if (image) {
                    messageContent += `<img src="${image}" class="max-w-xs rounded mt-2 block">`;
                }

                if (audio) {
                    messageContent += `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-2 max-w-xs">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="ri-file-music-line text-blue-600 text-sm"></i>
                                </div>
                                <div class="text-sm font-medium text-gray-800">éŸ³é¢‘æ–‡ä»¶</div>
                            </div>
                            <audio controls class="w-full">
                                <source src="${audio}" type="audio/webm">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                            </audio>
                        </div>`;
                }

                if (video) {
                    messageContent += `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mt-2">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="ri-video-line text-green-600 text-sm"></i>
                                </div>
                                <div class="text-sm font-medium text-gray-800">è§†é¢‘æ–‡ä»¶</div>
                            </div>
                            <video controls class="w-full max-w-xs rounded">
                                <source src="${video}" type="video/mp4">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                            </video>
                        </div>`;
                }

                userMessageDiv.innerHTML = `
                    <div class="message-bubble user-message p-3 text-gray-800">
                        ${messageContent}
                    </div>
                `;

                chatContainer.appendChild(userMessageDiv);
            }

            // æ˜¾ç¤ºæœºå™¨äººæ¶ˆæ¯ï¼ˆæ”¯æŒMarkdownæ¸²æŸ“ï¼‰
            function displayBotMessage(text, provider) {
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'flex mb-4';

                const providerBadge = provider === 'groq' ?
                    '<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">Groq ğŸ–¼ï¸</span>' :
                    '<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">SiliconFlow ğŸ“</span>';

                // å§‹ç»ˆä½¿ç”¨Markdownæ¸²æŸ“ï¼Œç§»é™¤ä¸å¯é çš„hasMarkdownåˆ¤æ–­
                const contentHtml = renderMessageContent(text, true);

                botMessageDiv.innerHTML = `
                    <div class="message-bubble bot-message p-3 text-gray-800">
                        ${providerBadge}
                        <div class="mt-1">${contentHtml}</div>
                    </div>
                `;

                chatContainer.appendChild(botMessageDiv);

                // å§‹ç»ˆåº”ç”¨ä»£ç é«˜äº®å’Œæ•°å­¦å…¬å¼æ¸²æŸ“
                highlightCode(botMessageDiv);
                renderMath(botMessageDiv);
            }

            // ä¾§è¾¹æ æ§åˆ¶äº‹ä»¶
            toggleSidebar.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            closeSidebar.addEventListener('click', () => {
                sidebar.classList.add('-translate-x-full');
            });

            // historyToggle.addEventListener('click', () => {
            //     sidebar.classList.toggle('-translate-x-full');
            // }); // å·²åˆ é™¤æŒ‰é’®

            // æ–°å¯¹è¯æŒ‰é’®
            // newChatBtn.addEventListener('click', createNewSession); // å·²åˆ é™¤æŒ‰é’®

            // æœç´¢åŠŸèƒ½
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = searchInput.value.trim();
                    if (query) {
                        searchMessages(query);
                    } else {
                        loadSessions(1, true);
                    }
                }, 300);
            });

            // æœç´¢æ¶ˆæ¯
            async function searchMessages(query) {
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.success) {
                        sessionsList.innerHTML = '';

                        if (data.results.length === 0) {
                            sessionsList.innerHTML = '<div class="p-4 text-center text-gray-500">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</div>';
                            return;
                        }

                        // æŒ‰ä¼šè¯åˆ†ç»„æ˜¾ç¤ºæœç´¢ç»“æœ
                        const groupedResults = {};
                        data.results.forEach(msg => {
                            if (!groupedResults[msg.session_id]) {
                                groupedResults[msg.session_id] = {
                                    session_title: msg.session_title,
                                    messages: []
                                };
                            }
                            groupedResults[msg.session_id].messages.push(msg);
                        });

                        Object.entries(groupedResults).forEach(([sessionId, sessionData]) => {
                            const sessionDiv = document.createElement('div');
                            sessionDiv.className = 'p-3 mb-2 bg-gray-50 hover:bg-gray-100 rounded-lg cursor-pointer transition-colors';
                            sessionDiv.dataset.sessionId = sessionId;

                            const previewText = sessionData.messages[0].content.substring(0, 100) + (sessionData.messages[0].content.length > 100 ? '...' : '');

                            sessionDiv.innerHTML = `
                                <div class="text-sm font-medium text-gray-800 mb-1">${sessionData.session_title}</div>
                                <div class="text-xs text-gray-600 mb-2">${previewText}</div>
                                <div class="text-xs text-blue-600">æ‰¾åˆ° ${sessionData.messages.length} æ¡åŒ¹é…æ¶ˆæ¯</div>
                            `;

                            sessionDiv.addEventListener('click', () => {
                                loadSession(sessionId);
                                searchInput.value = '';
                            });

                            sessionsList.appendChild(sessionDiv);
                        });
                    }
                } catch (error) {
                    console.error('æœç´¢å¤±è´¥:', error);
                }
            }

            // åŠ è½½æ›´å¤šä¼šè¯
            loadMoreSessions.addEventListener('click', () => {
                loadSessions(currentPage + 1);
            });

            // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
            messageInput.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                updateSendButton();
            });

            // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
            function updateSendButton() {
                if (messageInput.value.trim() || selectedImage || selectedAudio || selectedVideo) {
                    sendMessageBtn.classList.remove('bg-gray-200', 'text-gray-500');
                    sendMessageBtn.classList.add('bg-primary', 'text-white');
                } else {
                    sendMessageBtn.classList.add('bg-gray-200', 'text-gray-500');
                    sendMessageBtn.classList.remove('bg-primary', 'text-white');
                }
            }

            // å‘é€æ¶ˆæ¯
            async function sendMessage() {
                const messageText = messageInput.value.trim();

                if (!messageText && !selectedImage && !selectedAudio && !selectedVideo) return;

                // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯å¯¹è±¡
                const userMessage = {
                    text: messageText,
                    image: selectedImage,
                    audio: selectedAudio,
                    video: selectedVideo
                };

                // ä½¿ç”¨æ–°çš„ç±»å‹åŒ–æ¶ˆæ¯ç³»ç»Ÿ
                const userMessageDiv = createTypedMessage(userMessage, true, { showTypeIndicator: true });
                chatContainer.appendChild(userMessageDiv);

                // ä¿å­˜åˆ°å¯¹è¯å†å²
                conversationHistory.push({
                    role: 'user',
                    text: messageText,
                    image: selectedImage,
                    audio: selectedAudio,
                    video: selectedVideo
                });

                // æ¸…ç©ºè¾“å…¥æ¡†å’Œé¢„è§ˆ
                messageInput.value = '';
                messageInput.style.height = 'auto';
                selectedImage = null;
                selectedAudio = null;
                selectedVideo = null;
                previewArea.classList.add('hidden');
                imagePreview.classList.add('hidden');
                audioPreview.classList.add('hidden');
                videoPreview.classList.add('hidden');

                // æ˜¾ç¤ºç°ä»£åŠ è½½çŠ¶æ€
                const loadingDiv = showLoadingState(LoadingType.CHAT, 'æ­£åœ¨ç”Ÿæˆå›å¤...', true);
                loadingDiv.classList.add('typing-message'); // æ·»åŠ ç±»åä»¥ä¾¿åç»­è¯†åˆ«

                try {
                    // å¦‚æœå½“å‰æ²¡æœ‰ä¼šè¯ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯
                    if (!currentSessionId) {
                        const sessionResponse = await fetch('/api/sessions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                title: messageText.length > 30 ? messageText.substring(0, 30) + '...' : messageText,
                                model: currentModel
                            })
                        });

                        const sessionData = await sessionResponse.json();
                        if (sessionData.success) {
                            currentSessionId = sessionData.session.id;
                            loadSessions(1, true); // é‡æ–°åŠ è½½ä¼šè¯åˆ—è¡¨
                        }
                    }

                    // å‘é€åˆ°åç«¯API
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: conversationHistory,
                            model: currentModel,
                            session_id: currentSessionId,
                            system_prompt: systemPrompt,
                            temperature: temperature
                        })
                    });

                    const data = await response.json();

                    // ç§»é™¤loadingçŠ¶æ€
                    const typingMessages = document.getElementsByClassName('typing-message');
                    if (typingMessages.length > 0) {
                        hideLoadingState(typingMessages[0]);
                    }

                    if (response.ok && data.success) {
                        // æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢äº†æ¨¡å‹
                        if (data.model && data.model !== currentModel) {
                            // æ˜¾ç¤ºæ¨¡å‹åˆ‡æ¢æç¤º
                            const switchNoticeDiv = document.createElement('div');
                            switchNoticeDiv.className = 'flex mb-2';
                            switchNoticeDiv.innerHTML = `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 text-sm text-blue-700">
                                    <i class="ri-information-line"></i> æ£€æµ‹åˆ°å›¾ç‰‡å†…å®¹ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°å¤šæ¨¡æ€æ¨¡å‹: ${data.model}
                                </div>
                            `;
                            chatContainer.appendChild(switchNoticeDiv);
                        }

                        // æ£€æµ‹Botå›å¤ç±»å‹
                        const context = {
                            isAnalysis: selectedImage || selectedAudio || selectedVideo,
                            isSearch: false,
                            showTypeIndicator: true
                        };

                        const botMessage = { text: data.response };
                        const botMessageType = detectBotResponseType(data.response, context);

                        // åˆ›å»ºBotæ¶ˆæ¯å®¹å™¨
                        const botMessageDiv = document.createElement('div');
                        botMessageDiv.className = 'flex mb-4';

                        // æ˜¾ç¤ºä½¿ç”¨çš„æœåŠ¡æä¾›å•†ä¿¡æ¯
                        const providerBadge = data.provider === 'groq' ?
                            '<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full mr-2">Groq ğŸ–¼ï¸</span>' :
                            '<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-2">SiliconFlow ğŸ“</span>';

                        const typeIndicator = createTypeIndicator(botMessageType);

                        botMessageDiv.innerHTML = `
                            <div class="message-bubble bot-message message-type-${botMessageType} p-3">
                                <div class="message-content-group">
                                    ${typeIndicator}
                                    ${providerBadge}
                                    <div class="text-content mt-1">
                                        <span class="typewriter-text"></span><span class="typewriter-cursor"></span>
                                    </div>
                                </div>
                            </div>
                        `;

                        chatContainer.appendChild(botMessageDiv);
                        scrollToBottom();

                        // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå›å¤
                        const messageElement = botMessageDiv.querySelector('.text-content');
                        await typewriterEffect(messageElement, data.response, 25);

                        // ä¿å­˜æœºå™¨äººå›å¤åˆ°å†å²
                        conversationHistory.push({
                            role: 'assistant',
                            text: data.response
                        });
                    } else {
                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        const errorMessageDiv = document.createElement('div');
                        errorMessageDiv.className = 'flex mb-4';
                        errorMessageDiv.innerHTML = `
                            <div class="message-bubble bot-message p-3 text-red-600">
                                âŒ æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}
                            </div>
                        `;
                        chatContainer.appendChild(errorMessageDiv);
                    }
                } catch (error) {
                    // ç§»é™¤loadingçŠ¶æ€
                    const typingMessages = document.getElementsByClassName('typing-message');
                    if (typingMessages.length > 0) {
                        hideLoadingState(typingMessages[0]);
                    }

                    // æ˜¾ç¤ºç½‘ç»œé”™è¯¯
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'flex mb-4';
                    errorMessageDiv.innerHTML = `
                        <div class="message-bubble bot-message p-3 text-red-600">
                            âŒ ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (${error.message})
                        </div>
                    `;
                    chatContainer.appendChild(errorMessageDiv);
                }

                scrollToBottom();
                updateSendButton();
            }

            // æ»šåŠ¨åˆ°åº•éƒ¨
            function scrollToBottom() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // æ‰“å­—æœºæ•ˆæœå‡½æ•°ï¼ˆæ”¯æŒMarkdownæ¸²æŸ“ï¼‰
            function typewriterEffect(element, text, speed = 30) {
                return new Promise((resolve) => {
                    const textSpan = element.querySelector('.typewriter-text');
                    const cursor = element.querySelector('.typewriter-cursor');

                    // æ£€æŸ¥æ˜¯å¦åŒ…å«Markdownæ ¼å¼æˆ–æ•°å­¦å…¬å¼
                    const hasMarkdown = /[#*`|\\]/.test(text) ||
                        text.includes('```') ||
                        text.includes('|') ||
                        text.includes('$$') ||
                        text.includes('\\(') ||
                        text.includes('\\[') ||
                        /\$[^$]+\$/.test(text);

                    if (hasMarkdown) {
                        // ä½¿ç”¨Markdownæ¸²æŸ“
                        const renderedContent = renderMessageContent(text, true);

                        // ç§»é™¤æ‰“å­—æœºç»“æ„ï¼Œç›´æ¥æ˜¾ç¤ºæ¸²æŸ“çš„å†…å®¹
                        element.innerHTML = renderedContent;

                        // åº”ç”¨ä»£ç é«˜äº®
                        highlightCode(element);

                        // æ¸²æŸ“æ•°å­¦å…¬å¼
                        renderMath(element);

                        resolve();
                    } else {
                        // åŸæœ‰çš„æ‰“å­—æœºæ•ˆæœ
                        let i = 0;

                        function type() {
                            if (i < text.length) {
                                // å¤„ç†æ¢è¡Œç¬¦
                                if (text.charAt(i) === '\n') {
                                    textSpan.innerHTML += '<br>';
                                } else {
                                    textSpan.innerHTML += text.charAt(i);
                                }
                                i++;
                                scrollToBottom(); // åœ¨æ‰“å­—è¿‡ç¨‹ä¸­ä¿æŒæ»šåŠ¨åˆ°åº•éƒ¨
                                setTimeout(type, speed);
                            } else {
                                // æ‰“å­—å®Œæˆåç§»é™¤å…‰æ ‡
                                if (cursor) {
                                    cursor.remove();
                                }
                                resolve();
                            }
                        }

                        type();
                    }
                });
            }

            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendMessageBtn.addEventListener('click', sendMessage);

            // å›è½¦é”®å‘é€æ¶ˆæ¯
            messageInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ç»Ÿä¸€é™„ä»¶ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            uploadAttachmentBtn.addEventListener('click', function () {
                attachmentFileInput.click();
            });

            // ç»Ÿä¸€é™„ä»¶æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            attachmentFileInput.addEventListener('change', async function () {
                if (this.files && this.files.length > 0) {
                    const file = this.files[0]; // å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶

                    // æ£€æµ‹æ–‡ä»¶ç±»å‹
                    const fileType = getFileType(file);

                    if (!fileType) {
                        alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                        return;
                    }

                    // æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†
                    switch (fileType) {
                        case 'image':
                            await handleImageUpload(file);
                            break;
                        case 'audio':
                            await handleAudioUpload(file);
                            break;
                        case 'video':
                            await handleVideoUpload(file);
                            break;
                        default:
                            alert('æš‚ä¸æ”¯æŒè¯¥æ–‡ä»¶ç±»å‹');
                    }
                }
            });

            // æ–‡ä»¶ç±»å‹æ£€æµ‹å‡½æ•°
            function getFileType(file) {
                const imageTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
                const audioTypes = ['audio/mp3', 'audio/wav', 'audio/ogg', 'audio/m4a', 'audio/aac', 'audio/flac', 'audio/webm'];
                const videoTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/wmv', 'video/flv', 'video/webm', 'video/mkv'];

                if (imageTypes.includes(file.type) || file.name.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
                    return 'image';
                } else if (audioTypes.includes(file.type) || file.name.match(/\.(mp3|wav|ogg|m4a|aac|flac|webm)$/i)) {
                    return 'audio';
                } else if (videoTypes.includes(file.type) || file.name.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv)$/i)) {
                    return 'video';
                }
                return null;
            }

            // å›¾ç‰‡ä¸Šä¼ å¤„ç†å‡½æ•°
            async function handleImageUpload(file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ4MBé™åˆ¶ï¼‰
                if (file.size > 4 * 1024 * 1024) {
                    alert(`å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œæœ€å¤§æ”¯æŒ4MB`);
                    return;
                }

                // è‡ªåŠ¨åˆ‡æ¢åˆ°å¤šæ¨¡æ€æ¨¡å‹ï¼ˆllamaï¼‰
                switchToMultimodalModel();

                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-loader-4-line animate-spin"></i></div>';
                uploadAttachmentBtn.disabled = true;

                // æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€æç¤º
                const uploadToast = showUploadToast('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');

                try {
                    // ä½¿ç”¨FormDataä¸Šä¼ åˆ°åç«¯
                    const formData = new FormData();
                    formData.append('image', file);

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        selectedImage = result.image_data;
                        previewImage.src = selectedImage;
                        previewArea.classList.remove('hidden');
                        imagePreview.classList.remove('hidden');
                        updateSendButton();
                    } else {
                        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + result.error);
                    }
                } catch (error) {
                    alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message);
                } finally {
                    // æ¢å¤ä¸Šä¼ æŒ‰é’®
                    uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-attachment-2"></i></div>';
                    uploadAttachmentBtn.disabled = false;
                    hideUploadToast(uploadToast);
                }
            }

            // éŸ³é¢‘ä¸Šä¼ å¤„ç†å‡½æ•°
            async function handleAudioUpload(file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ10MBé™åˆ¶ï¼‰
                if (file.size > 10 * 1024 * 1024) {
                    alert(`éŸ³é¢‘æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œæœ€å¤§æ”¯æŒ10MB`);
                    return;
                }

                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-loader-4-line animate-spin"></i></div>';
                uploadAttachmentBtn.disabled = true;

                const uploadToast = showUploadToast('æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...');

                try {
                    // ä½¿ç”¨FormDataä¸Šä¼ åˆ°åç«¯
                    const formData = new FormData();
                    formData.append('audio', file);

                    const response = await fetch('/api/upload/audio', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        selectedAudio = result.audio_data;
                        audioFileName.textContent = file.name;
                        audioFileSize.textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                        previewArea.classList.remove('hidden');
                        audioPreview.classList.remove('hidden');
                        updateSendButton();
                    } else {
                        alert('éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ' + result.error);
                    }
                } catch (error) {
                    alert('éŸ³é¢‘ä¸Šä¼ å¤±è´¥: ' + error.message);
                } finally {
                    // æ¢å¤ä¸Šä¼ æŒ‰é’®
                    uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-attachment-2"></i></div>';
                    uploadAttachmentBtn.disabled = false;
                    hideUploadToast(uploadToast);
                }
            }

            // è§†é¢‘ä¸Šä¼ å¤„ç†å‡½æ•°
            async function handleVideoUpload(file) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ50MBé™åˆ¶ï¼‰
                if (file.size > 50 * 1024 * 1024) {
                    alert(`è§†é¢‘æ–‡ä»¶è¿‡å¤§ (${(file.size / 1024 / 1024).toFixed(1)}MB)ï¼Œæœ€å¤§æ”¯æŒ50MB`);
                    return;
                }

                // è‡ªåŠ¨åˆ‡æ¢åˆ°å¤šæ¨¡æ€æ¨¡å‹ï¼ˆllamaï¼‰
                switchToMultimodalModel();

                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-loader-4-line animate-spin"></i></div>';
                uploadAttachmentBtn.disabled = true;

                const uploadToast = showUploadToast('æ­£åœ¨ä¸Šä¼ è§†é¢‘...');

                try {
                    // ä½¿ç”¨FormDataä¸Šä¼ åˆ°åç«¯
                    const formData = new FormData();
                    formData.append('video', file);

                    const response = await fetch('/api/upload/video', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        selectedVideo = result.video_data;
                        videoFileName.textContent = file.name;
                        videoFileSize.textContent = `${(file.size / 1024 / 1024).toFixed(1)} MB`;
                        previewArea.classList.remove('hidden');
                        videoPreview.classList.remove('hidden');
                        updateSendButton();
                    } else {
                        alert('è§†é¢‘ä¸Šä¼ å¤±è´¥: ' + result.error);
                    }
                } catch (error) {
                    alert('è§†é¢‘ä¸Šä¼ å¤±è´¥: ' + error.message);
                } finally {
                    // æ¢å¤ä¸Šä¼ æŒ‰é’®
                    uploadAttachmentBtn.innerHTML = '<div class="w-5 h-5 flex items-center justify-center"><i class="ri-attachment-2"></i></div>';
                    uploadAttachmentBtn.disabled = false;
                    hideUploadToast(uploadToast);
                }
            }

            // æ˜¾ç¤ºä¸Šä¼ æç¤º
            function showUploadToast(message) {
                const uploadToast = document.createElement('div');
                uploadToast.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                uploadToast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="spinner-loading w-4 h-4 border-white"></div>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(uploadToast);
                return uploadToast;
            }

            // éšè—ä¸Šä¼ æç¤º
            function hideUploadToast(uploadToast) {
                setTimeout(() => {
                    if (uploadToast && uploadToast.parentNode) {
                        uploadToast.remove();
                    }
                }, 2000);
            }

            // è‡ªåŠ¨åˆ‡æ¢åˆ°å¤šæ¨¡æ€æ¨¡å‹
            function switchToMultimodalModel() {
                // æŸ¥æ‰¾llamaæ¨¡å‹
                const modelSelect = document.getElementById('modelSelect');
                const llamaOption = Array.from(modelSelect.options).find(option =>
                    option.value.includes('llama') || option.value.includes('Llama')
                );

                if (llamaOption && currentModel !== llamaOption.value) {
                    const previousModel = currentModel;
                    currentModel = llamaOption.value;
                    modelSelect.value = currentModel;

                    // æ˜¾ç¤ºæ¨¡å‹åˆ‡æ¢æç¤º
                    showModelSwitchToast(previousModel, currentModel);
                    console.log('è‡ªåŠ¨åˆ‡æ¢æ¨¡å‹:', previousModel, '->', currentModel);
                }
            }

            // æ˜¾ç¤ºæ¨¡å‹åˆ‡æ¢æç¤º
            function showModelSwitchToast(fromModel, toModel) {
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="ri-refresh-line"></i>
                        <span>å·²è‡ªåŠ¨åˆ‡æ¢åˆ°å¤šæ¨¡æ€æ¨¡å‹</span>
                    </div>
                `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    if (toast && toast.parentNode) {
                        toast.remove();
                    }
                }, 3000);
            }

            // ç§»é™¤é¢„è§ˆå›¾ç‰‡
            removeImageBtn.addEventListener('click', function () {
                selectedImage = null;
                imagePreview.classList.add('hidden');
                if (!isRecording && !selectedAudio && !selectedVideo) {
                    previewArea.classList.add('hidden');
                }
                attachmentFileInput.value = '';
                updateSendButton();
            });



            // ç§»é™¤éŸ³é¢‘é¢„è§ˆ
            removeAudioBtn.addEventListener('click', function () {
                selectedAudio = null;
                audioPreview.classList.add('hidden');
                if (!isRecording && !selectedImage && !selectedVideo) {
                    previewArea.classList.add('hidden');
                }
                attachmentFileInput.value = '';
                updateSendButton();
            });

            // ç§»é™¤è§†é¢‘é¢„è§ˆ
            removeVideoBtn.addEventListener('click', function () {
                selectedVideo = null;
                videoPreview.classList.add('hidden');
                if (!isRecording && !selectedImage && !selectedAudio) {
                    previewArea.classList.add('hidden');
                }
                attachmentFileInput.value = '';
                updateSendButton();
            });

            // è¯­éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            startVoiceBtn.addEventListener('click', async function () {
                if (!isRecording) {
                    try {
                        // é¦–å…ˆå°è¯•ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³è¯†åˆ«API
                        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                            startSpeechRecognition();
                        } else {
                            // å›é€€åˆ°å½•éŸ³æ¨¡å¼
                            startAudioRecording();
                        }
                    } catch (error) {
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                        console.error('å½•éŸ³é”™è¯¯:', error);
                    }
                } else {
                    stopRecording();
                }
            });

            // è¯­éŸ³è¯†åˆ«åŠŸèƒ½
            function startSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();

                recognition.lang = 'zh-CN'; // ä¸­æ–‡
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;

                recognition.onstart = function () {
                    isRecording = true;
                    previewArea.classList.remove('hidden');
                    audioRecording.classList.remove('hidden');
                    console.log('å¼€å§‹è¯­éŸ³è¯†åˆ«...');
                };

                recognition.onresult = function (event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('è¯­éŸ³è¯†åˆ«ç»“æœ:', transcript);

                    // ç›´æ¥å°†è¯†åˆ«ç»“æœå¡«å…¥è¾“å…¥æ¡†
                    messageInput.value = transcript;
                    messageInput.focus();

                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showSuccessMessage(`ğŸ™ï¸ è¯­éŸ³è¯†åˆ«æˆåŠŸï¼è¯†åˆ«æ–‡å­—ï¼š${transcript.substring(0, 20)}${transcript.length > 20 ? '...' : ''}`);
                };

                recognition.onerror = function (event) {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);

                    let errorMessage = 'è¯­éŸ³è¯†åˆ«å¤±è´¥';
                    switch (event.error) {
                        case 'no-speech':
                            errorMessage = 'æ²¡æœ‰æ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•';
                            break;
                        case 'audio-capture':
                            errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£';
                            break;
                        case 'not-allowed':
                            errorMessage = 'éº¦å…‹é£æƒé™è¢«æ‹’ç»';
                            break;
                        case 'network':
                            errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                            break;
                        default:
                            errorMessage = `è¯­éŸ³è¯†åˆ«å¤±è´¥: ${event.error}`;
                    }

                    showErrorMessage(errorMessage);

                    // å›é€€åˆ°å½•éŸ³æ¨¡å¼
                    startAudioRecording();
                };

                recognition.onend = function () {
                    isRecording = false;
                    audioRecording.classList.add('hidden');
                    if (!selectedImage && !selectedAudio && !selectedVideo) {
                        previewArea.classList.add('hidden');
                    }
                };

                recognition.start();
            }

            // å½•éŸ³åŠŸèƒ½ï¼ˆä½œä¸ºè¯­éŸ³è¯†åˆ«çš„å¤‡é€‰æ–¹æ¡ˆï¼‰
            function startAudioRecording() {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(function (stream) {
                    recordedChunks = [];
                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = function (event) {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async function () {
                        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                        const reader = new FileReader();

                        reader.onload = async function () {
                            const audioData = reader.result;

                            try {
                                const response = await fetch('/api/upload/record', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        audio_data: audioData,
                                        transcribe: true,
                                        language: 'zh'
                                    })
                                });

                                const result = await response.json();

                                if (result.success) {
                                    selectedAudio = result.audio_data;
                                    audioFileName.textContent = result.file_name;
                                    audioFileSize.textContent = `${(result.file_size / 1024 / 1024).toFixed(2)} MB`;
                                    audioPreview.classList.remove('hidden');
                                    updateSendButton();

                                    // å¤„ç†è¯­éŸ³è½¬æ–‡å­—ç»“æœ
                                    if (result.transcription && result.transcription.text) {
                                        const transcribedText = result.transcription.text.trim();
                                        if (transcribedText) {
                                            // å°†è½¬å½•çš„æ–‡å­—è‡ªåŠ¨å¡«å…¥è¾“å…¥æ¡†
                                            messageInput.value = transcribedText;
                                            messageInput.focus();

                                            // æ˜¾ç¤ºè½¬å½•æˆåŠŸçš„æç¤º
                                            showSuccessMessage(`ğŸ™ï¸ è¯­éŸ³è½¬æ–‡å­—æˆåŠŸï¼è¯†åˆ«æ–‡å­—ï¼š${transcribedText.substring(0, 20)}${transcribedText.length > 20 ? '...' : ''}`);
                                        } else {
                                            messageInput.value = 'è¯·æè¿°è¿™æ®µå½•éŸ³çš„å†…å®¹';
                                            messageInput.focus();
                                        }
                                    } else {
                                        // å¦‚æœè½¬å½•å¤±è´¥ï¼Œç»™å‡ºæç¤º
                                        if (result.transcription_error) {
                                            console.warn('è¯­éŸ³è½¬æ–‡å­—å¤±è´¥:', result.transcription_error);
                                            showErrorMessage('è¯­éŸ³è½¬æ–‡å­—åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨æè¿°å½•éŸ³å†…å®¹');
                                        }

                                        if (!messageInput.value.trim()) {
                                            messageInput.value = 'è¯·æè¿°è¿™æ®µå½•éŸ³çš„å†…å®¹';
                                            messageInput.focus();
                                        }
                                    }
                                } else {
                                    alert('å½•éŸ³ä¿å­˜å¤±è´¥: ' + result.error);
                                }
                            } catch (error) {
                                alert('å½•éŸ³ä¿å­˜å¤±è´¥: ' + error.message);
                            }
                        };

                        reader.readAsDataURL(blob);

                        // åœæ­¢æ‰€æœ‰éŸ³é¢‘è½¨é“
                        stream.getTracks().forEach(track => track.stop());
                    };

                    isRecording = true;
                    previewArea.classList.remove('hidden');
                    audioRecording.classList.remove('hidden');

                    mediaRecorder.start();
                    console.log('å¼€å§‹å½•éŸ³ï¼ˆå¤‡é€‰æ¨¡å¼ï¼‰...');

                }).catch(function (error) {
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                    console.error('å½•éŸ³é”™è¯¯:', error);
                });
            }

            // åœæ­¢å½•éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            stopRecordingBtn.addEventListener('click', stopRecording);

            // åœæ­¢å½•éŸ³å‡½æ•°
            function stopRecording() {
                if (isRecording && mediaRecorder) {
                    isRecording = false;
                    audioRecording.classList.add('hidden');
                    if (!selectedImage && !selectedAudio && !selectedVideo) {
                        previewArea.classList.add('hidden');
                    }

                    mediaRecorder.stop();
                    console.log('åœæ­¢å½•éŸ³...');
                }
            }

            // æ¸…ç©ºèŠå¤©è®°å½•åŠŸèƒ½ï¼ˆæŒ‰é’®å·²åˆ é™¤ï¼Œä½†ä¿ç•™å‡½æ•°ä¾›å…¶ä»–åœ°æ–¹è°ƒç”¨ï¼‰
            function clearChat() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
                    conversationHistory = [];
                    currentSessionId = null;
                    clearChatDisplay();

                    // æ¸…ç©ºæ‰€æœ‰åª’ä½“é€‰æ‹©
                    selectedImage = null;
                    selectedAudio = null;
                    selectedVideo = null;
                    previewArea.classList.add('hidden');
                    imagePreview.classList.add('hidden');
                    audioPreview.classList.add('hidden');
                    videoPreview.classList.add('hidden');

                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                    attachmentFileInput.value = '';

                    // æ›´æ–°ä¼šè¯åˆ—è¡¨ä¸­çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.session-item').forEach(item => {
                        item.classList.remove('bg-blue-50', 'border-2', 'border-blue-200');
                    });

                    updateSendButton();
                    console.log('å¯¹è¯å†å²å·²æ¸…ç©º');
                }
            }

            // å°†clearChatå‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.clearChat = clearChat;

            // å°†createNewSessionå‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.createNewSession = createNewSession;

            // è®¾ç½®åŠŸèƒ½ç›¸å…³äº‹ä»¶å¤„ç†

            // åŠ è½½è®¾ç½®
            function loadSettings() {
                const savedSystemPrompt = localStorage.getItem('chatbot_system_prompt');
                const savedTemperature = localStorage.getItem('chatbot_temperature');

                if (savedSystemPrompt) {
                    systemPrompt = savedSystemPrompt;
                }

                if (savedTemperature) {
                    temperature = parseFloat(savedTemperature);
                }

                updateUIStatus();
            }

            // ä¿å­˜è®¾ç½®
            function saveSettings() {
                localStorage.setItem('chatbot_system_prompt', systemPrompt);
                localStorage.setItem('chatbot_temperature', temperature.toString());
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            function showSuccessMessage(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successDiv.innerHTML = `<i class="ri-check-line mr-2"></i>${message}`;
                document.body.appendChild(successDiv);

                setTimeout(() => {
                    if (document.body.contains(successDiv)) {
                        document.body.removeChild(successDiv);
                    }
                }, 3000);
            }

            // æ˜¾ç¤ºé”™è¯¯æç¤º
            function showErrorMessage(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                errorDiv.innerHTML = `<i class="ri-error-warning-line mr-2"></i>${message}`;
                document.body.appendChild(errorDiv);

                setTimeout(() => {
                    if (document.body.contains(errorDiv)) {
                        document.body.removeChild(errorDiv);
                    }
                }, 5000);
            }

            // ===== System Prompt ç›¸å…³äº‹ä»¶ =====

            // æ‰“å¼€ç³»ç»Ÿæç¤ºè®¾ç½®
            headerSystemPromptBtn.addEventListener('click', function () {
                systemPromptInput.value = systemPrompt;
                systemPromptModal.classList.remove('hidden');
            });

            // å…³é—­ç³»ç»Ÿæç¤ºå¼¹çª—
            closeSystemPromptBtn.addEventListener('click', function () {
                systemPromptModal.classList.add('hidden');
            });

            // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
            systemPromptModal.addEventListener('click', function (e) {
                if (e.target === systemPromptModal) {
                    systemPromptModal.classList.add('hidden');
                }
            });

            // ç³»ç»Ÿæç¤ºæ¨¡æ¿æŒ‰é’®
            document.querySelectorAll('.system-prompt-template').forEach(btn => {
                btn.addEventListener('click', function () {
                    const template = this.dataset.template;
                    systemPromptInput.value = template;
                });
            });

            // æ¸…ç©ºç³»ç»Ÿæç¤º
            clearSystemPromptBtn.addEventListener('click', function () {
                systemPromptInput.value = '';
            });

            // ä¿å­˜ç³»ç»Ÿæç¤º
            saveSystemPromptBtn.addEventListener('click', function () {
                systemPrompt = systemPromptInput.value.trim();
                saveSettings();
                updateUIStatus();
                systemPromptModal.classList.add('hidden');
                showSuccessMessage('ç³»ç»Ÿæç¤ºå·²ä¿å­˜');
            });

            // ===== Temperature ç›¸å…³äº‹ä»¶ =====

            // æ‰“å¼€æ¸©åº¦è®¾ç½®
            headerTemperatureBtn.addEventListener('click', function () {
                temperatureSlider.value = temperature;
                temperatureValue.textContent = temperature;
                temperatureModal.classList.remove('hidden');
            });

            // å…³é—­æ¸©åº¦å¼¹çª—
            closeTemperatureBtn.addEventListener('click', function () {
                temperatureModal.classList.add('hidden');
            });

            // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
            temperatureModal.addEventListener('click', function (e) {
                if (e.target === temperatureModal) {
                    temperatureModal.classList.add('hidden');
                }
            });

            // Temperatureæ»‘å—å˜åŒ–äº‹ä»¶
            temperatureSlider.addEventListener('input', function () {
                const value = parseFloat(this.value);
                temperatureValue.textContent = value;
            });

            // æ¸©åº¦é¢„è®¾æŒ‰é’®
            document.querySelectorAll('.temperature-preset').forEach(btn => {
                btn.addEventListener('click', function () {
                    const temp = parseFloat(this.dataset.temp);
                    temperatureSlider.value = temp;
                    temperatureValue.textContent = temp;
                });
            });

            // ä¿å­˜æ¸©åº¦è®¾ç½®
            saveTemperatureBtn.addEventListener('click', function () {
                temperature = parseFloat(temperatureSlider.value);
                saveSettings();
                updateUIStatus();
                temperatureModal.classList.add('hidden');
                showSuccessMessage('åˆ›é€ æ€§è®¾ç½®å·²ä¿å­˜');
            });

            // é¡µé¢åŠ è½½æ—¶åŠ è½½è®¾ç½®
            loadSettings();

            // åˆå§‹åŒ–
            messageInput.focus();
            updateSendButton();

            // æ·»åŠ è”ç½‘æœç´¢åŠŸèƒ½
            async function performWebSearch(query) {
                const loadingDiv = showLoadingState(LoadingType.SEARCH, `æ­£åœ¨æœç´¢: ${query}`);

                try {
                    const response = await fetch('/api/search/web', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: query,
                            count: 5,
                            include_images: true,
                            format_for_ai: true
                        })
                    });

                    const data = await response.json();
                    hideLoadingState(loadingDiv);

                    if (data.success) {
                        const searchDiv = document.createElement('div');
                        searchDiv.className = 'flex mb-4';

                        const typeIndicator = createTypeIndicator(MessageType.SEARCH);

                        let searchHTML = `
                            <div class="message-bubble bot-message message-type-search p-3">
                                <div class="message-content-group">
                                    ${typeIndicator}
                                    <div class="search-indicator">
                                        <span>ğŸŒ</span>
                                        <span>æœç´¢ç»“æœ (${data.search_provider})</span>
                                    </div>
                                    <div class="search-results">
                        `;

                        data.results.forEach((result, index) => {
                            searchHTML += `
                                <div class="search-result-item">
                                    <div class="search-result-title">${result.title}</div>
                                    <a href="${result.url}" target="_blank" class="search-result-url">${result.url}</a>
                                    <div class="search-result-snippet">${result.snippet || result.summary}</div>
                                </div>
                            `;
                        });

                        if (data.images && data.images.length > 0) {
                            searchHTML += `
                                <div style="margin-top: 15px;">
                                    <strong>ğŸ–¼ï¸ ç›¸å…³å›¾ç‰‡:</strong>
                                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                            `;
                            data.images.slice(0, 3).forEach(img => {
                                searchHTML += `
                                    <img src="${img.thumbnailUrl}" 
                                         alt="${img.name}" 
                                         style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                                         onclick="window.open('${img.contentUrl}', '_blank')">
                                `;
                            });
                            searchHTML += `</div></div>`;
                        }

                        searchHTML += `
                                    </div>
                                </div>
                            </div>`;
                        searchDiv.innerHTML = searchHTML;
                        chatContainer.appendChild(searchDiv);
                        scrollToBottom();

                        return data;
                    } else {
                        throw new Error(data.error || 'æœç´¢å¤±è´¥');
                    }
                } catch (error) {
                    hideLoadingState(loadingDiv);
                    showErrorMessage('æœç´¢å¤±è´¥: ' + error.message);
                    return null;
                }
            }

            // ===== æ–°çš„åŠ è½½çŠ¶æ€ç®¡ç†ç³»ç»Ÿ =====

            // åŠ è½½çŠ¶æ€ç±»å‹æšä¸¾
            const LoadingType = {
                CHAT: 'chat',
                SEARCH: 'search',
                IMAGE: 'image',
                UPLOAD: 'upload'
            };

            // åˆ›å»ºéª¨æ¶å±
            function createMessageSkeleton() {
                const skeletonDiv = document.createElement('div');
                skeletonDiv.className = 'message bot-message';
                skeletonDiv.innerHTML = `
                    <div class="message-skeleton">
                        <div class="skeleton-header">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="skeleton skeleton-title"></div>
                        </div>
                        <div class="skeleton skeleton-line long"></div>
                        <div class="skeleton skeleton-line medium"></div>
                        <div class="skeleton skeleton-line short"></div>
                        <div class="skeleton skeleton-line extra-short"></div>
                    </div>
                `;
                return skeletonDiv;
            }

            // åˆ›å»ºç°ä»£åŠ è½½æŒ‡ç¤ºå™¨
            function createModernLoading(type = LoadingType.CHAT, message = 'æ­£åœ¨æ€è€ƒ...') {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message';

                let specialClass = '';
                let iconContent = 'ğŸ¤–';

                switch (type) {
                    case LoadingType.SEARCH:
                        specialClass = 'search-loading';
                        iconContent = 'ğŸ”';
                        break;
                    case LoadingType.IMAGE:
                        specialClass = 'image-processing-loading';
                        iconContent = 'ğŸ–¼ï¸';
                        break;
                    case LoadingType.UPLOAD:
                        specialClass = '';
                        iconContent = 'ğŸ“¤';
                        break;
                }

                loadingDiv.innerHTML = `
                    <div class="modern-loading-indicator ${specialClass}">
                        <div class="loading-icon">
                            <span style="font-size: 12px;">${iconContent}</span>
                        </div>
                        <div class="loading-text">${message}</div>
                        <div class="wave-loading">
                            <div class="wave-dot"></div>
                            <div class="wave-dot"></div>
                            <div class="wave-dot"></div>
                        </div>
                    </div>
                `;

                return loadingDiv;
            }

            // åˆ›å»ºç®€å•çš„spinneråŠ è½½
            function createSpinnerLoading(message = 'åŠ è½½ä¸­...') {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'message bot-message';
                loadingDiv.innerHTML = `
                    <div class="modern-loading-indicator">
                        <div class="spinner-loading"></div>
                        <div class="loading-text">${message}</div>
                    </div>
                `;
                return loadingDiv;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            function showLoadingState(type = LoadingType.CHAT, message = 'æ­£åœ¨å¤„ç†...', useSkeleton = false) {
                let loadingElement;

                if (useSkeleton) {
                    loadingElement = createMessageSkeleton();
                } else {
                    loadingElement = createModernLoading(type, message);
                }

                // æ·»åŠ åˆ°èŠå¤©å®¹å™¨
                chatContainer.appendChild(loadingElement);
                scrollToBottom();

                return loadingElement;
            }

            // éšè—åŠ è½½çŠ¶æ€ï¼ˆå¸¦åŠ¨ç”»ï¼‰
            function hideLoadingState(loadingElement) {
                if (loadingElement && loadingElement.parentNode) {
                    // æ·»åŠ é€€å‡ºåŠ¨ç”»
                    loadingElement.classList.add('loading-exit');

                    // åŠ¨ç”»å®Œæˆåç§»é™¤å…ƒç´ 
                    setTimeout(() => {
                        if (loadingElement.parentNode) {
                            loadingElement.parentNode.removeChild(loadingElement);
                        }
                    }, 300);
                }
            }

            // æ›´æ–°åŠ è½½çŠ¶æ€æ¶ˆæ¯
            function updateLoadingMessage(loadingElement, newMessage) {
                if (loadingElement) {
                    const loadingText = loadingElement.querySelector('.loading-text');
                    if (loadingText) {
                        loadingText.textContent = newMessage;
                    }
                }
            }

            // åˆ›å»ºä¼šè¯åˆ—è¡¨éª¨æ¶å±
            function createSessionSkeleton() {
                const skeletonDiv = document.createElement('div');
                skeletonDiv.className = 'session-skeleton p-3 border-b border-gray-200 cursor-pointer hover:bg-gray-50';
                skeletonDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="skeleton skeleton-line short mb-2"></div>
                            <div class="skeleton skeleton-line extra-short"></div>
                        </div>
                        <div class="skeleton skeleton-avatar w-6 h-6"></div>
                    </div>
                `;
                return skeletonDiv;
            }

            // æ˜¾ç¤ºä¼šè¯åˆ—è¡¨åŠ è½½çŠ¶æ€
            function showSessionsLoading() {
                const sessionsList = document.getElementById('sessionsList');
                if (sessionsList) {
                    // æ¸…ç©ºç°æœ‰ä¼šè¯
                    sessionsList.innerHTML = '';

                    // æ·»åŠ å¤šä¸ªéª¨æ¶å±é¡¹ç›®
                    for (let i = 0; i < 5; i++) {
                        sessionsList.appendChild(createSessionSkeleton());
                    }
                }
            }

            // åˆ›å»ºToasté€šçŸ¥ç³»ç»Ÿ
            function showToast(message, type = 'info', duration = 3000) {
                const toast = document.createElement('div');
                const bgColor = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                }[type] || 'bg-blue-500';

                const icon = {
                    success: 'âœ…',
                    error: 'âŒ',
                    warning: 'âš ï¸',
                    info: 'â„¹ï¸'
                }[type] || 'â„¹ï¸';

                toast.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span>${icon}</span>
                        <span>${message}</span>
                    </div>
                `;

                document.body.appendChild(toast);

                // åŠ¨ç”»æ˜¾ç¤º
                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                }, 10);

                // è‡ªåŠ¨éšè—
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }, duration);

                return toast;
            }

            // å…¨å±€Loadingç®¡ç†å™¨
            class LoadingManager {
                constructor() {
                    this.activeLoadings = new Set();
                    this.loadingCounter = 0;
                }

                // å¼€å§‹loading
                startLoading(id = null) {
                    const loadingId = id || `loading_${++this.loadingCounter}`;
                    this.activeLoadings.add(loadingId);
                    this.updateGlobalLoadingState();
                    return loadingId;
                }

                // ç»“æŸloading
                endLoading(loadingId) {
                    this.activeLoadings.delete(loadingId);
                    this.updateGlobalLoadingState();
                }

                // æ›´æ–°å…¨å±€loadingçŠ¶æ€
                updateGlobalLoadingState() {
                    const hasActiveLoading = this.activeLoadings.size > 0;
                    document.body.classList.toggle('loading-active', hasActiveLoading);

                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¨å±€loadingæŒ‡ç¤ºå™¨
                    const globalSpinner = document.getElementById('globalSpinner');
                    if (globalSpinner) {
                        globalSpinner.style.display = hasActiveLoading ? 'block' : 'none';
                    }
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„loading
                hasActiveLoading() {
                    return this.activeLoadings.size > 0;
                }
            }

            // åˆå§‹åŒ–å…¨å±€Loadingç®¡ç†å™¨
            const loadingManager = new LoadingManager();

            // ===== æ¶ˆæ¯ç±»å‹è¯†åˆ«å’Œæ ·å¼ç®¡ç†ç³»ç»Ÿ =====

            // æ¶ˆæ¯ç±»å‹æšä¸¾
            const MessageType = {
                TEXT: 'text',
                IMAGE: 'image',
                AUDIO: 'audio',
                VIDEO: 'video',
                MIXED: 'mixed',
                ANALYSIS: 'analysis',
                SEARCH: 'search'
            };

            // æ£€æµ‹æ¶ˆæ¯ç±»å‹
            function detectMessageType(message) {
                const hasText = message.text && message.text.trim();
                const hasImage = message.image;
                const hasAudio = message.audio;
                const hasVideo = message.video;

                const mediaCount = (hasImage ? 1 : 0) + (hasAudio ? 1 : 0) + (hasVideo ? 1 : 0);

                if (mediaCount > 1 || (mediaCount === 1 && hasText)) {
                    return MessageType.MIXED;
                } else if (hasImage) {
                    return MessageType.IMAGE;
                } else if (hasAudio) {
                    return MessageType.AUDIO;
                } else if (hasVideo) {
                    return MessageType.VIDEO;
                } else {
                    return MessageType.TEXT;
                }
            }

            // æ£€æµ‹Botå›å¤ç±»å‹
            function detectBotResponseType(text, context = {}) {
                if (context.isSearch || text.includes('æœç´¢') || text.includes('æŸ¥æ‰¾')) {
                    return MessageType.SEARCH;
                }
                if (context.isAnalysis || text.includes('åˆ†æ') || text.includes('è§£é‡Š') || text.includes('è¯†åˆ«')) {
                    return MessageType.ANALYSIS;
                }
                return MessageType.TEXT;
            }

            // åˆ›å»ºæ¶ˆæ¯ç±»å‹æŒ‡ç¤ºå™¨
            function createTypeIndicator(type) {
                const indicators = {
                    [MessageType.TEXT]: { icon: 'ğŸ’¬', label: 'æ–‡æœ¬', class: 'type-indicator-text' },
                    [MessageType.IMAGE]: { icon: 'ğŸ–¼ï¸', label: 'å›¾ç‰‡', class: 'type-indicator-image' },
                    [MessageType.AUDIO]: { icon: 'ğŸµ', label: 'éŸ³é¢‘', class: 'type-indicator-audio' },
                    [MessageType.VIDEO]: { icon: 'ğŸ¬', label: 'è§†é¢‘', class: 'type-indicator-video' },
                    [MessageType.MIXED]: { icon: 'ğŸ“', label: 'å¤šåª’ä½“', class: 'type-indicator-mixed' },
                    [MessageType.ANALYSIS]: { icon: 'ğŸ¤–', label: 'æ™ºèƒ½åˆ†æ', class: 'type-indicator-text' },
                    [MessageType.SEARCH]: { icon: 'ğŸ”', label: 'æœç´¢ç»“æœ', class: 'type-indicator-text' }
                };

                const indicator = indicators[type];
                if (!indicator) return '';

                return `<div class="message-type-indicator ${indicator.class}">
                    <span>${indicator.icon}</span>
                    <span>${indicator.label}</span>
                </div>`;
            }

            // åˆ›å»ºå¢å¼ºçš„åª’ä½“å®¹å™¨
            function createMediaContainer(message) {
                let mediaHTML = '';

                if (message.image) {
                    mediaHTML += `
                        <div class="media-container">
                            <div class="image-container">
                                <img src="${message.image}" alt="ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡" loading="lazy">
                            </div>
                        </div>
                    `;
                }

                if (message.audio) {
                    mediaHTML += `
                        <div class="media-container">
                            <div class="audio-container">
                                <div class="audio-icon">
                                    <i class="ri-music-line"></i>
                                </div>
                                <div class="audio-info">
                                    <div class="audio-title">éŸ³é¢‘æ–‡ä»¶</div>
                                    <audio controls class="audio-controls">
                                        <source src="${message.audio}" type="audio/webm">
                                        <source src="${message.audio}" type="audio/mp3">
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                                    </audio>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (message.video) {
                    mediaHTML += `
                        <div class="media-container">
                            <div class="video-container">
                                <div class="video-header">
                                    <div class="video-icon">
                                        <i class="ri-video-line"></i>
                                    </div>
                                    <div class="video-title">è§†é¢‘æ–‡ä»¶</div>
                                </div>
                                <video controls class="video-controls">
                                    <source src="${message.video}" type="video/mp4">
                                    <source src="${message.video}" type="video/webm">
                                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                                </video>
                            </div>
                        </div>
                    `;
                }

                return mediaHTML;
            }

            // åˆ›å»ºç±»å‹åŒ–æ¶ˆæ¯
            function createTypedMessage(message, isUser = true, context = {}) {
                const messageType = isUser ? detectMessageType(message) : detectBotResponseType(message.text || '', context);
                const typeClass = `message-type-${messageType}`;
                const roleClass = isUser ? 'user-message' : 'bot-message';

                let contentHTML = '';

                // æ·»åŠ ç±»å‹æŒ‡ç¤ºå™¨ï¼ˆå¯é€‰ï¼‰
                if (context.showTypeIndicator !== false) {
                    contentHTML += createTypeIndicator(messageType);
                }

                // æ·»åŠ æ–‡æœ¬å†…å®¹
                if (message.text && message.text.trim()) {
                    contentHTML += `<div class="text-content">${message.text}</div>`;
                }

                // æ·»åŠ åª’ä½“å†…å®¹
                if (isUser && (message.image || message.audio || message.video)) {
                    contentHTML += `<div class="media-content">${createMediaContainer(message)}</div>`;
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${isUser ? 'justify-end' : ''} mb-4`;

                messageDiv.innerHTML = `
                    <div class="message-bubble ${roleClass} ${typeClass} p-3">
                        <div class="message-content-group">
                            ${contentHTML}
                        </div>
                    </div>
                `;

                return messageDiv;
            }

            // æ›´æ–°ç°æœ‰æ¶ˆæ¯çš„ç±»å‹æ ·å¼
            function updateMessageType(messageElement, type) {
                const bubble = messageElement.querySelector('.message-bubble');
                if (bubble) {
                    // ç§»é™¤ç°æœ‰ç±»å‹ç±»
                    bubble.classList.remove(
                        'message-type-text',
                        'message-type-image',
                        'message-type-audio',
                        'message-type-video',
                        'message-type-mixed',
                        'message-type-analysis',
                        'message-type-search'
                    );

                    // æ·»åŠ æ–°ç±»å‹ç±»
                    bubble.classList.add(`message-type-${type}`);
                }
            }

            // æ‰¹é‡æ›´æ–°æ¶ˆæ¯æ ·å¼
            function refreshMessageStyles() {
                const messages = chatContainer.querySelectorAll('.message-bubble');
                messages.forEach(bubble => {
                    // è§¦å‘é‡æ–°æ¸²æŸ“åŠ¨ç”»
                    bubble.style.animation = 'none';
                    bubble.offsetHeight; // è§¦å‘é‡æ’
                    bubble.style.animation = 'messageSlideIn 0.3s ease-out';
                });
            }

            // æ¼”ç¤ºä¸åŒæ¶ˆæ¯ç±»å‹çš„åŠŸèƒ½ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
            function demoMessageTypes() {
                if (confirm('æ˜¯å¦è¦å±•ç¤ºä¸åŒç±»å‹æ¶ˆæ¯çš„æ•ˆæœï¼Ÿè¿™å°†æ¸…ç©ºå½“å‰èŠå¤©è®°å½•ã€‚')) {
                    chatContainer.innerHTML = '';

                    // çº¯æ–‡æœ¬æ¶ˆæ¯
                    const textMessage = createTypedMessage({ text: 'è¿™æ˜¯ä¸€æ¡æ™®é€šçš„æ–‡æœ¬æ¶ˆæ¯' }, true);
                    chatContainer.appendChild(textMessage);

                    // å›¾ç‰‡æ¶ˆæ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
                    const imageMessage = createTypedMessage({
                        text: 'æˆ‘å‘é€äº†ä¸€å¼ å›¾ç‰‡',
                        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="100"><rect width="200" height="100" fill="%23e2e8f0"/><text x="100" y="55" text-anchor="middle" fill="%236b7280">ç¤ºä¾‹å›¾ç‰‡</text></svg>'
                    }, true);
                    chatContainer.appendChild(imageMessage);

                    // æ··åˆæ¶ˆæ¯ï¼ˆæ¨¡æ‹Ÿï¼‰
                    const mixedMessage = createTypedMessage({
                        text: 'è¿™æ˜¯åŒ…å«å›¾ç‰‡å’Œæ–‡å­—çš„æ··åˆæ¶ˆæ¯',
                        image: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="80"><rect width="150" height="80" fill="%23ddd6fe"/><text x="75" y="45" text-anchor="middle" fill="%235b21b6">æ··åˆå†…å®¹</text></svg>'
                    }, true);
                    chatContainer.appendChild(mixedMessage);

                    // Botå›å¤ - æ™®é€šæ–‡æœ¬
                    const botTextMessage = createTypedMessage({
                        text: 'è¿™æ˜¯æœºå™¨äººçš„æ™®é€šæ–‡æœ¬å›å¤ï¼ŒåŒ…å«ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚'
                    }, false, { showTypeIndicator: true });
                    chatContainer.appendChild(botTextMessage);

                    // Botå›å¤ - åˆ†æç±»å‹
                    const analysisMessage = createTypedMessage({
                        text: 'è¿™æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆ†æå›å¤ã€‚æˆ‘å·²ç»åˆ†æäº†æ‚¨ä¸Šä¼ çš„å›¾ç‰‡å†…å®¹ï¼Œå‘ç°äº†ä»¥ä¸‹ä¿¡æ¯...'
                    }, false, {
                        showTypeIndicator: true,
                        isAnalysis: true
                    });
                    chatContainer.appendChild(analysisMessage);

                    // Botå›å¤ - æœç´¢ç±»å‹
                    const searchMessage = createTypedMessage({
                        text: 'æ ¹æ®æœ€æ–°æœç´¢ç»“æœï¼Œæˆ‘æ‰¾åˆ°äº†ç›¸å…³ä¿¡æ¯ã€‚è¿™é‡Œæ˜¯ç»¼åˆå¤šä¸ªæ¥æºçš„å›ç­”...'
                    }, false, {
                        showTypeIndicator: true,
                        isSearch: true
                    });
                    chatContainer.appendChild(searchMessage);

                    scrollToBottom();
                    showToast('å·²å±•ç¤ºä¸åŒç±»å‹çš„æ¶ˆæ¯æ ·å¼ï¼', 'success');
                }
            }

            // åœ¨æ§åˆ¶å°ä¸­æš´éœ²æ¼”ç¤ºå‡½æ•°ï¼ˆå¼€å‘ç”¨ï¼‰
            window.demoMessageTypes = demoMessageTypes;

            // æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬
            function formatMessage(text) {
                // ç®€å•çš„æ ¼å¼åŒ–ï¼Œæ”¯æŒæ¢è¡Œ
                return text.replace(/\n/g, '<br>');
            }

            // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸»è¦ç”¨äºçº¯æ–‡æœ¬ï¼‰
            function addMessage(text, role) {
                const message = { text: text };
                const isUser = role === 'user';
                const messageDiv = createTypedMessage(message, isUser, { showTypeIndicator: false });

                chatContainer.appendChild(messageDiv);
                scrollToBottom();
            }

            // å¸¦æœç´¢çš„æ™ºèƒ½å¯¹è¯
            async function chatWithSearch(message) {
                const enableSearch = document.getElementById('enableSearch').checked;
                const model = document.getElementById('modelSelect').value;

                if (!enableSearch) {
                    return await sendMessage(message);
                }

                const loadingDiv = showLoadingState(LoadingType.SEARCH, 'æ­£åœ¨æ€è€ƒå¹¶æœç´¢...');

                try {
                    const response = await fetch('/api/chat/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            model: model,
                            auto_search: true,
                            session_id: currentSessionId || 'default'
                        })
                    });

                    const data = await response.json();
                    hideLoadingState(loadingDiv);

                    if (data.success) {
                        // æ£€æµ‹å›å¤ç±»å‹
                        const context = {
                            isSearch: data.search_performed,
                            showTypeIndicator: true
                        };

                        const botMessageType = detectBotResponseType(data.response, context);
                        const typeIndicator = createTypeIndicator(botMessageType);

                        const responseDiv = document.createElement('div');
                        responseDiv.className = 'flex mb-4';

                        let responseHTML = `
                            <div class="message-bubble bot-message message-type-${botMessageType} p-3">
                                <div class="message-content-group">
                                    ${typeIndicator}
                        `;

                        if (data.search_performed && data.search_results && data.search_results.success) {
                            responseHTML += `
                                    <div class="search-indicator">
                                        <span>ğŸ”</span>
                                        <span>å·²æœç´¢æœ€æ–°ä¿¡æ¯</span>
                                    </div>
                            `;
                        }

                        responseHTML += `
                                    <div class="text-content">${formatMessage(data.response)}</div>
                        `;

                        if (data.model_used) {
                            responseHTML += `
                                    <div class="model-indicator">æ¨¡å‹: ${data.model_used}</div>
                            `;
                        }

                        responseHTML += `
                                </div>
                            </div>`;

                        responseDiv.innerHTML = responseHTML;
                        chatContainer.appendChild(responseDiv);
                        scrollToBottom();

                        return data;
                    } else {
                        throw new Error(data.error || 'å¯¹è¯å¤±è´¥');
                    }
                } catch (error) {
                    hideLoadingState(loadingDiv);
                    showErrorMessage('æ™ºèƒ½å¯¹è¯å¤±è´¥: ' + error.message);
                    return null;
                }
            }

            // äº‹ä»¶ç›‘å¬å™¨
            sendMessageBtn.addEventListener('click', () => {
                const message = messageInput.value.trim();
                if (message) {
                    addMessage(message, 'user');
                    messageInput.value = '';
                    // ä½¿ç”¨å¸¦æœç´¢çš„æ™ºèƒ½å¯¹è¯
                    chatWithSearch(message);
                    updateSendButton();
                }
            });





            // è”ç½‘æœç´¢å¼€å…³çŠ¶æ€ç®¡ç†
            const enableSearchCheckbox = document.getElementById('enableSearch');
            const searchStatusIcon = document.querySelector('.search-status-icon');
            const searchControls = document.querySelector('.search-controls-inline');

            function updateSearchStatus() {
                if (enableSearchCheckbox.checked) {
                    searchStatusIcon.textContent = 'ğŸŒ';
                    searchStatusIcon.title = 'æ™ºèƒ½è”ç½‘å·²å¼€å¯';
                    searchControls.style.borderColor = 'rgba(102, 126, 234, 0.3)';
                    searchControls.style.background = 'rgba(102, 126, 234, 0.1)';
                } else {
                    searchStatusIcon.textContent = 'ğŸ”Œ';
                    searchStatusIcon.title = 'ç¦»çº¿æ¨¡å¼';
                    searchControls.style.borderColor = 'rgba(0, 0, 0, 0.1)';
                    searchControls.style.background = 'rgba(0, 0, 0, 0.05)';
                }
            }

            enableSearchCheckbox.addEventListener('change', updateSearchStatus);

            // åˆå§‹åŒ–çŠ¶æ€
            updateSearchStatus();
        });
    </script>

    <script id="textareaAutoResize">
        document.addEventListener('DOMContentLoaded', function () {
            const messageInput = document.getElementById('messageInput');

            // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦çš„å‡½æ•°
            function adjustTextareaHeight() {
                messageInput.style.height = 'auto';
                messageInput.style.height = (messageInput.scrollHeight) + 'px';
            }

            // ç›‘å¬è¾“å…¥äº‹ä»¶
            messageInput.addEventListener('input', adjustTextareaHeight);

            // åˆå§‹åŒ–
            adjustTextareaHeight();
        });
    </script>

    <script id="enhancedFeatures">
        document.addEventListener('DOMContentLoaded', function () {
            // ä¸»é¢˜å’Œä¸ªæ€§åŒ–è®¾ç½®ç®¡ç†
            class ThemeManager {
                constructor() {
                    this.settingsKey = 'chatbot-settings';
                    this.currentTheme = 'light';
                    this.settings = {
                        theme: 'light',
                        fontSize: 16,
                        bubbleRadius: 18,
                        customColors: {
                            primary: '#1E88E5',
                            userBubble: '#E8E8E8',
                            botBubble: '#E3F2FD'
                        }
                    };
                    this.loadSettings();
                    this.initializeEventListeners();
                    this.applySettings();
                }

                loadSettings() {
                    const saved = localStorage.getItem(this.settingsKey);
                    if (saved) {
                        this.settings = { ...this.settings, ...JSON.parse(saved) };
                    }
                    this.currentTheme = this.settings.theme;
                }

                saveSettings() {
                    localStorage.setItem(this.settingsKey, JSON.stringify(this.settings));
                }

                applySettings() {
                    // åº”ç”¨ä¸»é¢˜
                    document.documentElement.setAttribute('data-theme', this.currentTheme);

                    // åº”ç”¨å­—ä½“å¤§å°
                    document.documentElement.style.setProperty('--chat-font-size', `${this.settings.fontSize}px`);

                    // åº”ç”¨æ°”æ³¡åœ†è§’
                    document.documentElement.style.setProperty('--bubble-radius', `${this.settings.bubbleRadius}px`);

                    // åº”ç”¨è‡ªå®šä¹‰é¢œè‰²
                    if (this.currentTheme === 'custom') {
                        document.documentElement.style.setProperty('--primary-color', this.settings.customColors.primary);
                        document.documentElement.style.setProperty('--user-bubble-color', this.settings.customColors.userBubble);
                        document.documentElement.style.setProperty('--bot-bubble-color', this.settings.customColors.botBubble);
                    }

                    // æ›´æ–°UIæ§ä»¶
                    this.updateUIControls();
                }

                updateUIControls() {
                    // æ›´æ–°ä¸»é¢˜é€‰æ‹©å™¨
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.classList.toggle('active', option.dataset.theme === this.currentTheme);
                    });

                    // æ›´æ–°æ»‘å—å€¼
                    const fontSizeSlider = document.getElementById('fontSizeSlider');
                    const bubbleRadiusSlider = document.getElementById('bubbleRadiusSlider');

                    if (fontSizeSlider) fontSizeSlider.value = this.settings.fontSize;
                    if (bubbleRadiusSlider) bubbleRadiusSlider.value = this.settings.bubbleRadius;

                    // æ›´æ–°æ˜¾ç¤ºå€¼
                    document.getElementById('fontSizeValue').textContent = `${this.settings.fontSize}px`;
                    document.getElementById('bubbleRadiusValue').textContent = `${this.settings.bubbleRadius}px`;

                    // æ›´æ–°é¢œè‰²é€‰æ‹©å™¨
                    document.getElementById('primaryColorPicker').value = this.settings.customColors.primary;
                    document.getElementById('userBubbleColorPicker').value = this.settings.customColors.userBubble;
                    document.getElementById('botBubbleColorPicker').value = this.settings.customColors.botBubble;

                    // æ›´æ–°ä¸»é¢˜æŒ‰é’®å›¾æ ‡
                    const themeIcon = document.getElementById('themeIcon');
                    if (themeIcon) {
                        themeIcon.className = this.currentTheme === 'dark' ? 'ri-moon-line' : 'ri-sun-line';
                    }

                    // æ˜¾ç¤º/éšè—è‡ªå®šä¹‰é¢œè‰²åŒºåŸŸ
                    const customColorsSection = document.getElementById('customColorsSection');
                    if (customColorsSection) {
                        customColorsSection.style.display = this.currentTheme === 'custom' ? 'block' : 'none';
                    }
                }

                setTheme(theme) {
                    this.currentTheme = theme;
                    this.settings.theme = theme;
                    this.applySettings();
                    this.saveSettings();
                }

                setFontSize(size) {
                    this.settings.fontSize = size;
                    this.applySettings();
                    this.saveSettings();
                }

                setBubbleRadius(radius) {
                    this.settings.bubbleRadius = radius;
                    this.applySettings();
                    this.saveSettings();
                }

                setCustomColor(type, color) {
                    this.settings.customColors[type] = color;
                    if (this.currentTheme === 'custom') {
                        this.applySettings();
                    }
                    this.saveSettings();
                }

                resetSettings() {
                    this.settings = {
                        theme: 'light',
                        fontSize: 16,
                        bubbleRadius: 18,
                        customColors: {
                            primary: '#1E88E5',
                            userBubble: '#E8E8E8',
                            botBubble: '#E3F2FD'
                        }
                    };
                    this.currentTheme = 'light';
                    this.applySettings();
                    this.saveSettings();
                }

                toggleTheme() {
                    const newTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                }

                initializeEventListeners() {
                    // ä¸»é¢˜åˆ‡æ¢æŒ‰é’® (å·²åˆ é™¤ï¼Œä½†ä¿ç•™åŠŸèƒ½)
                    // const themeToggle = document.getElementById('themeToggle');
                    // if (themeToggle) {
                    //     themeToggle.addEventListener('click', () => this.toggleTheme());
                    // }

                    // ä¸»é¢˜é€‰æ‹©å™¨
                    document.querySelectorAll('.theme-option').forEach(option => {
                        option.addEventListener('click', () => {
                            this.setTheme(option.dataset.theme);
                        });
                    });

                    // å­—ä½“å¤§å°æ»‘å—
                    const fontSizeSlider = document.getElementById('fontSizeSlider');
                    if (fontSizeSlider) {
                        fontSizeSlider.addEventListener('input', (e) => {
                            this.setFontSize(parseInt(e.target.value));
                        });
                    }

                    // æ°”æ³¡åœ†è§’æ»‘å—
                    const bubbleRadiusSlider = document.getElementById('bubbleRadiusSlider');
                    if (bubbleRadiusSlider) {
                        bubbleRadiusSlider.addEventListener('input', (e) => {
                            this.setBubbleRadius(parseInt(e.target.value));
                        });
                    }

                    // è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨
                    document.getElementById('primaryColorPicker').addEventListener('change', (e) => {
                        this.setCustomColor('primary', e.target.value);
                    });

                    document.getElementById('userBubbleColorPicker').addEventListener('change', (e) => {
                        this.setCustomColor('userBubble', e.target.value);
                    });

                    document.getElementById('botBubbleColorPicker').addEventListener('change', (e) => {
                        this.setCustomColor('botBubble', e.target.value);
                    });

                    // é‡ç½®è®¾ç½®æŒ‰é’®
                    const resetBtn = document.getElementById('resetSettingsBtn');
                    if (resetBtn) {
                        resetBtn.addEventListener('click', () => {
                            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿ')) {
                                this.resetSettings();
                            }
                        });
                    }
                }
            }

            // è®¾ç½®é¢æ¿ç®¡ç†
            class SettingsPanel {
                constructor() {
                    this.panel = document.getElementById('settingsPanel');
                    this.isOpen = false;
                    this.initializeEventListeners();
                }

                open() {
                    this.panel.classList.add('open');
                    this.isOpen = true;
                    document.body.style.overflow = 'hidden';
                }

                close() {
                    this.panel.classList.remove('open');
                    this.isOpen = false;
                    document.body.style.overflow = '';
                }

                toggle() {
                    if (this.isOpen) {
                        this.close();
                    } else {
                        this.open();
                    }
                }

                initializeEventListeners() {
                    // è®¾ç½®æŒ‰é’® (å·²åˆ é™¤ï¼Œä½†ä¿ç•™åŠŸèƒ½)
                    // const settingsToggle = document.getElementById('settingsToggle');
                    // if (settingsToggle) {
                    //     settingsToggle.addEventListener('click', () => this.toggle());
                    // }

                    // å¿«æ·æ“ä½œæ è®¾ç½®æŒ‰é’®
                    const quickSettingsBtn = document.getElementById('quickSettingsBtn');
                    if (quickSettingsBtn) {
                        quickSettingsBtn.addEventListener('click', () => this.open());
                    }

                    const mobileQuickSettingsBtn = document.getElementById('mobileQuickSettingsBtn');
                    if (mobileQuickSettingsBtn) {
                        mobileQuickSettingsBtn.addEventListener('click', () => this.open());
                    }

                    // å…³é—­æŒ‰é’®
                    const closeBtn = document.getElementById('closeSettingsBtn');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => this.close());
                    }

                    // ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­
                    this.panel.addEventListener('click', (e) => {
                        if (e.target === this.panel) {
                            this.close();
                        }
                    });

                    // ESCé”®å…³é—­
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && this.isOpen) {
                            this.close();
                        }
                    });
                }
            }

            // å¯¼å‡ºåŠŸèƒ½ç®¡ç†
            class ExportManager {
                constructor() {
                    this.initializeEventListeners();
                }

                getCurrentMessages() {
                    const messages = [];
                    const chatContainer = document.getElementById('chatContainer');
                    const messageElements = chatContainer.querySelectorAll('.message-bubble');

                    messageElements.forEach((element, index) => {
                        const isUser = element.classList.contains('user-message');
                        const text = element.textContent || element.innerText;

                        messages.push({
                            role: isUser ? 'user' : 'assistant',
                            content: text.trim(),
                            timestamp: new Date().toISOString()
                        });
                    });

                    return messages;
                }

                exportAsTxt() {
                    const messages = this.getCurrentMessages();
                    let content = `èŠå¤©è®°å½•å¯¼å‡º\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}\n\n`;

                    messages.forEach((msg, index) => {
                        const sender = msg.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹';
                        content += `${sender}: ${msg.content}\n\n`;
                    });

                    this.downloadFile(content, 'chat-export.txt', 'text/plain');
                }

                exportAsJson() {
                    const messages = this.getCurrentMessages();
                    const exportData = {
                        title: 'èŠå¤©è®°å½•',
                        exportTime: new Date().toISOString(),
                        messages: messages
                    };

                    const content = JSON.stringify(exportData, null, 2);
                    this.downloadFile(content, 'chat-export.json', 'application/json');
                }

                exportAsMarkdown() {
                    const messages = this.getCurrentMessages();
                    let content = `# èŠå¤©è®°å½•\n\n**å¯¼å‡ºæ—¶é—´:** ${new Date().toLocaleString()}\n\n---\n\n`;

                    messages.forEach((msg, index) => {
                        const sender = msg.role === 'user' ? 'ğŸ‘¤ **ç”¨æˆ·**' : 'ğŸ¤– **AIåŠ©æ‰‹**';
                        content += `${sender}\n\n${msg.content}\n\n---\n\n`;
                    });

                    this.downloadFile(content, 'chat-export.md', 'text/markdown');
                }

                exportAsPdf() {
                    // ç®€åŒ–ç‰ˆPDFå¯¼å‡ºï¼ˆä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½ï¼‰
                    const messages = this.getCurrentMessages();
                    const printWindow = window.open('', '_blank');

                    let htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>èŠå¤©è®°å½•</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                                .message { margin-bottom: 20px; padding: 10px; border-radius: 8px; }
                                .user { background-color: #e3f2fd; text-align: right; }
                                .assistant { background-color: #f5f5f5; }
                                .sender { font-weight: bold; margin-bottom: 5px; }
                                @media print { body { margin: 0; } }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>èŠå¤©è®°å½•</h1>
                                <p>å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}</p>
                            </div>
                    `;

                    messages.forEach(msg => {
                        const className = msg.role === 'user' ? 'user' : 'assistant';
                        const sender = msg.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹';
                        htmlContent += `
                            <div class="message ${className}">
                                <div class="sender">${sender}</div>
                                <div>${msg.content.replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    });

                    htmlContent += '</body></html>';

                    printWindow.document.write(htmlContent);
                    printWindow.document.close();

                    setTimeout(() => {
                        printWindow.print();
                    }, 1000);
                }

                downloadFile(content, filename, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }

                initializeEventListeners() {
                    // å¯¼å‡ºæŒ‰é’®äº‹ä»¶
                    const exportTxtBtn = document.getElementById('exportTxtBtn');
                    if (exportTxtBtn) {
                        exportTxtBtn.addEventListener('click', () => this.exportAsTxt());
                    }

                    const exportJsonBtn = document.getElementById('exportJsonBtn');
                    if (exportJsonBtn) {
                        exportJsonBtn.addEventListener('click', () => this.exportAsJson());
                    }

                    const exportMarkdownBtn = document.getElementById('exportMarkdownBtn');
                    if (exportMarkdownBtn) {
                        exportMarkdownBtn.addEventListener('click', () => this.exportAsMarkdown());
                    }

                    const exportPdfBtn = document.getElementById('exportPdfBtn');
                    if (exportPdfBtn) {
                        exportPdfBtn.addEventListener('click', () => this.exportAsPdf());
                    }

                    // å¿«æ·å¯¼å‡ºæŒ‰é’®
                    const quickExportBtn = document.getElementById('quickExportBtn');
                    if (quickExportBtn) {
                        quickExportBtn.addEventListener('click', () => this.exportAsMarkdown());
                    }

                    const mobileQuickExportBtn = document.getElementById('mobileQuickExportBtn');
                    if (mobileQuickExportBtn) {
                        mobileQuickExportBtn.addEventListener('click', () => this.exportAsMarkdown());
                    }
                }
            }

            // å¿«æ·æ“ä½œç®¡ç†
            class QuickActionsManager {
                constructor() {
                    this.initializeEventListeners();
                }

                scrollToTop() {
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
                }

                scrollToBottom() {
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
                }

                clearChat() {
                    // ç›´æ¥è°ƒç”¨æ¸…ç©ºèŠå¤©åŠŸèƒ½
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
                        // è°ƒç”¨å…¨å±€çš„æ¸…ç©ºå‡½æ•°
                        window.clearChat();
                    }
                }

                newChat() {
                    // ç›´æ¥è°ƒç”¨æ–°å»ºå¯¹è¯åŠŸèƒ½
                    if (typeof window.createNewSession === 'function') {
                        window.createNewSession();
                    } else {
                        console.error('createNewSession function not available');
                    }
                }

                initializeEventListeners() {
                    // æ¡Œé¢ç«¯å¿«æ·æ“ä½œ
                    const quickClearBtn = document.getElementById('quickClearBtn');
                    if (quickClearBtn) {
                        quickClearBtn.addEventListener('click', () => this.clearChat());
                    }

                    // è¾“å…¥åŒºåŸŸé¡¶éƒ¨çš„æ–°å¯¹è¯æŒ‰é’®
                    const newChatButton = document.getElementById('newChatButton');
                    if (newChatButton) {
                        newChatButton.addEventListener('click', () => this.newChat());
                    }

                    const quickScrollTopBtn = document.getElementById('quickScrollTopBtn');
                    if (quickScrollTopBtn) {
                        quickScrollTopBtn.addEventListener('click', () => this.scrollToTop());
                    }

                    const quickScrollBottomBtn = document.getElementById('quickScrollBottomBtn');
                    if (quickScrollBottomBtn) {
                        quickScrollBottomBtn.addEventListener('click', () => this.scrollToBottom());
                    }

                    // ç§»åŠ¨ç«¯å¿«æ·æ“ä½œ
                    const mobileScrollTopBtn = document.getElementById('mobileScrollTopBtn');
                    if (mobileScrollTopBtn) {
                        mobileScrollTopBtn.addEventListener('click', () => this.scrollToTop());
                    }

                    // é”®ç›˜å¿«æ·é”®
                    document.addEventListener('keydown', (e) => {
                        // Ctrl/Cmd + E å¯¼å‡º
                        if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                            e.preventDefault();
                            const exportManager = new ExportManager();
                            exportManager.exportAsMarkdown();
                        }

                        // Ctrl/Cmd + L æ¸…ç©ºå¯¹è¯
                        if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                            e.preventDefault();
                            this.clearChat();
                        }

                        // Ctrl/Cmd + N æ–°å¯¹è¯
                        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                            e.preventDefault();
                            this.newChat();
                        }

                        // Ctrl/Cmd + , æ‰“å¼€è®¾ç½®
                        if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                            e.preventDefault();
                            const settingsPanel = new SettingsPanel();
                            settingsPanel.open();
                        }
                    });
                }
            }

            // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
            const themeManager = new ThemeManager();
            const settingsPanel = new SettingsPanel();
            const exportManager = new ExportManager();
            const quickActionsManager = new QuickActionsManager();

            // å…¨å±€è®¿é—®
            window.themeManager = themeManager;
            window.settingsPanel = settingsPanel;
            window.exportManager = exportManager;
            window.quickActionsManager = quickActionsManager;

            console.log('ç•Œé¢ä¼˜åŒ–åŠŸèƒ½å·²åŠ è½½å®Œæˆï¼');
        });
    </script>
</body>

</html>

</html>